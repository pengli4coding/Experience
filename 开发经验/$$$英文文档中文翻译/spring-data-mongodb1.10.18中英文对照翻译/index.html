
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<meta name="author" content="Mark Pollack, Thomas Risberg, Oliver Gierke, Costin Leau, Jon Brisbin, Thomas Darimont, Christoph Strobl, Mark Paluch, Jay Bryant">
<title>Spring Data MongoDB - Reference Documentation</title>
<link rel="stylesheet" href="./spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
</head>
<body class="book">
<div id="header">
<h1>Spring Data MongoDB - Reference Documentation</h1>
<div class="details">
<span id="author" class="author">Mark Pollack</span><br>
<span id="author2" class="author">Thomas Risberg</span><br>
<span id="author3" class="author">Oliver Gierke</span><br>
<span id="author4" class="author">Costin Leau</span><br>
<span id="author5" class="author">Jon Brisbin</span><br>
<span id="author6" class="author">Thomas Darimont</span><br>
<span id="author7" class="author">Christoph Strobl</span><br>
<span id="author8" class="author">Mark Paluch</span><br>
<span id="author9" class="author">Jay Bryant</span><br>
<span id="revnumber">version 1.10.18.RELEASE,</span>
<span id="revdate">2019-01-10</span>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>&#169; 2008-2019 The original authors.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically.
</td>
</tr>
</table>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#preface">Preface</a>
<ul class="sectlevel1">
<li><a href="#get-started:first-steps:spring">1. Learning Spring</a></li>
<li><a href="#get-started:first-steps:nosql">2. Learning NoSQL and Document databases</a></li>
<li><a href="#requirements">3. Requirements</a></li>
<li><a href="#get-started:help">4. Additional Help Resources</a></li>
<li><a href="#get-started:up-to-date">5. Following Development</a></li>
<li><a href="#new-features">6. New &amp; Noteworthy</a>
<ul class="sectlevel2">
<li><a href="#new-features.1-10-0">6.1. What&#8217;s New in Spring Data MongoDB 1.10</a></li>
<li><a href="#new-features.1-9-0">6.2. What&#8217;s New in Spring Data MongoDB 1.9</a></li>
<li><a href="#new-features.1-8-0">6.3. What&#8217;s New in Spring Data MongoDB 1.8</a></li>
<li><a href="#new-features.1-7-0">6.4. What&#8217;s New in Spring Data MongoDB 1.7</a></li>
</ul>
</li>
<li><a href="#dependencies">7. Dependencies</a>
<ul class="sectlevel2">
<li><a href="#dependencies.spring-boot">7.1. Dependency Management with Spring Boot</a></li>
<li><a href="#dependencies.spring-framework">7.2. Spring Framework</a></li>
</ul>
</li>
<li><a href="#repositories">8. Working with Spring Data Repositories</a>
<ul class="sectlevel2">
<li><a href="#repositories.core-concepts">8.1. Core concepts</a></li>
<li><a href="#repositories.query-methods">8.2. Query methods</a></li>
<li><a href="#repositories.definition">8.3. Defining Repository Interfaces</a>
<ul class="sectlevel3">
<li><a href="#repositories.definition-tuning">8.3.1. Fine-tuning Repository Definition</a></li>
<li><a href="#repositories.multiple-modules">8.3.2. Using Repositories with Multiple Spring Data Modules</a></li>
</ul>
</li>
<li><a href="#repositories.query-methods.details">8.4. Defining Query Methods</a>
<ul class="sectlevel3">
<li><a href="#repositories.query-methods.query-lookup-strategies">8.4.1. Query Lookup Strategies</a></li>
<li><a href="#repositories.query-methods.query-creation">8.4.2. Query Creation</a></li>
<li><a href="#repositories.query-methods.query-property-expressions">8.4.3. Property Expressions</a></li>
<li><a href="#repositories.special-parameters">8.4.4. Special parameter handling</a></li>
<li><a href="#repositories.limit-query-result">8.4.5. Limiting Query Results</a></li>
<li><a href="#repositories.query-streaming">8.4.6. Streaming query results</a></li>
<li><a href="#repositories.query-async">8.4.7. Async query results</a></li>
</ul>
</li>
<li><a href="#repositories.create-instances">8.5. Creating Repository Instances</a>
<ul class="sectlevel3">
<li><a href="#repositories.create-instances.spring">8.5.1. XML configuration</a></li>
<li><a href="#repositories.create-instances.java-config">8.5.2. JavaConfig</a></li>
<li><a href="#repositories.create-instances.standalone">8.5.3. Standalone usage</a></li>
</ul>
</li>
<li><a href="#repositories.custom-implementations">8.6. Custom implementations for Spring Data repositories</a>
<ul class="sectlevel3">
<li><a href="#repositories.single-repository-behaviour">8.6.1. Adding custom behavior to single repositories</a></li>
<li><a href="#repositories.custom-behaviour-for-all-repositories">8.6.2. Adding custom behavior to all repositories</a></li>
</ul>
</li>
<li><a href="#core.domain-events">8.7. Publishing Events from Aggregate Roots</a></li>
<li><a href="#core.extensions">8.8. Spring Data Extensions</a>
<ul class="sectlevel3">
<li><a href="#core.extensions.querydsl">8.8.1. Querydsl Extension</a></li>
<li><a href="#core.web">8.8.2. Web support</a></li>
<li><a href="#core.repository-populators">8.8.3. Repository Populators</a></li>
<li><a href="#web.legacy">8.8.4. Legacy web support</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#reference">Reference Documentation&nbsp;&nbsp;<font class="pl">参考文档</font></a>
<ul class="sectlevel1">
<li><a href="#introduction">9. Introduction&nbsp;&nbsp;<font class="pl">介绍</font></a>
<ul class="sectlevel2">
<li><a href="#_document_structure">9.1. Document Structure&nbsp;&nbsp;<font class="pl">文档结构</font></a></li>
</ul>
</li>
<li><a href="#mongo.core">10. MongoDB support</a>
<ul class="sectlevel2">
<li><a href="#mongodb-getting-started">10.1. Getting Started&nbsp;&nbsp;<font class="pl">开始</font></a></li>
<li><a href="#mongo.examples-repo">10.2. Examples Repository</a></li>
<li><a href="#mongodb-connectors">10.3. Connecting to MongoDB with Spring&nbsp;&nbsp;<font class="pl">通过Spring连接MongoDB</font></a>
<ul class="sectlevel3">
<li><a href="#mongo.mongo-java-config">10.3.1. Registering a Mongo Instance by using Java-based Metadata&nbsp;&nbsp;<font class="pl">使用基于Java的元数据注册Mongo实例</font></a></li>
<li><a href="#mongo.mongo-xml-config">10.3.2. Registering a Mongo Instance by Using XML-based Metadata&nbsp;&nbsp;<font class="pl">使用基于XML的元数据注册Mongo实例</font></a></li>
<li><a href="#mongo.mongo-db-factory">10.3.3. The MongoDbFactory Interface&nbsp;&nbsp;<font class="pl">MongoDbFactory接口</font></a></li>
<li><a href="#mongo.mongo-db-factory-java">10.3.4. Registering a <code>MongoDbFactory</code> Instance by Using Java-based Metadata&nbsp;&nbsp;<font class="pl">使用基于Java的元数据注册MongoDbFactory的实例</font></a></a></li>
<li><a href="#mongo.mongo-db-factory-xml">10.3.5. Registering a <code>MongoDbFactory</code> Instance by Using XML-based Metadata&nbsp;&nbsp;<font class="pl">使用基于XML的元数据注册MongoDbFactory的实例</font></a></li>
</ul>
</li>
<li><a href="#mongo-template">10.4. Introduction to <code>MongoTemplate</code>&nbsp;&nbsp;<font class="pl">MongoTemplate的介绍</font></a>
<ul class="sectlevel3">
<li><a href="#mongo-template.instantiating">10.4.1. Instantiating <code>MongoTemplate</code>&nbsp;&nbsp;<font class="pl">实例化MongoTemplate</font></a></li>
<li><a href="#mongo-template.writeresultchecking">10.4.2. <code>WriteResultChecking</code> Policy</a></li>
<li><a href="#mongo-template.writeconcern">10.4.3. <code>WriteConcern</code></a></li>
<li><a href="#mongo-template.writeconcernresolver">10.4.4. <code>WriteConcernResolver</code></a></li>
</ul>
</li>
<li><a href="#mongo-template.save-update-remove">10.5. Saving, Updating, and Removing Documents&nbsp;&nbsp;<font class="pl">保存、更新以及删除文档</font></a>
<ul class="sectlevel3">
<li><a href="#mongo-template.id-handling">10.5.1. How the <code>_id</code> Field is Handled in the Mapping Layer</a></li>
<li><a href="#mongo-template.type-mapping">10.5.2. Type Mapping</a></li>
<li><a href="#mongo-template.save-insert">10.5.3. Methods for Saving and Inserting Documents</a></li>
<li><a href="#mongodb-template-update">10.5.4. Updating Documents in a Collection</a></li>
<li><a href="#mongo-template.upserts">10.5.5. &#8220;Upserting&#8221; Documents in a Collection</a></li>
<li><a href="#mongo-template.find-and-upsert">10.5.6. Finding and Upserting Documents in a Collection</a></li>
<li><a href="#mongo-template.delete">10.5.7. Methods for Removing Documents</a></li>
<li><a href="#mongo-template.optimistic-locking">10.5.8. Optimistic Locking</a></li>
</ul>
</li>
<li><a href="#mongo.query">10.6. Querying Documents&nbsp;&nbsp;<font class="pl">查询文档</font></a>
<ul class="sectlevel3">
<li><a href="#mongodb-template-query">10.6.1. Querying Documents in a Collection</a></li>
<li><a href="#mongo-template.querying">10.6.2. Methods for Querying for Documents</a></li>
<li><a href="#mongo.geospatial">10.6.3. GeoSpatial Queries</a></li>
<li><a href="#mongo.geo-json">10.6.4. GeoJSON Support</a></li>
<li><a href="#mongo.textsearch">10.6.5. Full-text Queries</a></li>
</ul>
</li>
<li><a href="#query-by-example">10.7. Query by Example</a>
<ul class="sectlevel3">
<li><a href="#query-by-example.introduction">10.7.1. Introduction</a></li>
<li><a href="#query-by-example.usage">10.7.2. Usage</a></li>
<li><a href="#query-by-example.matchers">10.7.3. Example Matchers</a></li>
<li><a href="#query-by-example.execution">10.7.4. Running an Example</a></li>
</ul>
</li>
<li><a href="#mongo.mapreduce">10.8. Map-Reduce Operations</a>
<ul class="sectlevel3">
<li><a href="#mongo.mapreduce.example">10.8.1. Example Usage</a></li>
</ul>
</li>
<li><a href="#mongo.server-side-scripts">10.9. Script Operations</a></li>
<li><a href="#mongo.group">10.10. Group Operations</a>
<ul class="sectlevel3">
<li><a href="#mongo.group.example">10.10.1. Example Usage</a></li>
</ul>
</li>
<li><a href="#mongo.aggregation">10.11. Aggregation Framework Support</a>
<ul class="sectlevel3">
<li><a href="#mongo.aggregation.basic-concepts">10.11.1. Basic Concepts</a></li>
<li><a href="#mongo.aggregation.supported-aggregation-operations">10.11.2. Supported Aggregation Operations</a></li>
<li><a href="#mongo.aggregation.projection">10.11.3. Projection Expressions</a></li>
<li><a href="#mongo.aggregation.facet">10.11.4. Faceted Classification</a></li>
</ul>
</li>
<li><a href="#mongo.custom-converters">10.12. Overriding Default Mapping with Custom Converters</a>
<ul class="sectlevel3">
<li><a href="#mongo.custom-converters.writer">10.12.1. Saving by Using a Registered Spring Converter</a></li>
<li><a href="#mongo.custom-converters.reader">10.12.2. Reading by Using a Spring Converter</a></li>
<li><a href="#mongo.custom-converters.xml">10.12.3. Registering Spring Converters with the <code>MongoConverter</code></a></li>
<li><a href="#mongo.converter-disambiguation">10.12.4. Converter Disambiguation</a></li>
</ul>
</li>
<li><a href="#mongo-template.index-and-collections">10.13. Index and Collection Management</a>
<ul class="sectlevel3">
<li><a href="#mongo-template.index-and-collections.index">10.13.1. Methods for Creating an Index</a></li>
<li><a href="#mongo-template.index-and-collections.access">10.13.2. Accessing Index Information</a></li>
<li><a href="#mongo-template.index-and-collections.collection">10.13.3. Methods for Working with a Collection</a></li>
</ul>
</li>
<li><a href="#mongo-template.commands">10.14. Executing Commands</a>
<ul class="sectlevel3">
<li><a href="#mongo-template.commands.execution">10.14.1. Methods for executing commands</a></li>
</ul>
</li>
<li><a href="#mongodb.mapping-usage.events">10.15. Lifecycle Events</a></li>
<li><a href="#mongo.exception">10.16. Exception Translation</a></li>
<li><a href="#mongo.executioncallback">10.17. Execution Callbacks</a></li>
<li><a href="#gridfs">10.18. GridFS Support</a></li>
</ul>
</li>
<li><a href="#mongo.repositories">11. MongoDB Repositories</a>
<ul class="sectlevel2">
<li><a href="#mongo-repo-intro">11.1. Introduction</a></li>
<li><a href="#mongo-repo-usage">11.2. Usage</a></li>
<li><a href="#mongodb.repositories.queries">11.3. Query Methods</a>
<ul class="sectlevel3">
<li><a href="#mongodb.repositories.queries.delete">11.3.1. Repository Delete Queries</a></li>
<li><a href="#mongodb.repositories.queries.geo-spatial">11.3.2. Geo-spatial Repository Queries</a></li>
<li><a href="#mongodb.repositories.queries.json-based">11.3.3. MongoDB JSON-based Query Methods and Field Restriction</a></li>
<li><a href="#mongodb.repositories.queries.json-spel">11.3.4. JSON-based Queries with SpEL Expressions</a></li>
<li><a href="#mongodb.repositories.queries.type-safe">11.3.5. Type-safe Query Methods</a></li>
<li><a href="#mongodb.repositories.queries.full-text">11.3.6. Full-text Search Queries</a></li>
<li><a href="#projections">11.3.7. Projections</a></li>
</ul>
</li>
<li><a href="#mongodb.repositories.misc.cdi-integration">11.4. CDI Integration</a></li>
</ul>
</li>
<li><a href="#auditing">12. Auditing</a>
<ul class="sectlevel2">
<li><a href="#auditing.basics">12.1. Basics</a>
<ul class="sectlevel3">
<li><a href="#auditing.annotations">12.1.1. Annotation-based Auditing Metadata</a></li>
<li><a href="#auditing.interfaces">12.1.2. Interface-based Auditing Metadata</a></li>
<li><a href="#auditing.auditor-aware">12.1.3. <code>AuditorAware</code></a></li>
</ul>
</li>
<li><a href="#mongo.auditing">12.2. General Auditing Configuration for MongoDB</a></li>
</ul>
</li>
<li><a href="#mapping-chapter">13. Mapping</a>
<ul class="sectlevel2">
<li><a href="#mapping-conventions">13.1. Convention-based Mapping</a>
<ul class="sectlevel3">
<li><a href="#mapping.conventions.id-field">13.1.1. How the <code>_id</code> field is handled in the mapping layer.</a></li>
</ul>
</li>
<li><a href="#mapping-conversion">13.2. Data Mapping and Type Conversion</a></li>
<li><a href="#mapping-configuration">13.3. Mapping Configuration</a></li>
<li><a href="#mapping-usage">13.4. Metadata-based Mapping</a>
<ul class="sectlevel3">
<li><a href="#mapping-usage-annotations">13.4.1. Mapping Annotation Overview</a></li>
<li><a href="#mapping-custom-object-construction">13.4.2. Customized Object Construction</a></li>
<li><a href="#mapping-usage-indexes.compound-index">13.4.3. Compound Indexes</a></li>
<li><a href="#mapping-usage-indexes.text-index">13.4.4. Text Indexes</a></li>
<li><a href="#mapping-usage-references">13.4.5. Using DBRefs</a></li>
<li><a href="#mapping-usage-events">13.4.6. Mapping Framework Events</a></li>
<li><a href="#mapping-explicit-converters">13.4.7. Overriding Mapping with Explicit Converters</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mongo.cross.store">14. Cross Store Support</a>
<ul class="sectlevel2">
<li><a href="#mongodb_cross-store-configuration">14.1. Cross Store Configuration</a></li>
<li><a href="#mongodb_cross-store-application">14.2. Writing the Cross Store Application</a></li>
</ul>
</li>
<li><a href="#mongo.logging">15. Logging support</a>
<ul class="sectlevel2">
<li><a href="#mongodb:logging-configuration">15.1. MongoDB Log4j Configuration</a>
<ul class="sectlevel3">
<li><a href="#mongodb:logging-configuration:authentication">15.1.1. Using authentication</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mongo.jmx">16. JMX support</a>
<ul class="sectlevel2">
<li><a href="#mongodb:jmx-configuration">16.1. MongoDB JMX Configuration</a></li>
</ul>
</li>
<li><a href="#mongo.mongo-3">17. MongoDB 3.0 Support</a>
<ul class="sectlevel2">
<li><a href="#_using_spring_data_mongodb_with_mongodb_3_0">17.1. Using Spring Data MongoDB with MongoDB 3.0</a>
<ul class="sectlevel3">
<li><a href="#mongo.mongo-3.configuration">17.1.1. Configuration Options</a></li>
<li><a href="#mongo.mongo-3.write-concern">17.1.2. <code>WriteConcern</code> and <code>WriteConcernChecking</code></a></li>
<li><a href="#mongo.mongo-3.authentication">17.1.3. Authentication</a></li>
<li><a href="#mongo.mongo-3.misc">17.1.4. Miscellaneous Details</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#appendix">Appendix</a>
<ul class="sectlevel1">
<li><a href="#repositories.namespace-reference">Appendix A: Namespace reference</a>
<ul class="sectlevel2">
<li><a href="#populator.namespace-dao-config">The <code>&lt;repositories /&gt;</code> Element</a></li>
</ul>
</li>
<li><a href="#populator.namespace-reference">Appendix B: Populators namespace reference</a>
<ul class="sectlevel2">
<li><a href="#namespace-dao-config">The &lt;populator /&gt; element</a></li>
</ul>
</li>
<li><a href="#repository-query-keywords">Appendix C: Repository query keywords</a>
<ul class="sectlevel2">
<li><a href="#_supported_query_keywords">Supported query keywords</a></li>
</ul>
</li>
<li><a href="#repository-query-return-types">Appendix D: Repository query return types</a>
<ul class="sectlevel2">
<li><a href="#_supported_query_return_types">Supported Query Return Types</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<h1 id="preface" class="sect0"><a class="anchor" href="#preface"></a>Preface</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>The Spring Data MongoDB project applies core Spring concepts to the development of solutions that use the MongoDB document style data store. We provide a &#8220;template&#8221; as a high-level abstraction for storing and querying documents. You may notice similarities to the JDBC support provided by the Spring Framework.</p>
</div>
<div class="paragraph">
<p>This document is the reference guide for Spring Data - MongoDB Support. It explains MongoDB module concepts and semantics and syntax for various store namespaces.</p>
</div>
<div class="paragraph">
<p>This section provides some basic introduction to Spring and Document databases. The rest of the document refers only to Spring Data MongoDB features and assumes the user is familiar with MongoDB and Spring concepts.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-started:first-steps:spring"><a class="anchor" href="#get-started:first-steps:spring"></a>1. Learning Spring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Data uses Spring framework&#8217;s <a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/core.html">core</a> functionality, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/core.html#beans">IoC</a> container</p>
</li>
<li>
<p><a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/core.html#validation">type conversion system</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/core.html#expressions">expression language</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/integration.html#jmx">JMX integration</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/data-access.html#dao-exceptions">DAO exception hierarchy</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While you need not know the Spring APIs, understanding the concepts behind them is important. At a minimum, the idea behind Inversion of Control (IoC) should be familiar, and you should be familiar with whatever IoC container you choose to use.</p>
</div>
<div class="paragraph">
<p>The core functionality of the MongoDB support can be used directly, with no need to invoke the IoC services of the Spring Container. This is much like <code>JdbcTemplate</code>, which can be used "'standalone'" without any other services of the Spring container. To leverage all the features of Spring Data MongoDB, such as the repository support, you need to configure some parts of the library to use Spring.</p>
</div>
<div class="paragraph">
<p>To learn more about Spring, you can refer to the comprehensive documentation that explains the Spring Framework in detail. There are a lot of articles, blog entries, and books on the subject. See the Spring framework <a href="https://spring.io/docs">home page</a> for more information.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-started:first-steps:nosql"><a class="anchor" href="#get-started:first-steps:nosql"></a>2. Learning NoSQL and Document databases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>NoSQL stores have taken the storage world by storm. It is a vast domain with a plethora of solutions, terms, and patterns (to make things worse, even the term itself has multiple <a href="https://www.google.com/search?q=nosoql+acronym">meanings</a>). While some of the principles are common, you must be familiar with MongoDB to some degree. The best way to get acquainted is to read the documentation and follow the examples. It usually does not take more then 5-10 minutes to go through them and, especially if you are coming from an RDMBS-only background, these exercises can be an eye opener.</p>
</div>
<div class="paragraph">
<p>The starting point for learning about MongoDB is <a href="https://www.mongodb.org/">www.mongodb.org</a>. Here is a list of other useful resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="http://docs.mongodb.org/manual/">manual</a> introduces MongoDB and contains links to getting started guides, reference documentation, and tutorials.</p>
</li>
<li>
<p>The <a href="https://try.mongodb.org/">online shell</a> provides a convenient way to interact with a MongoDB instance in combination with the online <a href="http://docs.mongodb.org/manual/tutorial/getting-started/">tutorial.</a></p>
</li>
<li>
<p>MongoDB <a href="http://docs.mongodb.org/ecosystem/drivers/java/">Java Language Center</a>.</p>
</li>
<li>
<p>Several <a href="https://www.mongodb.org/books">books</a> you can purchase.</p>
</li>
<li>
<p>Karl Seguin&#8217;s online book: <a href="http://openmymind.net/mongodb.pdf">The Little MongoDB Book</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="requirements"><a class="anchor" href="#requirements"></a>3. Requirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Spring Data MongoDB 2.x binaries require JDK level 8.0 and above and <a href="https://spring.io/docs">Spring Framework</a> 4.3.22.RELEASE and above.</p>
</div>
<div class="paragraph">
<p>In terms of document stores, you need at least version 2.6 of <a href="https://www.mongodb.org/">MongoDB</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-started:help"><a class="anchor" href="#get-started:help"></a>4. Additional Help Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Learning a new framework is not always straightforward. In this section, we try to provide what we think is an easy-to-follow guide for starting with the Spring Data MongoDB module. However, if you encounter issues or you need advice, feel free to use one of the following links:</p>
</div>
<div id="get-started:help:community" class="dlist">
<dl>
<dt class="hdlist1">Community Forum </dt>
<dd>
<p>Spring Data on <a href="https://stackoverflow.com/questions/tagged/spring-data">Stack Overflow</a> is a tag for all Spring Data (not just Document) users to share information and help each other. Note that registration is needed only for posting.</p>
</dd>
</dl>
</div>
<div id="get-started:help:professional" class="dlist">
<dl>
<dt class="hdlist1">Professional Support </dt>
<dd>
<p>Professional, from-the-source support, with guaranteed response time, is available from <a href="https://pivotal.io/">Pivotal Sofware, Inc.</a>, the company behind Spring Data and Spring.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-started:up-to-date"><a class="anchor" href="#get-started:up-to-date"></a>5. Following Development</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For information on the Spring Data Mongo source code repository, nightly builds, and snapshot artifacts, see the Spring Data Mongo <a href="https://projects.spring.io/spring-data-mongodb/">homepage</a>. You can help make Spring Data best serve the needs of the Spring community by interacting with developers through the Community on <a href="https://stackoverflow.com/questions/tagged/spring-data">Stack Overflow</a>. To follow developer activity, look for the mailing list information on the Spring Data Mongo <a href="https://projects.spring.io/spring-data-mongodb/">homepage</a>. If you encounter a bug or want to suggest an improvement, please create a ticket on the Spring Data issue <a href="https://jira.spring.io/browse/DATAMONGO">tracker</a>. To stay up to date with the latest news and announcements in the Spring eco system, subscribe to the Spring Community <a href="https://spring.io">Portal</a>. You can also follow the Spring <a href="https://spring.io/blog">blog</a> or the project team on Twitter (<a href="https://twitter.com/SpringData">SpringData</a>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="new-features"><a class="anchor" href="#new-features"></a>6. New &amp; Noteworthy</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="new-features.1-10-0"><a class="anchor" href="#new-features.1-10-0"></a>6.1. What&#8217;s New in Spring Data MongoDB 1.10</h3>
<div class="ulist">
<ul>
<li>
<p>Compatible with MongoDB Server 3.4 and the MongoDB Java Driver 3.4.</p>
</li>
<li>
<p>New annotations for <code>@CountQuery</code>, <code>@DeleteQuery</code>, and <code>@ExistsQuery</code>.</p>
</li>
<li>
<p>Extended support for MongoDB 3.2 and MongoDB 3.4 aggregation operators (see <a href="#mongo.aggregation.supported-aggregation-operations">Supported Aggregation Operations</a>).</p>
</li>
<li>
<p>Support for partial filter expression when creating indexes.</p>
</li>
<li>
<p>Publishing lifecycle events when loading or converting <code>DBRef</code> instances.</p>
</li>
<li>
<p>Added any-match mode for Query By Example.</p>
</li>
<li>
<p>Support for <code>$caseSensitive</code> and <code>$diacriticSensitive</code> text search.</p>
</li>
<li>
<p>Support for GeoJSON Polygon with hole.</p>
</li>
<li>
<p>Performance improvements by bulk-fetching <code>DBRef</code> instances.</p>
</li>
<li>
<p>Multi-faceted aggregations using <code>$facet</code>, <code>$bucket</code>, and <code>$bucketAuto</code> with <code>Aggregation</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="new-features.1-9-0"><a class="anchor" href="#new-features.1-9-0"></a>6.2. What&#8217;s New in Spring Data MongoDB 1.9</h3>
<div class="ulist">
<ul>
<li>
<p>The following annotations have been enabled to build your own composed annotations: <code>@Document</code>, <code>@Id</code>, <code>@Field</code>, <code>@Indexed</code>, <code>@CompoundIndex</code>, <code>@GeoSpatialIndexed</code>, <code>@TextIndexed</code>, <code>@Query</code>, and <code>@Meta</code>.</p>
</li>
<li>
<p>Support for <a href="#projections">Projections</a> in repository query methods.</p>
</li>
<li>
<p>Support for <a href="#query-by-example">Query by Example</a>.</p>
</li>
<li>
<p>Out-of-the-box support for <code>java.util.Currency</code> in object mapping.</p>
</li>
<li>
<p>Support for the bulk operations introduced in MongoDB 2.6.</p>
</li>
<li>
<p>Upgrade to Querydsl 4.</p>
</li>
<li>
<p>Assert compatibility with MongoDB 3.0 and MongoDB Java Driver 3.2 (see: <a href="#mongo.mongo-3">MongoDB 3.0 Support</a>).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="new-features.1-8-0"><a class="anchor" href="#new-features.1-8-0"></a>6.3. What&#8217;s New in Spring Data MongoDB 1.8</h3>
<div class="ulist">
<ul>
<li>
<p><code>Criteria</code> offers support for creating <code>$geoIntersects</code>.</p>
</li>
<li>
<p>Support for <a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/html/expressions.html">SpEL expressions</a> in <code>@Query</code>.</p>
</li>
<li>
<p><code>MongoMappingEvents</code> expose the collection name for which they are issued.</p>
</li>
<li>
<p>Improved support for <code>&lt;mongo:mongo-client credentials="&#8230;&#8203;" /&gt;</code>.</p>
</li>
<li>
<p>Improved index creation failure error message.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="new-features.1-7-0"><a class="anchor" href="#new-features.1-7-0"></a>6.4. What&#8217;s New in Spring Data MongoDB 1.7</h3>
<div class="ulist">
<ul>
<li>
<p>Assert compatibility with MongoDB 3.0 and MongoDB Java Driver 3-beta3 (see: <a href="#mongo.mongo-3">MongoDB 3.0 Support</a>).</p>
</li>
<li>
<p>Support JSR-310 and ThreeTen back-port date/time types.</p>
</li>
<li>
<p>Allow <code>Stream</code> as a query method return type (see: <a href="#mongodb.repositories.queries">Query Methods</a>).</p>
</li>
<li>
<p><a href="http://geojson.org/">GeoJSON</a> support in both domain types and queries (see: <a href="#mongo.geo-json">GeoJSON Support</a>).</p>
</li>
<li>
<p><code>QueryDslPredicateExcecutor</code> now supports <code>findAll(OrderSpecifier&lt;?&gt;… orders)</code>.</p>
</li>
<li>
<p>Support calling JavaScript functions with <a href="#mongo.server-side-scripts">Script Operations</a>.</p>
</li>
<li>
<p>Improve support for <code>CONTAINS</code> keyword on collection-like properties.</p>
</li>
<li>
<p>Support for <code>$bit</code>, <code>$mul</code>, and <code>$position</code> operators to <code>Update</code>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dependencies"><a class="anchor" href="#dependencies"></a>7. Dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Due to the different inception dates of individual Spring Data modules, most of them carry different major and minor version numbers. The easiest way to find compatible ones is to rely on the Spring Data Release Train BOM that we ship with the compatible versions defined. In a Maven project, you would declare this dependency in the <code>&lt;dependencyManagement /&gt;</code> section of your POM, as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Using the Spring Data release train BOM</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
      &lt;artifactId&gt;spring-data-releasetrain&lt;/artifactId&gt;
      &lt;version&gt;Ingalls-SR18&lt;/version&gt;
      &lt;scope&gt;import&lt;/scope&gt;
      &lt;type&gt;pom&lt;/type&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
</div>
</div>
<div id="dependencies.train-names" class="paragraph">
<p>The current release train version is <code>Ingalls-SR18</code>. The train names ascend alphabetically and the currently available trains are listed <a href="https://github.com/spring-projects/spring-data-commons/wiki/Release-planning">here</a>. The version name follows the following pattern: <code>${name}-${release}</code>, where release can be one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BUILD-SNAPSHOT</code>: Current snapshots</p>
</li>
<li>
<p><code>M1</code>, <code>M2</code>, and so on: Milestones</p>
</li>
<li>
<p><code>RC1</code>, <code>RC2</code>, and so on: Release candidates</p>
</li>
<li>
<p><code>RELEASE</code>: GA release</p>
</li>
<li>
<p><code>SR1</code>, <code>SR2</code>, and so on: Service releases</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A working example of using the BOMs can be found in our <a href="https://github.com/spring-projects/spring-data-examples/tree/master/bom">Spring Data examples repository</a>. With that in place, you can declare the Spring Data modules you would like to use without a version in the <code>&lt;dependencies /&gt;</code> block, as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Declaring a dependency to a Spring Data module</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
    &lt;artifactId&gt;spring-data-jpa&lt;/artifactId&gt;
  &lt;/dependency&gt;
&lt;dependencies&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dependencies.spring-boot"><a class="anchor" href="#dependencies.spring-boot"></a>7.1. Dependency Management with Spring Boot</h3>
<div class="paragraph">
<p>Spring Boot selects a recent version of Spring Data modules for you. If you still want to upgrade to a newer version, configure the property <code>spring-data-releasetrain.version</code> to the <a href="#dependencies.train-names">train name and iteration</a> you would like to use.</p>
</div>
</div>
<div class="sect2">
<h3 id="dependencies.spring-framework"><a class="anchor" href="#dependencies.spring-framework"></a>7.2. Spring Framework</h3>
<div class="paragraph">
<p>The current version of Spring Data modules require Spring Framework in version 4.3.22.RELEASE or better. The modules might also work with an older bugfix version of that minor version. However, using the most recent version within that generation is highly recommended.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="repositories"><a class="anchor" href="#repositories"></a>8. Working with Spring Data Repositories</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal of the Spring Data repository abstraction is to significantly reduce the amount of boilerplate code required to implement data access layers for various persistence stores.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>Spring Data repository documentation and your module</em></p>
</div>
<div class="paragraph">
<p>This chapter explains the core concepts and interfaces of Spring Data repositories. The information in this chapter is pulled from the Spring Data Commons module. It uses the configuration and code samples for the Java Persistence API (JPA) module. You should adapt the XML namespace declaration and the types to be extended to the equivalents of the particular module that you use. &#8220;<a href="#repositories.namespace-reference">Namespace reference</a>&#8221; covers XML configuration, which is supported across all Spring Data modules supporting the repository API. &#8220;<a href="#repository-query-keywords">Repository query keywords</a>&#8221; covers the query method keywords supported by the repository abstraction in general. For detailed information on the specific features of your module, see the chapter on that module of this document.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="repositories.core-concepts"><a class="anchor" href="#repositories.core-concepts"></a>8.1. Core concepts</h3>
<div class="paragraph">
<p>The central interface in the Spring Data repository abstraction is <code>Repository</code>. It takes the domain class to manage as well as the ID type of the domain class as type arguments. This interface acts primarily as a marker interface to capture the types to work with and to help you to discover interfaces that extend this one. The <code>CrudRepository</code> provides sophisticated CRUD functionality for the entity class that is being managed.</p>
</div>
<div id="repositories.repository" class="exampleblock">
<div class="title">Example 3. <code>CrudRepository</code> interface</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface CrudRepository&lt;T, ID extends Serializable&gt;
    extends Repository&lt;T, ID&gt; {

    &lt;S extends T&gt; S save(S entity); <i class="conum" data-value="1"></i><b>(1)</b>

    T findOne(ID primaryKey);       <i class="conum" data-value="2"></i><b>(2)</b>

    Iterable&lt;T&gt; findAll();          <i class="conum" data-value="3"></i><b>(3)</b>

    Long count();                   <i class="conum" data-value="4"></i><b>(4)</b>

    void delete(T entity);          <i class="conum" data-value="5"></i><b>(5)</b>

    boolean exists(ID primaryKey);  <i class="conum" data-value="6"></i><b>(6)</b>

    // … more functionality omitted.
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Saves the given entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Returns the entity identified by the given ID.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Returns all entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Returns the number of entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Deletes the given entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Indicates whether an entity with the given ID exists.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We also provide persistence technology-specific abstractions, such as <code>JpaRepository</code> or <code>MongoRepository</code>. Those interfaces extend <code>CrudRepository</code> and expose the capabilities of the underlying persistence technology in addition to the rather generic persistence technology-agnostic interfaces such as <code>CrudRepository</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On top of the <code>CrudRepository</code>, there is a <code>PagingAndSortingRepository</code> abstraction that adds additional methods to ease paginated access to entities:</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. <code>PagingAndSortingRepository</code> interface</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface PagingAndSortingRepository&lt;T, ID extends Serializable&gt;
  extends CrudRepository&lt;T, ID&gt; {

  Iterable&lt;T&gt; findAll(Sort sort);

  Page&lt;T&gt; findAll(Pageable pageable);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To access the second page of <code>User</code> by a page size of 20, you could do something like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">PagingAndSortingRepository&lt;User, Long&gt; repository = // … get access to a bean
Page&lt;User&gt; users = repository.findAll(new PageRequest(1, 20));</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to query methods, query derivation for both count and delete queries is available. The following list shows the interface definition for a derived count query:</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. Derived Count Query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface UserRepository extends CrudRepository&lt;User, Long&gt; {

  Long countByLastname(String lastname);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following list shows the interface definition for a derived delete query:</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. Derived Delete Query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface UserRepository extends CrudRepository&lt;User, Long&gt; {

  Long deleteByLastname(String lastname);

  List&lt;User&gt; removeByLastname(String lastname);

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories.query-methods"><a class="anchor" href="#repositories.query-methods"></a>8.2. Query methods</h3>
<div class="paragraph">
<p>Standard CRUD functionality repositories usually have queries on the underlying datastore. With Spring Data, declaring those queries becomes a four-step process:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Declare an interface extending Repository or one of its subinterfaces and type it to the domain class and ID type that it should handle, as shown in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface PersonRepository extends Repository&lt;Person, Long&gt; { … }</code></pre>
</div>
</div>
</li>
<li>
<p>Declare query methods on the interface.</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface PersonRepository extends Repository&lt;Person, Long&gt; {
  List&lt;Person&gt; findByLastname(String lastname);
}</code></pre>
</div>
</div>
</li>
<li>
<p>Set up Spring to create proxy instances for those interfaces, either with <a href="#repositories.create-instances.java-config">JavaConfig</a> or with <a href="#repositories.create-instances">XML configuration</a>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>To use Java configuration, create a class similar to the following:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import org.springframework.data.jpa.repository.config.EnableJpaRepositories;

@EnableJpaRepositories
class Config {}</code></pre>
</div>
</div>
</li>
<li>
<p>To use XML configuration, define a bean similar to the following:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xmlns:jpa="http://www.springframework.org/schema/data/jpa"
   xsi:schemaLocation="http://www.springframework.org/schema/beans
     http://www.springframework.org/schema/beans/spring-beans.xsd
     http://www.springframework.org/schema/data/jpa
     http://www.springframework.org/schema/data/jpa/spring-jpa.xsd"&gt;

   &lt;jpa:repositories base-package="com.acme.repositories"/&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The JPA namespace is used in this example. If you use the repository abstraction for any other store, you need to change this to the appropriate namespace declaration of your store module. In other words, you should exchange <code>jpa</code> in favor of, for example, <code>mongodb</code>.</p>
</div>
<div class="paragraph">
<p>+
Also, note that the JavaConfig variant does not configure a package explicitly, because the package of the annotated class is used by default. To customize the package to scan, use one of the <code>basePackage…</code> attributes of the data-store-specific repository&#8217;s <code>@Enable${store}Repositories</code>-annotation.</p>
</div>
</li>
<li>
<p>Inject the repository instance and use it, as shown in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class SomeClient {

  @Autowired
  private PersonRepository repository;

  public void doSomething() {
    List&lt;Person&gt; persons = repository.findByLastname("Matthews");
  }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The sections that follow explain each step in detail:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#repositories.definition">Defining Repository Interfaces</a></p>
</li>
<li>
<p><a href="#repositories.query-methods.details">Defining Query Methods</a></p>
</li>
<li>
<p><a href="#repositories.create-instances">Creating Repository Instances</a></p>
</li>
<li>
<p><a href="#repositories.custom-implementations">Custom implementations for Spring Data repositories</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="repositories.definition"><a class="anchor" href="#repositories.definition"></a>8.3. Defining Repository Interfaces</h3>
<div class="paragraph">
<p>First, define a domain class-specific repository interface. The interface must extend <code>Repository</code> and be typed to the domain class and an ID type. If you want to expose CRUD methods for that domain type, extend <code>CrudRepository</code> instead of <code>Repository</code>.</p>
</div>
<div class="sect3">
<h4 id="repositories.definition-tuning"><a class="anchor" href="#repositories.definition-tuning"></a>8.3.1. Fine-tuning Repository Definition</h4>
<div class="paragraph">
<p>Typically, your repository interface extends <code>Repository</code>, <code>CrudRepository</code>, or <code>PagingAndSortingRepository</code>. Alternatively, if you do not want to extend Spring Data interfaces, you can also annotate your repository interface with <code>@RepositoryDefinition</code>. Extending <code>CrudRepository</code> exposes a complete set of methods to manipulate your entities. If you prefer to be selective about the methods being exposed, copy the methods you want to expose from <code>CrudRepository</code> into your domain repository.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Doing so lets you define your own abstractions on top of the provided Spring Data Repositories functionality.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following example shows how to selectively expose CRUD methods (<code>findById</code> and <code>save</code>, in this case):</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. Selectively exposing CRUD methods</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@NoRepositoryBean
interface MyBaseRepository&lt;T, ID extends Serializable&gt; extends Repository&lt;T, ID&gt; {

  T findOne(ID id);

  T save(T entity);
}

interface UserRepository extends MyBaseRepository&lt;User, Long&gt; {
  User findByEmailAddress(EmailAddress emailAddress);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the prior example, you defined a common base interface for all your domain repositories and exposed <code>findOne(…)</code> as well as <code>save(…)</code>.These methods are routed into the base repository implementation of the store of your choice provided by Spring Data (for example, if you use JPA, the implementation is <code>SimpleJpaRepository</code>), because they match the method signatures in <code>CrudRepository</code>. So the <code>UserRepository</code> can now save users, find individual users by ID, and trigger a query to find <code>Users</code> by email address.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The intermediate repository interface is annotated with <code>@NoRepositoryBean</code>. Make sure you add that annotation to all repository interfaces for which Spring Data should not create instances at runtime.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="repositories.multiple-modules"><a class="anchor" href="#repositories.multiple-modules"></a>8.3.2. Using Repositories with Multiple Spring Data Modules</h4>
<div class="paragraph">
<p>Using a unique Spring Data module in your application makes things simple, because all repository interfaces in the defined scope are bound to the Spring Data module. Sometimes, applications require using more than one Spring Data module. In such cases, a repository definition must distinguish between persistence technologies. When it detects multiple repository factories on the class path, Spring Data enters strict repository configuration mode. Strict configuration uses details on the repository or the domain class to decide about Spring Data module binding for a repository definition:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the repository definition <a href="#repositories.multiple-modules.types">extends the module-specific repository</a>, then it is a valid candidate for the particular Spring Data module.</p>
</li>
<li>
<p>If the domain class is <a href="#repositories.multiple-modules.annotations">annotated with the module-specific type annotation</a>, then it is a valid candidate for the particular Spring Data module. Spring Data modules accept either third-party annotations (such as JPA&#8217;s <code>@Entity</code>) or provide their own annotations (such as <code>@Document</code> for Spring Data MongoDB and Spring Data Elasticsearch).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following example shows a repository that uses module-specific interfaces (JPA in this case):</p>
</div>
<div id="repositories.multiple-modules.types" class="exampleblock">
<div class="title">Example 8. Repository definitions using module-specific interfaces</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface MyRepository extends JpaRepository&lt;User, Long&gt; { }

@NoRepositoryBean
interface MyBaseRepository&lt;T, ID extends Serializable&gt; extends JpaRepository&lt;T, ID&gt; {
  …
}

interface UserRepository extends MyBaseRepository&lt;User, Long&gt; {
  …
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>MyRepository</code> and <code>UserRepository</code> extend <code>JpaRepository</code> in their type hierarchy. They are valid candidates for the Spring Data JPA module.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows a repository that uses generic interfaces:</p>
</div>
<div class="exampleblock">
<div class="title">Example 9. Repository definitions using generic interfaces</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface AmbiguousRepository extends Repository&lt;User, Long&gt; {
 …
}

@NoRepositoryBean
interface MyBaseRepository&lt;T, ID extends Serializable&gt; extends CrudRepository&lt;T, ID&gt; {
  …
}

interface AmbiguousUserRepository extends MyBaseRepository&lt;User, Long&gt; {
  …
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>AmbiguousRepository</code> and <code>AmbiguousUserRepository</code> extend only <code>Repository</code> and <code>CrudRepository</code> in their type hierarchy. While this is perfectly fine when using a unique Spring Data module, multiple modules cannot distinguish to which particular Spring Data these repositories should be bound.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows a repository that uses domain classes with annotations:</p>
</div>
<div id="repositories.multiple-modules.annotations" class="exampleblock">
<div class="title">Example 10. Repository definitions using domain classes with annotations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface PersonRepository extends Repository&lt;Person, Long&gt; {
 …
}

@Entity
public class Person {
  …
}

interface UserRepository extends Repository&lt;User, Long&gt; {
 …
}

@Document
public class User {
  …
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>PersonRepository</code> references <code>Person</code>, which is annotated with the JPA <code>@Entity</code> annotation, so this repository clearly belongs to Spring Data JPA. <code>UserRepository</code> references <code>User</code>, which is annotated with Spring Data MongoDB&#8217;s <code>@Document</code> annotation.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The following bad example shows a repository that uses domain classes with mixed annotations:</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. Repository definitions using domain classes with mixed annotations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface JpaPersonRepository extends Repository&lt;Person, Long&gt; {
 …
}

interface MongoDBPersonRepository extends Repository&lt;Person, Long&gt; {
 …
}

@Entity
@Document
public class Person {
  …
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example shows a domain class using both JPA and Spring Data MongoDB annotations. It defines two repositories, <code>JpaPersonRepository</code> and <code>MongoDBPersonRepository</code>. One is intended for JPA and the other for MongoDB usage. Spring Data is no longer able to tell the repositories apart, which leads to undefined behavior.</p>
</div>
</div>
</div>
<div class="paragraph">
<p><a href="#repositories.multiple-modules.types">Repository type details</a> and <a href="#repositories.multiple-modules.annotations">distinguishing domain class annotations</a> are used for strict repository configuration to identify repository candidates for a particular Spring Data module. Using multiple persistence technology-specific annotations on the same domain type is possible and enables reuse of domain types across multiple persistence technologies. However, Spring Data can then no longer determine a unique module with which to bind the repository.</p>
</div>
<div class="paragraph">
<p>The last way to distinguish repositories is by scoping repository base packages. Base packages define the starting points for scanning for repository interface definitions, which implies having repository definitions located in the appropriate packages. By default, annotation-driven configuration uses the package of the configuration class. The <a href="#repositories.create-instances.spring">base package in XML-based configuration</a> is mandatory.</p>
</div>
<div class="paragraph">
<p>The following example shows annotation-driven configuration of base packages:</p>
</div>
<div class="exampleblock">
<div class="title">Example 12. Annotation-driven configuration of base packages</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@EnableJpaRepositories(basePackages = "com.acme.repositories.jpa")
@EnableMongoRepositories(basePackages = "com.acme.repositories.mongo")
interface Configuration { }</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories.query-methods.details"><a class="anchor" href="#repositories.query-methods.details"></a>8.4. Defining Query Methods</h3>
<div class="paragraph">
<p>The repository proxy has two ways to derive a store-specific query from the method name:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By deriving the query from the method name directly.</p>
</li>
<li>
<p>By using a manually defined query.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Available options depend on the actual store. However, there must be a strategy that decides what actual query is created. The next section describes the available options.</p>
</div>
<div class="sect3">
<h4 id="repositories.query-methods.query-lookup-strategies"><a class="anchor" href="#repositories.query-methods.query-lookup-strategies"></a>8.4.1. Query Lookup Strategies</h4>
<div class="paragraph">
<p>The following strategies are available for the repository infrastructure to resolve the query. With XML configuration, you can configure the strategy at the namespace through the <code>query-lookup-strategy</code> attribute. For Java configuration, you can use the <code>queryLookupStrategy</code> attribute of the <code>Enable${store}Repositories</code> annotation. Some strategies may not be supported for particular datastores.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CREATE</code> attempts to construct a store-specific query from the query method name. The general approach is to remove a given set of well known prefixes from the method name and parse the rest of the method. You can read more about query construction in &#8220;<a href="#repositories.query-methods.query-creation">Query Creation</a>&#8221;.</p>
</li>
<li>
<p><code>USE_DECLARED_QUERY</code> tries to find a declared query and throws an exception if cannot find one. The query can be defined by an annotation somewhere or declared by other means. Consult the documentation of the specific store to find available options for that store. If the repository infrastructure does not find a declared query for the method at bootstrap time, it fails.</p>
</li>
<li>
<p><code>CREATE_IF_NOT_FOUND</code> (default) combines <code>CREATE</code> and <code>USE_DECLARED_QUERY</code>. It looks up a declared query first, and, if no declared query is found, it creates a custom method name-based query. This is the default lookup strategy and, thus, is used if you do not configure anything explicitly. It allows quick query definition by method names but also custom-tuning of these queries by introducing declared queries as needed.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="repositories.query-methods.query-creation"><a class="anchor" href="#repositories.query-methods.query-creation"></a>8.4.2. Query Creation</h4>
<div class="paragraph">
<p>The query builder mechanism built into Spring Data repository infrastructure is useful for building constraining queries over entities of the repository. The mechanism strips the prefixes <code>find…By</code>, <code>read…By</code>, <code>query…By</code>, <code>count…By</code>, and <code>get…By</code> from the method and starts parsing the rest of it. The introducing clause can contain further expressions, such as a <code>Distinct</code> to set a distinct flag on the query to be created. However, the first <code>By</code> acts as delimiter to indicate the start of the actual criteria. At a very basic level, you can define conditions on entity properties and concatenate them with <code>And</code> and <code>Or</code>. The following example shows how to create a number of queries:</p>
</div>
<div class="exampleblock">
<div class="title">Example 13. Query creation from method names</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface PersonRepository extends Repository&lt;User, Long&gt; {

  List&lt;Person&gt; findByEmailAddressAndLastname(EmailAddress emailAddress, String lastname);

  // Enables the distinct flag for the query
  List&lt;Person&gt; findDistinctPeopleByLastnameOrFirstname(String lastname, String firstname);
  List&lt;Person&gt; findPeopleDistinctByLastnameOrFirstname(String lastname, String firstname);

  // Enabling ignoring case for an individual property
  List&lt;Person&gt; findByLastnameIgnoreCase(String lastname);
  // Enabling ignoring case for all suitable properties
  List&lt;Person&gt; findByLastnameAndFirstnameAllIgnoreCase(String lastname, String firstname);

  // Enabling static ORDER BY for a query
  List&lt;Person&gt; findByLastnameOrderByFirstnameAsc(String lastname);
  List&lt;Person&gt; findByLastnameOrderByFirstnameDesc(String lastname);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The actual result of parsing the method depends on the persistence store for which you create the query. However, there are some general things to notice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The expressions are usually property traversals combined with operators that can be concatenated. You can combine property expressions with <code>AND</code> and <code>OR</code>. You also get support for operators such as <code>Between</code>, <code>LessThan</code>, <code>GreaterThan</code>, and <code>Like</code> for the property expressions. The supported operators can vary by datastore, so consult the appropriate part of your reference documentation.</p>
</li>
<li>
<p>The method parser supports setting an <code>IgnoreCase</code> flag for individual properties (for example, <code>findByLastnameIgnoreCase(…)</code>) or for all properties of a type that supports ignoring case (usually <code>String</code> instances&#8201;&#8212;&#8201;for example, <code>findByLastnameAndFirstnameAllIgnoreCase(…)</code>). Whether ignoring cases is supported may vary by store, so consult the relevant sections in the reference documentation for the store-specific query method.</p>
</li>
<li>
<p>You can apply static ordering by appending an <code>OrderBy</code> clause to the query method that references a property and by providing a sorting direction (<code>Asc</code> or <code>Desc</code>). To create a query method that supports dynamic sorting, see &#8220;<a href="#repositories.special-parameters">Special parameter handling</a>&#8221;.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="repositories.query-methods.query-property-expressions"><a class="anchor" href="#repositories.query-methods.query-property-expressions"></a>8.4.3. Property Expressions</h4>
<div class="paragraph">
<p>Property expressions can refer only to a direct property of the managed entity, as shown in the preceding example. At query creation time, you already make sure that the parsed property is a property of the managed domain class. However, you can also define constraints by traversing nested properties. Consider the following method signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">List&lt;Person&gt; findByAddressZipCode(ZipCode zipCode);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assume a <code>Person</code> has an <code>Address</code> with a <code>ZipCode</code>. In that case, the method creates the property traversal <code>x.address.zipCode</code>. The resolution algorithm starts by interpreting the entire part (<code>AddressZipCode</code>) as the property and checks the domain class for a property with that name (uncapitalized). If the algorithm succeeds, it uses that property. If not, the algorithm splits up the source at the camel case parts from the right side into a head and a tail and tries to find the corresponding property&#8201;&#8212;&#8201;in our example, <code>AddressZip</code> and <code>Code</code>. If the algorithm finds a property with that head, it takes the tail and continues building the tree down from there, splitting the tail up in the way just described. If the first split does not match, the algorithm moves the split point to the left (<code>Address</code>, <code>ZipCode</code>) and continues.</p>
</div>
<div class="paragraph">
<p>Although this should work for most cases, it is possible for the algorithm to select the wrong property. Suppose the <code>Person</code> class has an <code>addressZip</code> property as well. The algorithm would match in the first split round already, choose the wrong property, and fail (as the type of <code>addressZip</code> probably has no <code>code</code> property).</p>
</div>
<div class="paragraph">
<p>To resolve this ambiguity you can use <code>_</code> inside your method name to manually define traversal points. So our method name would be as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">List&lt;Person&gt; findByAddress_ZipCode(ZipCode zipCode);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because we treat the underscore character as a reserved character, we strongly advise following standard Java naming conventions (that is, not using underscores in property names but using camel case instead).</p>
</div>
</div>
<div class="sect3">
<h4 id="repositories.special-parameters"><a class="anchor" href="#repositories.special-parameters"></a>8.4.4. Special parameter handling</h4>
<div class="paragraph">
<p>To handle parameters in your query, define method parameters as already seen in the preceding examples. Besides that, the infrastructure recognizes certain specific types like <code>Pageable</code> and <code>Sort</code>, to apply pagination and sorting to your queries dynamically. The following example demonstrates these features:</p>
</div>
<div class="exampleblock">
<div class="title">Example 14. Using <code>Pageable</code>, <code>Slice</code>, and <code>Sort</code> in query methods</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Page&lt;User&gt; findByLastname(String lastname, Pageable pageable);

Slice&lt;User&gt; findByLastname(String lastname, Pageable pageable);

List&lt;User&gt; findByLastname(String lastname, Sort sort);

List&lt;User&gt; findByLastname(String lastname, Pageable pageable);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The first method lets you pass an <code>org.springframework.data.domain.Pageable</code> instance to the query method to dynamically add paging to your statically defined query. A <code>Page</code> knows about the total number of elements and pages available. It does so by the infrastructure triggering a count query to calculate the overall number. As this might be expensive (depending on the store used), you can instead return a <code>Slice</code>. A <code>Slice</code> only knows about whether a next <code>Slice</code> is available, which might be sufficient when walking through a larger result set.</p>
</div>
<div class="paragraph">
<p>Sorting options are handled through the <code>Pageable</code> instance, too. If you only need sorting, add an <code>org.springframework.data.domain.Sort</code> parameter to your method. As you can see, returning a <code>List</code> is also possible. In this case, the additional metadata required to build the actual <code>Page</code> instance is not created (which, in turn, means that the additional count query that would have been necessary is not issued). Rather, it restricts the query to look up only the given range of entities.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To find out how many pages you get for an entire query, you have to trigger an additional count query. By default, this query is derived from the query you actually trigger.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="repositories.limit-query-result"><a class="anchor" href="#repositories.limit-query-result"></a>8.4.5. Limiting Query Results</h4>
<div class="paragraph">
<p>The results of query methods can be limited by using the <code>first</code> or <code>top</code> keywords, which can be used interchangeably. An optional numeric value can be appended to <code>top</code> or <code>first</code> to specify the maximum result size to be returned.
If the number is left out, a result size of 1 is assumed. The following example shows how to limit the query size:</p>
</div>
<div class="exampleblock">
<div class="title">Example 15. Limiting the result size of a query with <code>Top</code> and <code>First</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">User findFirstByOrderByLastnameAsc();

User findTopByOrderByAgeDesc();

Page&lt;User&gt; queryFirst10ByLastname(String lastname, Pageable pageable);

Slice&lt;User&gt; findTop3ByLastname(String lastname, Pageable pageable);

List&lt;User&gt; findFirst10ByLastname(String lastname, Sort sort);

List&lt;User&gt; findTop10ByLastname(String lastname, Pageable pageable);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The limiting expressions also support the <code>Distinct</code> keyword. Also, for the queries limiting the result set to one instance, wrapping the result into with the <code>Optional</code> keyword is supported.</p>
</div>
<div class="paragraph">
<p>If pagination or slicing is applied to a limiting query pagination (and the calculation of the number of pages available), it is applied within the limited result.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Limiting the results in combination with dynamic sorting by using a <code>Sort</code> parameter lets you express query methods for the 'K' smallest as well as for the 'K' biggest elements.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="repositories.query-streaming"><a class="anchor" href="#repositories.query-streaming"></a>8.4.6. Streaming query results</h4>
<div class="paragraph">
<p>The results of query methods can be processed incrementally by using a Java 8 <code>Stream&lt;T&gt;</code> as return type. Instead of wrapping the query results in a <code>Stream</code> data store-specific methods are used to perform the streaming, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 16. Stream the result of a query with Java 8 <code>Stream&lt;T&gt;</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Query("select u from User u")
Stream&lt;User&gt; findAllByCustomQueryAndStream();

Stream&lt;User&gt; readAllByFirstnameNotNull();

@Query("select u from User u")
Stream&lt;User&gt; streamAllPaged(Pageable pageable);</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A <code>Stream</code> potentially wraps underlying data store-specific resources and must, therefore, be closed after usage. You can either manually close the <code>Stream</code> by using the <code>close()</code> method or by using a Java 7 <code>try-with-resources</code> block, as shown in the following example:
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 17. Working with a <code>Stream&lt;T&gt;</code> result in a try-with-resources block</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">try (Stream&lt;User&gt; stream = repository.findAllByCustomQueryAndStream()) {
  stream.forEach(…);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Not all Spring Data modules currently support <code>Stream&lt;T&gt;</code> as a return type.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="repositories.query-async"><a class="anchor" href="#repositories.query-async"></a>8.4.7. Async query results</h4>
<div class="paragraph">
<p>Repository queries can be run asynchronously by using <a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/html#scheduling">Spring&#8217;s asynchronous method execution capability</a>. This means the method returns immediately upon invocation while the actual query execution occurs in a task that has been submitted to a Spring <code>TaskExecutor</code>. Asynchronous query execution is different from reactive query execution and should not be mixed. Refer to store-specific documentation for more details on reactive support. The following example shows a number of asynchronous queries:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Async
Future&lt;User&gt; findByFirstname(String firstname);               <i class="conum" data-value="1"></i><b>(1)</b>

@Async
CompletableFuture&lt;User&gt; findOneByFirstname(String firstname); <i class="conum" data-value="2"></i><b>(2)</b>

@Async
ListenableFuture&lt;User&gt; findOneByLastname(String lastname);    <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>java.util.concurrent.Future</code> as the return type.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use a Java 8 <code>java.util.concurrent.CompletableFuture</code> as the return type.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use a <code>org.springframework.util.concurrent.ListenableFuture</code> as the return type.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories.create-instances"><a class="anchor" href="#repositories.create-instances"></a>8.5. Creating Repository Instances</h3>
<div class="paragraph">
<p>In this section, you create instances and bean definitions for the defined repository interfaces. One way to do so is by using the Spring namespace that is shipped with each Spring Data module that supports the repository mechanism, although we generally recommend using Java configuration.</p>
</div>
<div class="sect3">
<h4 id="repositories.create-instances.spring"><a class="anchor" href="#repositories.create-instances.spring"></a>8.5.1. XML configuration</h4>
<div class="paragraph">
<p>Each Spring Data module includes a <code>repositories</code> element that lets you define a base package that Spring scans for you, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 18. Enabling Spring Data repositories via XML</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans:beans xmlns:beans="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="http://www.springframework.org/schema/data/jpa"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/data/jpa
    http://www.springframework.org/schema/data/jpa/spring-jpa.xsd"&gt;

  &lt;repositories base-package="com.acme.repositories" /&gt;

&lt;/beans:beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, Spring is instructed to scan <code>com.acme.repositories</code> and all its sub-packages for interfaces extending <code>Repository</code> or one of its sub-interfaces. For each interface found, the infrastructure registers the persistence technology-specific <code>FactoryBean</code> to create the appropriate proxies that handle invocations of the query methods. Each bean is registered under a bean name that is derived from the interface name, so an interface of <code>UserRepository</code> would be registered under <code>userRepository</code>. The <code>base-package</code> attribute allows wildcards so that you can define a pattern of scanned packages.</p>
</div>
<div class="sect4">
<h5 id="_using_filters"><a class="anchor" href="#_using_filters"></a>Using filters</h5>
<div class="paragraph">
<p>By default, the infrastructure picks up every interface extending the persistence technology-specific <code>Repository</code> sub-interface located under the configured base package and creates a bean instance for it. However, you might want more fine-grained control over which interfaces have bean instances created for them. To do so, use <code>&lt;include-filter /&gt;</code> and <code>&lt;exclude-filter /&gt;</code> elements inside the <code>&lt;repositories /&gt;</code> element. The semantics are exactly equivalent to the elements in Spring&#8217;s context namespace. For details, see the <a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/html/beans.html#beans-scanning-filters">Spring reference documentation</a> for these elements.</p>
</div>
<div class="paragraph">
<p>For example, to exclude certain interfaces from instantiation as repository beans, you could use the following configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 19. Using exclude-filter element</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;repositories base-package="com.acme.repositories"&gt;
  &lt;context:exclude-filter type="regex" expression=".*SomeRepository" /&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding example excludes all interfaces ending in <code>SomeRepository</code> from being instantiated.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories.create-instances.java-config"><a class="anchor" href="#repositories.create-instances.java-config"></a>8.5.2. JavaConfig</h4>
<div class="paragraph">
<p>The repository infrastructure can also be triggered by using a store-specific <code>@Enable${store}Repositories</code> annotation on a JavaConfig class. For an introduction into Java-based configuration of the Spring container, see <a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/html/beans.html#beans-java">JavaConfig in the Spring reference documentation</a>.</p>
</div>
<div class="paragraph">
<p>A sample configuration to enable Spring Data repositories resembles the following:</p>
</div>
<div class="exampleblock">
<div class="title">Example 20. Sample annotation based repository configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@EnableJpaRepositories("com.acme.repositories")
class ApplicationConfiguration {

  @Bean
  public EntityManagerFactory entityManagerFactory() {
    // …
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The preceding example uses the JPA-specific annotation, which you would change according to the store module you actually use. The same applies to the definition of the <code>EntityManagerFactory</code> bean. See the sections covering the store-specific configuration.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="repositories.create-instances.standalone"><a class="anchor" href="#repositories.create-instances.standalone"></a>8.5.3. Standalone usage</h4>
<div class="paragraph">
<p>You can also use the repository infrastructure outside of a Spring container&#8201;&#8212;&#8201;for example, in CDI environments. You still need some Spring libraries in your classpath, but, generally, you can set up repositories programmatically as well. The Spring Data modules that provide repository support ship a persistence technology-specific <code>RepositoryFactory</code> that you can use as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 21. Standalone usage of repository factory</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">RepositoryFactorySupport factory = … // Instantiate factory here
UserRepository repository = factory.getRepository(UserRepository.class);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories.custom-implementations"><a class="anchor" href="#repositories.custom-implementations"></a>8.6. Custom implementations for Spring Data repositories</h3>
<div class="paragraph">
<p>Often it is necessary to provide a custom implementation for a few repository methods. Spring Data repositories easily allow you to provide custom repository code and integrate it with generic CRUD abstraction and query method functionality.</p>
</div>
<div class="sect3">
<h4 id="repositories.single-repository-behaviour"><a class="anchor" href="#repositories.single-repository-behaviour"></a>8.6.1. Adding custom behavior to single repositories</h4>
<div class="paragraph">
<p>To enrich a repository with custom functionality you first define an interface and an implementation for the custom functionality. Use the repository interface you provided to extend the custom interface.</p>
</div>
<div class="exampleblock">
<div class="title">Example 22. Interface for custom repository functionality</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface UserRepositoryCustom {
  public void someCustomMethod(User user);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then you can let your repository interface additionally extend from the fragment interface, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 23. Implementation of custom repository functionality</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class UserRepositoryImpl implements UserRepositoryCustom {

  public void someCustomMethod(User user) {
    // Your custom implementation
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The most important bit for the class to be found is the <code>Impl</code> postfix of the name on it compared to the core repository interface (see below).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation itself does not depend on Spring Data and can be a regular Spring bean. Consequently, you can use standard dependency injection behavior to inject references to other beans (such as a <code>JdbcTemplate</code>), take part in aspects, and so on.</p>
</div>
<div class="paragraph">
<p>You can let your repository interface extend the fragment interface, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 24. Changes to the your basic repository interface</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface UserRepository extends CrudRepository&lt;User, Long&gt;, UserRepositoryCustom {

  // Declare query methods here
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let your standard repository interface extend the custom one. Doing so combines the CRUD and custom functionality and makes it available to clients.</p>
</div>
<div class="sect4">
<h5 id="_configuration"><a class="anchor" href="#_configuration"></a>Configuration</h5>
<div class="paragraph">
<p>If you use namespace configuration, the repository infrastructure tries to autodetect custom implementations by scanning for classes below the package we found a repository in. These classes need to follow the naming convention of appending the namespace element&#8217;s attribute <code>repository-impl-postfix</code> to the found repository interface name. This postfix defaults to <code>Impl</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 25. Configuration example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;repositories base-package="com.acme.repository" /&gt;

&lt;repositories base-package="com.acme.repository" repository-impl-postfix="MyPostfix" /&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The first configuration example tries to look up a class <code>com.acme.repository.UserRepositoryImpl</code> to act as custom repository implementation, whereas the second example will try to lookup <code>com.acme.repository.UserRepositoryFooBar</code>.</p>
</div>
<div class="sect5">
<h6 id="repositories.manual-wiring"><a class="anchor" href="#repositories.manual-wiring"></a>Manual Wiring</h6>
<div class="paragraph">
<p>If your custom implementation uses annotation-based configuration and autowiring only, the preceding approach shown works well, because it is treated as any other Spring bean. If your custom implementation bean needs special wiring, you can declare the bean and name it according to the conventions described in the <a href="#repositories.single-repository-behaviour.ambiguity">preceding section</a>. The infrastructure then refers to the manually defined bean definition by name instead of creating one itself. The following example shows how to manually wire a custom implementation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 26. Manual wiring of custom implementations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;repositories base-package="com.acme.repository" /&gt;

&lt;beans:bean id="userRepositoryImpl" class="…"&gt;
  &lt;!-- further configuration --&gt;
&lt;/beans:bean&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories.custom-behaviour-for-all-repositories"><a class="anchor" href="#repositories.custom-behaviour-for-all-repositories"></a>8.6.2. Adding custom behavior to all repositories</h4>
<div class="paragraph">
<p>The preceding approach is not feasible when you want to add a single method to all your repository interfaces. To add custom behavior to all repositories, you first add an intermediate interface to declare the shared behavior.</p>
</div>
<div class="exampleblock">
<div class="title">Example 27. An interface declaring custom shared behavior</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@NoRepositoryBean
public interface MyRepository&lt;T, ID extends Serializable&gt;
  extends PagingAndSortingRepository&lt;T, ID&gt; {

  void sharedCustomMethod(ID id);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now your individual repository interfaces will extend this intermediate interface instead of the <code>Repository</code> interface to include the functionality declared. Next, create an implementation of the intermediate interface that extends the persistence technology-specific repository base class. This class will then act as a custom base class for the repository proxies.</p>
</div>
<div class="exampleblock">
<div class="title">Example 28. Custom repository base class</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class MyRepositoryImpl&lt;T, ID extends Serializable&gt;
  extends SimpleJpaRepository&lt;T, ID&gt; implements MyRepository&lt;T, ID&gt; {

  private final EntityManager entityManager;

  public MyRepositoryImpl(JpaEntityInformation entityInformation,
                          EntityManager entityManager) {
    super(entityInformation, entityManager);

    // Keep the EntityManager around to used from the newly introduced methods.
    this.entityManager = entityManager;
  }

  public void sharedCustomMethod(ID id) {
    // implementation goes here
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The class needs to have a constructor of the super class which the store-specific repository factory implementation uses. If the repository base class has multiple constructors, override the one taking an <code>EntityInformation</code> plus a store specific infrastructure object (such as an <code>EntityManager</code> or a template class).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The default behavior of the Spring <code>&lt;repositories /&gt;</code> namespace is to provide an implementation for all interfaces that fall under the <code>base-package</code>. This means that if left in its current state, an implementation instance of <code>MyRepository</code> will be created by Spring. This is of course not desired as it is just supposed to act as an intermediary between <code>Repository</code> and the actual repository interfaces you want to define for each entity. To exclude an interface that extends <code>Repository</code> from being instantiated as a repository instance, you can either annotate it with <code>@NoRepositoryBean</code> (as seen above) or move it outside of the configured <code>base-package</code>.</p>
</div>
<div class="paragraph">
<p>The final step is to make the Spring Data infrastructure aware of the customized repository base class. In Java configuration, you can do so by using the <code>repositoryBaseClass</code> attribute of the <code>@Enable${store}Repositories</code> annotation, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 29. Configuring a custom repository base class using JavaConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@EnableJpaRepositories(repositoryBaseClass = MyRepositoryImpl.class)
class ApplicationConfiguration { … }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A corresponding attribute is available in the XML namespace, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 30. Configuring a custom repository base class using XML</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;repositories base-package="com.acme.repository"
     base-class="….MyRepositoryImpl" /&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="core.domain-events"><a class="anchor" href="#core.domain-events"></a>8.7. Publishing Events from Aggregate Roots</h3>
<div class="paragraph">
<p>Entities managed by repositories are aggregate roots.
In a Domain-Driven Design application, these aggregate roots usually publish domain events.
Spring Data provides an annotation called <code>@DomainEvents</code> that you can use on a method of your aggregate root to make that publication as easy as possible, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 31. Exposing domain events from an aggregate root</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class AnAggregateRoot {

    @DomainEvents <i class="conum" data-value="1"></i><b>(1)</b>
    Collection&lt;Object&gt; domainEvents() {
        // … return events you want to get published here
    }

    @AfterDomainEventsPublication <i class="conum" data-value="2"></i><b>(2)</b>
    void callbackMethod() {
       // … potentially clean up domain events list
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The method using <code>@DomainEvents</code> can return either a single event instance or a collection of events. It must not take any arguments.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>After all events have been published, we have a method annotated with <code>@AfterDomainEventsPublication</code>. It can be used to potentially clean the list of events to be published (among other uses).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The methods are called every time one of a Spring Data repository&#8217;s <code>save(…)</code> methods is called.</p>
</div>
</div>
<div class="sect2">
<h3 id="core.extensions"><a class="anchor" href="#core.extensions"></a>8.8. Spring Data Extensions</h3>
<div class="paragraph">
<p>This section documents a set of Spring Data extensions that enable Spring Data usage in a variety of contexts. Currently, most of the integration is targeted towards Spring MVC.</p>
</div>
<div class="sect3">
<h4 id="core.extensions.querydsl"><a class="anchor" href="#core.extensions.querydsl"></a>8.8.1. Querydsl Extension</h4>
<div class="paragraph">
<p><a href="http://www.querydsl.com/">Querydsl</a> is a framework that enables the construction of statically typed SQL-like queries through its fluent API.</p>
</div>
<div class="paragraph">
<p>Several Spring Data modules offer integration with Querydsl through <code>QueryDslPredicateExecutor</code>, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 32. QueryDslPredicateExecutor interface</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface QueryDslPredicateExecutor&lt;T&gt; {

    T findOne(Predicate predicate);             <i class="conum" data-value="1"></i><b>(1)</b>

    Iterable&lt;T&gt; findAll(Predicate predicate);   <i class="conum" data-value="2"></i><b>(2)</b>

    long count(Predicate predicate);            <i class="conum" data-value="3"></i><b>(3)</b>

    boolean exists(Predicate predicate);        <i class="conum" data-value="4"></i><b>(4)</b>

    // … more functionality omitted.
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Finds and returns a single entity matching the <code>Predicate</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Finds and returns all entities matching the <code>Predicate</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Returns the number of entities matching the <code>Predicate</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Returns whether an entity that matches the <code>Predicate</code> exists.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>To make use of Querydsl support, extend <code>QueryDslPredicateExecutor</code> on your repository interface, as shown in the following example</p>
</div>
<div class="exampleblock">
<div class="title">Example 33. Querydsl integration on repositories</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface UserRepository extends CrudRepository&lt;User, Long&gt;, QueryDslPredicateExecutor&lt;User&gt; {
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding example lets you write typesafe queries using Querydsl <code>Predicate</code> instances, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Predicate predicate = user.firstname.equalsIgnoreCase("dave")
	.and(user.lastname.startsWithIgnoreCase("mathews"));

userRepository.findAll(predicate);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="core.web"><a class="anchor" href="#core.web"></a>8.8.2. Web support</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This section contains the documentation for the Spring Data web support as it is implemented in the current (and later) versions of Spring Data Commons. As the newly introduced support changes many things, we kept the documentation of the former behavior in <a href="#web.legacy">Legacy web support</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring Data modules that support the repository programming model ship with a variety of web support. The web related components require Spring MVC JARs to be on the classpath. Some of them even provide integration with <a href="https://github.com/SpringSource/spring-hateoas">Spring HATEOAS</a>. In general, the integration support is enabled by using the <code>@EnableSpringDataWebSupport</code> annotation in your JavaConfig configuration class, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 34. Enabling Spring Data web support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@EnableWebMvc
@EnableSpringDataWebSupport
class WebConfiguration { }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>@EnableSpringDataWebSupport</code> annotation registers a few components we will discuss in a bit. It will also detect Spring HATEOAS on the classpath and register integration components for it as well if present.</p>
</div>
<div class="paragraph">
<p>Alternatively, if you use XML configuration, register either <code>SpringDataWebConfiguration</code> or <code>HateoasAwareSpringDataWebConfiguration</code> as Spring beans, as shown in the following example (for <code>SpringDataWebConfiguration</code>):</p>
</div>
<div class="exampleblock">
<div class="title">Example 35. Enabling Spring Data web support in XML</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;bean class="org.springframework.data.web.config.SpringDataWebConfiguration" /&gt;

&lt;!-- If you use Spring HATEOAS, register this one *instead* of the former --&gt;
&lt;bean class="org.springframework.data.web.config.HateoasAwareSpringDataWebConfiguration" /&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="core.web.basic"><a class="anchor" href="#core.web.basic"></a>Basic Web Support</h5>
<div class="paragraph">
<p>The configuration shown in the <a href="#core.web">previous section</a> registers a few basic components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <a href="#core.web.basic.domain-class-converter"><code>DomainClassConverter</code></a> to let Spring MVC resolve instances of repository-managed domain classes from request parameters or path variables.</p>
</li>
<li>
<p><a href="#core.web.basic.paging-and-sorting"><code>HandlerMethodArgumentResolver</code></a> implementations to let Spring MVC resolve <code>Pageable</code> and <code>Sort</code> instances from request parameters.</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="core.web.basic.domain-class-converter"><a class="anchor" href="#core.web.basic.domain-class-converter"></a><code>DomainClassConverter</code></h6>
<div class="paragraph">
<p>The <code>DomainClassConverter</code> lets you use domain types in your Spring MVC controller method signatures directly, so that you need not manually lookup the instances through the repository, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 36. A Spring MVC controller using domain types in method signatures</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Controller
@RequestMapping("/users")
public class UserController {

  @RequestMapping("/{id}")
  public String showUserForm(@PathVariable("id") User user, Model model) {

    model.addAttribute("user", user);
    return "userForm";
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As you can see, the method receives a <code>User</code> instance directly, and no further lookup is necessary. The instance can be resolved by letting Spring MVC convert the path variable into the <code>id</code> type of the domain class first and eventually access the instance through calling <code>findOne(…)</code> on the repository instance registered for the domain type.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently, the repository has to implement <code>CrudRepository</code> to be eligible to be discovered for conversion.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="core.web.basic.paging-and-sorting"><a class="anchor" href="#core.web.basic.paging-and-sorting"></a>HandlerMethodArgumentResolvers for Pageable and Sort</h6>
<div class="paragraph">
<p>The configuration snippet shown in the <a href="#core.web.basic.domain-class-converter">previous section</a> also registers a <code>PageableHandlerMethodArgumentResolver</code> as well as an instance of <code>SortHandlerMethodArgumentResolver</code>. The registration enables <code>Pageable</code> and <code>Sort</code> as valid controller method arguments, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 37. Using Pageable as controller method argument</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Controller
@RequestMapping("/users")
public class UserController {

  @Autowired UserRepository repository;

  @RequestMapping
  public String showUsers(Model model, Pageable pageable) {

    model.addAttribute("users", repository.findAll(pageable));
    return "users";
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding method signature causes Spring MVC try to derive a <code>Pageable</code> instance from the request parameters by using the following default configuration:</p>
</div>
<table class="tableblock frame-all grid-all">
<caption class="title">Table 1. Request parameters evaluated for <code>Pageable</code> instances</caption>
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>page</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page you want to retrieve. 0-indexed and defaults to 0.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of the page you want to retrieve. Defaults to 20.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sort</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Properties that should be sorted by in the format <code>property,property(,ASC|DESC)</code>. Default sort direction is ascending. Use multiple <code>sort</code> parameters if you want to switch directions&#8201;&#8212;&#8201;for example, <code>?sort=firstname&amp;sort=lastname,asc</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To customize this behavior extend either <code>SpringDataWebConfiguration</code> or the HATEOAS-enabled equivalent and override the <code>pageableResolver()</code> or <code>sortResolver()</code> methods and import your customized configuration file instead of using the <code>@Enable</code>-annotation.</p>
</div>
<div class="paragraph">
<p>If you need multiple <code>Pageable</code> or <code>Sort</code> instances to be resolved from the request (for multiple tables, for example), you can use Spring&#8217;s <code>@Qualifier</code> annotation to distinguish one from another. The request parameters then have to be prefixed with <code>${qualifier}_</code>. The followig example shows the resulting method signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public String showUsers(Model model,
      @Qualifier("thing1") Pageable first,
      @Qualifier("thing2") Pageable second) { … }</code></pre>
</div>
</div>
<div class="paragraph">
<p>you have to populate <code>thing1_page</code> and <code>thing2_page</code> and so on.</p>
</div>
<div class="paragraph">
<p>The default <code>Pageable</code> passed into the method is equivalent to a <code>new PageRequest(0, 20)</code> but can be customized by using the <code>@PageableDefault</code> annotation on the <code>Pageable</code> parameter.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="core.web.pageables"><a class="anchor" href="#core.web.pageables"></a>Hypermedia Support for Pageables</h5>
<div class="paragraph">
<p>Spring HATEOAS ships with a representation model class (<code>PagedResources</code>) that allows enriching the content of a <code>Page</code> instance with the necessary <code>Page</code> metadata as well as links to let the clients easily navigate the pages. The conversion of a Page to a <code>PagedResources</code> is done by an implementation of the Spring HATEOAS <code>ResourceAssembler</code> interface, called the <code>PagedResourcesAssembler</code>. The following example shows how to use a <code>PagedResourcesAssembler</code> as a controller method argument:</p>
</div>
<div class="exampleblock">
<div class="title">Example 38. Using a PagedResourcesAssembler as controller method argument</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Controller
class PersonController {

  @Autowired PersonRepository repository;

  @RequestMapping(value = "/persons", method = RequestMethod.GET)
  HttpEntity&lt;PagedResources&lt;Person&gt;&gt; persons(Pageable pageable,
    PagedResourcesAssembler assembler) {

    Page&lt;Person&gt; persons = repository.findAll(pageable);
    return new ResponseEntity&lt;&gt;(assembler.toResources(persons), HttpStatus.OK);
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Enabling the configuration as shown in the preceding example lets the <code>PagedResourcesAssembler</code> be used as a controller method argument. Calling <code>toResources(…)</code> on it has the following effects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The content of the <code>Page</code> becomes the content of the <code>PagedResources</code> instance.</p>
</li>
<li>
<p>The <code>PagedResources</code> object gets a <code>PageMetadata</code> instance attached, and it is populated with information from the <code>Page</code> and the underlying <code>PageRequest</code>.</p>
</li>
<li>
<p>The <code>PagedResources</code> may get <code>prev</code> and <code>next</code> links attached, depending on the page&#8217;s state. The links point to the URI to which the method maps. The pagination parameters added to the method match the setup of the <code>PageableHandlerMethodArgumentResolver</code> to make sure the links can be resolved later.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Assume we have 30 Person instances in the database. You can now trigger a request (<code>GET <a href="http://localhost:8080/persons" class="bare">http://localhost:8080/persons</a></code>) and see output similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{ "links" : [ { "rel" : "next",
                "href" : "http://localhost:8080/persons?page=1&amp;size=20 }
  ],
  "content" : [
     … // 20 Person instances rendered here
  ],
  "pageMetadata" : {
    "size" : 20,
    "totalElements" : 30,
    "totalPages" : 2,
    "number" : 0
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You see that the assembler produced the correct URI and also picked up the default configuration to resolve the parameters into a <code>Pageable</code> for an upcoming request. This means that, if you change that configuration, the links automatically adhere to the change. By default, the assembler points to the controller method it was invoked in, but that can be customized by handing in a custom <code>Link</code> to be used as base to build the pagination links, which overloads the <code>PagedResourcesAssembler.toResource(…)</code> method.</p>
</div>
</div>
<div class="sect4">
<h5 id="core.web.binding"><a class="anchor" href="#core.web.binding"></a>Web Databinding Support</h5>
<div class="paragraph">
<p>Spring Data projections (described in <a href="#projections">Projections</a>) can be used to bind incoming request payloads by either using <a href="http://goessner.net/articles/JsonPath/">JSONPath</a> expressions (requires <a href="https://github.com/json-path/JsonPath">Jayway JsonPath</a> or <a href="https://www.w3.org/TR/xpath-31/">XPath</a> expressions (requires <a href="https://xmlbeam.org/">XmlBeam</a>), as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 39. HTTP payload binding using JSONPath or XPath expressions</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@ProjectedPayload
public interface UserPayload {

  @XBRead("//firstname")
  @JsonPath("$..firstname")
  String getFirstname();

  @XBRead("/lastname")
  @JsonPath({ "$.lastname", "$.user.lastname" })
  String getLastname();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The type shown in the preceding example can be used as a Spring MVC handler method argument or by using <code>ParameterizedTypeReference</code> on one of <code>RestTemplate</code>'s methods.
The preceding method declarations would try to find <code>firstname</code> anywhere in the given document.
The <code>lastname</code> XML lookup is performed on the top-level of the incoming document.
The JSON variant of that tries a top-level <code>lastname</code> first but also tries <code>lastname</code> nested in a <code>user</code> sub-document if the former does not return a value.
That way, changes in the structure of the source document can be mitigated easily without having clients calling the exposed methods (usually a drawback of class-based payload binding).</p>
</div>
<div class="paragraph">
<p>Nested projections are supported as described in <a href="#projections">Projections</a>.
If the method returns a complex, non-interface type, a Jackson <code>ObjectMapper</code> is used to map the final value.</p>
</div>
<div class="paragraph">
<p>For Spring MVC, the necessary converters are registered automatically as soon as <code>@EnableSpringDataWebSupport</code> is active and the required dependencies are available on the classpath.
For usage with <code>RestTemplate</code>, register a <code>ProjectingJackson2HttpMessageConverter</code> (JSON) or <code>XmlBeamHttpMessageConverter</code> manually.</p>
</div>
<div class="paragraph">
<p>For more information, see the <a href="https://github.com/spring-projects/spring-data-examples/tree/master/web/projection">web projection example</a> in the canonical <a href="https://github.com/spring-projects/spring-data-examples">Spring Data Examples repository</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="core.web.type-safe"><a class="anchor" href="#core.web.type-safe"></a>Querydsl Web Support</h5>
<div class="paragraph">
<p>For those stores having <a href="http://www.querydsl.com/">QueryDSL</a> integration, it is possible to derive queries from the attributes contained in a <code>Request</code> query string.</p>
</div>
<div class="paragraph">
<p>Consider the following query string:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-text" data-lang="text">?firstname=Dave&amp;lastname=Matthews</code></pre>
</div>
</div>
<div class="paragraph">
<p>Given the <code>User</code> object from previous examples, a query string can be resolved to the following value by using the <code>QuerydslPredicateArgumentResolver</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-text" data-lang="text">QUser.user.firstname.eq("Dave").and(QUser.user.lastname.eq("Matthews"))</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The feature is automatically enabled, along with <code>@EnableSpringDataWebSupport</code>, when Querydsl is found on the classpath.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Adding a <code>@QuerydslPredicate</code> to the method signature provides a ready-to-use <code>Predicate</code>, which can be run by using the <code>QuerydslPredicateExecutor</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Type information is typically resolved from the method&#8217;s return type. Since that information does not necessarily match the domain type, it might be a good idea to use the <code>root</code> attribute of <code>QuerydslPredicate</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following exampe shows how to use <code>@QuerydslPredicate</code> in a method signature:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Controller
class UserController {

  @Autowired UserRepository repository;

  @RequestMapping(value = "/", method = RequestMethod.GET)
  String index(Model model, @QuerydslPredicate(root = User.class) Predicate predicate,    <i class="conum" data-value="1"></i><b>(1)</b>
          Pageable pageable, @RequestParam MultiValueMap&lt;String, String&gt; parameters) {

    model.addAttribute("users", repository.findAll(predicate, pageable));

    return "index";
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Resolve query string arguments to matching <code>Predicate</code> for <code>User</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The default binding is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Object</code> on simple properties as <code>eq</code>.</p>
</li>
<li>
<p><code>Object</code> on collection like properties as <code>contains</code>.</p>
</li>
<li>
<p><code>Collection</code> on simple properties as <code>in</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Those bindings can be customized through the <code>bindings</code> attribute of <code>@QuerydslPredicate</code> or by making use of Java 8 <code>default methods</code> and adding the <code>QuerydslBinderCustomizer</code> method to the repository interface.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface UserRepository extends CrudRepository&lt;User, String&gt;,
                                 QueryDslPredicateExecutor&lt;User&gt;,                <i class="conum" data-value="1"></i><b>(1)</b>
                                 QuerydslBinderCustomizer&lt;QUser&gt; {               <i class="conum" data-value="2"></i><b>(2)</b>

  @Override
  default public void customize(QuerydslBindings bindings, QUser user) {

    bindings.bind(user.username).first((path, value) -&gt; path.contains(value))    <i class="conum" data-value="3"></i><b>(3)</b>
    bindings.bind(String.class)
      .first((StringPath path, String value) -&gt; path.containsIgnoreCase(value)); <i class="conum" data-value="4"></i><b>(4)</b>
    bindings.excluding(user.password);                                           <i class="conum" data-value="5"></i><b>(5)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>QueryDslPredicateExecutor</code> provides access to specific finder methods for <code>Predicate</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>QuerydslBinderCustomizer</code> defined on the repository interface is automatically picked up and shortcuts <code>@QuerydslPredicate(bindings=&#8230;&#8203;)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the binding for the <code>username</code> property to be a simple <code>contains</code> binding.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the default binding for <code>String</code> properties to be a case-insensitive <code>contains</code> match.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Exclude the <code>password</code> property from <code>Predicate</code> resolution.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="core.repository-populators"><a class="anchor" href="#core.repository-populators"></a>8.8.3. Repository Populators</h4>
<div class="paragraph">
<p>If you work with the Spring JDBC module, you are probably familiar with the support to populate a <code>DataSource</code> with SQL scripts. A similar abstraction is available on the repositories level, although it does not use SQL as the data definition language because it must be store-independent. Thus, the populators support XML (through Spring&#8217;s OXM abstraction) and JSON (through Jackson) to define data with which to populate the repositories.</p>
</div>
<div class="paragraph">
<p>Assume you have a file <code>data.json</code> with the following content:</p>
</div>
<div class="exampleblock">
<div class="title">Example 40. Data defined in JSON</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[ { "_class" : "com.acme.Person",
 "firstname" : "Dave",
  "lastname" : "Matthews" },
  { "_class" : "com.acme.Person",
 "firstname" : "Carter",
  "lastname" : "Beauford" } ]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can populate your repositories by using the populator elements of the repository namespace provided in Spring Data Commons. To populate the preceding data to your PersonRepository, declare a populator similar to the following:</p>
</div>
<div class="exampleblock">
<div class="title">Example 41. Declaring a Jackson repository populator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:repository="http://www.springframework.org/schema/data/repository"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/data/repository
    http://www.springframework.org/schema/data/repository/spring-repository.xsd"&gt;

  &lt;repository:jackson2-populator locations="classpath:data.json" /&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding declaration causes the <code>data.json</code> file to
be read and deserialized by a Jackson <code>ObjectMapper</code>.</p>
</div>
<div class="paragraph">
<p>The type to which the JSON object is unmarshalled is determined by inspecting the <code>_class</code> attribute of the JSON document. The infrastructure eventually selects the appropriate repository to handle the object that was deserialized.</p>
</div>
<div class="paragraph">
<p>To instead use XML to define the data the repositories should be populated with, you can use the <code>unmarshaller-populator</code> element. You configure it to use one of the XML marshaller options available in Spring OXM. See the <a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/html/oxm.html">Spring reference documentation</a> for details. The following example shows how to unmarshal a repository populator with JAXB:</p>
</div>
<div class="exampleblock">
<div class="title">Example 42. Declaring an unmarshalling repository populator (using JAXB)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:repository="http://www.springframework.org/schema/data/repository"
  xmlns:oxm="http://www.springframework.org/schema/oxm"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/data/repository
    http://www.springframework.org/schema/data/repository/spring-repository.xsd
    http://www.springframework.org/schema/oxm
    http://www.springframework.org/schema/oxm/spring-oxm.xsd"&gt;

  &lt;repository:unmarshaller-populator locations="classpath:data.json"
    unmarshaller-ref="unmarshaller" /&gt;

  &lt;oxm:jaxb2-marshaller contextPath="com.acme" /&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web.legacy"><a class="anchor" href="#web.legacy"></a>8.8.4. Legacy web support</h4>
<div class="sect4">
<h5 id="web-domain-class-binding"><a class="anchor" href="#web-domain-class-binding"></a>Domain class web binding for Spring MVC</h5>
<div class="paragraph">
<p>Given you are developing a Spring MVC web application you typically have to resolve domain class ids from URLs. By default your task is to transform that request parameter or URL part into the domain class to hand it to layers below then or execute business logic on the entities directly. This would look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Controller
@RequestMapping("/users")
public class UserController {

  private final UserRepository userRepository;

  @Autowired
  public UserController(UserRepository userRepository) {
    Assert.notNull(repository, "Repository must not be null!");
    this.userRepository = userRepository;
  }

  @RequestMapping("/{id}")
  public String showUserForm(@PathVariable("id") Long id, Model model) {

    // Do null check for id
    User user = userRepository.findOne(id);
    // Do null check for user

    model.addAttribute("user", user);
    return "user";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>First you declare a repository dependency for each controller to look up the entity managed by the controller or repository respectively. Looking up the entity is boilerplate as well, as it&#8217;s always a <code>findOne(…)</code> call. Fortunately Spring provides means to register custom components that allow conversion between a <code>String</code> value to an arbitrary type.</p>
</div>
<div class="sect5">
<h6 id="web.legacy.property-editors"><a class="anchor" href="#web.legacy.property-editors"></a>PropertyEditors</h6>
<div class="paragraph">
<p>For Spring versions before 3.0 simple Java <code>PropertyEditors</code> had to be used. To integrate with that, Spring Data offers a <code>DomainClassPropertyEditorRegistrar</code>, which looks up all Spring Data repositories registered in the <code>ApplicationContext</code> and registers a custom <code>PropertyEditor</code> for the managed domain class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;bean class="….web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter"&gt;
  &lt;property name="webBindingInitializer"&gt;
    &lt;bean class="….web.bind.support.ConfigurableWebBindingInitializer"&gt;
      &lt;property name="propertyEditorRegistrars"&gt;
        &lt;bean class="org.springframework.data.repository.support.DomainClassPropertyEditorRegistrar" /&gt;
      &lt;/property&gt;
    &lt;/bean&gt;
  &lt;/property&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have configured Spring MVC as in the preceding example, you can configure your controller as follows, which reduces a lot of the clutter and boilerplate.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Controller
@RequestMapping("/users")
public class UserController {

  @RequestMapping("/{id}")
  public String showUserForm(@PathVariable("id") User user, Model model) {

    model.addAttribute("user", user);
    return "userForm";
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<h1 id="reference" class="sect0"><a class="anchor" href="#reference"></a>Reference Documentation</h1>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>9. Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_document_structure"><a class="anchor" href="#_document_structure"></a>9.1. Document Structure</h3>
<div class="paragraph">
<p>This part of the reference documentation explains the core functionality offered by Spring Data MongoDB.</p>
</div>
<div class="paragraph">
<p>&#8220;<a href="#mongo.core">MongoDB support</a>&#8221; introduces the MongoDB module feature set.</p>
</div>
<div class="paragraph">
<p>&#8220;<a href="#mongo.repositories">MongoDB Repositories</a>&#8221; introduces the repository support for MongoDB.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.core"><a class="anchor" href="#mongo.core"></a>10. MongoDB support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The MongoDB support contains a wide range of features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring configuration support with Java-based <code>@Configuration</code> classes or an XML namespace for a Mongo driver instance and replica sets.</p>
</li>
<li>
<p><code>MongoTemplate</code> helper class that increases productivity when performing common Mongo operations. Includes integrated object mapping between documents and POJOs.</p>
</li>
<li>
<p>Exception translation into Spring&#8217;s portable Data Access Exception hierarchy.</p>
</li>
<li>
<p>Feature-rich Object Mapping integrated with Spring&#8217;s Conversion Service.</p>
</li>
<li>
<p>Annotation-based mapping metadata that is extensible to support other metadata formats.</p>
</li>
<li>
<p>Persistence and mapping lifecycle events.</p>
</li>
<li>
<p>Java-based Query, Criteria, and Update DSLs.</p>
</li>
<li>
<p>Automatic implementation of Repository interfaces, including support for custom finder methods.</p>
</li>
<li>
<p>QueryDSL integration to support type-safe queries.</p>
</li>
<li>
<p>Cross-store persistence - support for JPA Entities with fields transparently persisted/retrieved using MongoDB.</p>
</li>
<li>
<p>Log4j log appender.</p>
</li>
<li>
<p>GeoSpatial integration.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For most tasks, you should use <code>MongoTemplate</code> or the Repository support, which both leverage the rich mapping functionality. <code>MongoTemplate</code> is the place to look for accessing functionality such as incrementing counters or ad-hoc CRUD operations. <code>MongoTemplate</code> also provides callback methods so that it is easy for you to get the low-level API artifacts, such as <code>com.mongo.DB</code>, to communicate directly with MongoDB. The goal with naming conventions on various API artifacts is to copy those in the base MongoDB Java driver so you can easily map your existing knowledge onto the Spring APIs.</p>
</div>
<div class="sect2">
<h3 id="mongodb-getting-started"><a class="anchor" href="#mongodb-getting-started"></a>10.1. Getting Started&nbsp;&nbsp;<font class="pl">开始</font></h3>
<div class="paragraph">
<p style="margin-bottom:0px;">Spring MongoDB support requires MongoDB 2.6 or higher and Java SE 6 or higher. An easy way to bootstrap setting up a working environment is to create a Spring-based project in <a href="https://spring.io/tools/sts">STS</a>.</p>
<p class="pl">Spring的MongoDB支持要求MongoDB的版本最低是2.6，Java SE版本最低是6。</p>
</div>
<div class="paragraph">
<p style="margin-bottom:0px;">First, you need to set up a running MongoDB server. Refer to the <a href="http://docs.mongodb.org/manual/core/introduction/">MongoDB Quick Start guide</a> for an explanation on how to startup a MongoDB instance. Once installed, starting MongoDB is typically a matter of running the following command: <code>${MONGO_HOME}/bin/mongod</code></p>
<p class="pl">首先，你需要启动一个MongoDB服务。参考<a href="http://docs.mongodb.org/manual/core/introduction/">MongoDB Quick Start guide</a>这篇帮助文档</p>
</div>
<div class="paragraph">
<p>To create a Spring project in STS:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Go to File &#8594; New &#8594; Spring Template Project &#8594; Simple Spring Utility Project, and press Yes when prompted. Then enter a project and a package name, such as <code>org.spring.mongodb.example</code>.
.Add the following to the pom.xml files <code>dependencies</code> element:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;

  &lt;!-- other dependency elements omitted --&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
    &lt;artifactId&gt;spring-data-mongodb&lt;/artifactId&gt;
    &lt;version&gt;1.10.18.RELEASE&lt;/version&gt;
  &lt;/dependency&gt;

&lt;/dependencies&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Change the version of Spring in the pom.xml to be</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;spring.framework.version&gt;4.3.22.RELEASE&lt;/spring.framework.version&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Add the following location of the Spring Milestone repository for Maven to your <code>pom.xml</code> such that it is at the same level of your <code>&lt;dependencies/&gt;</code> element:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;repositories&gt;
  &lt;repository&gt;
    &lt;id&gt;spring-milestone&lt;/id&gt;
    &lt;name&gt;Spring Maven MILESTONE Repository&lt;/name&gt;
    &lt;url&gt;http://repo.spring.io/libs-milestone&lt;/url&gt;
  &lt;/repository&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The repository is also <a href="https://repo.spring.io/milestone/org/springframework/data/">browseable here</a>.</p>
</div>
<div class="paragraph">
<p>You may also want to set the logging level to <code>DEBUG</code> to see some additional information. To do so, edit the <code>log4j.properties</code> file to have the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>log4j.category.org.springframework.data.mongodb=DEBUG
log4j.appender.stdout.layout.ConversionPattern=%d{ABSOLUTE} %5p %40.40c:%4L - %m%n</code></pre>
</div>
</div>
<div class="paragraph">
<p style="margin-bottom:0px;">Then you can create a <code>Person</code> class to persist:</p>
<p class="pl">然后你需要创建一个持久化类<code>Person</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package org.spring.mongodb.example;

public class Person {

  private String id;
  private String name;
  private int age;

  public Person(String name, int age) {
    this.name = name;
    this.age = age;
  }

  public String getId() {
    return id;
  }
  public String getName() {
    return name;
  }
  public int getAge() {
    return age;
  }

  @Override
  public String toString() {
    return "Person [id=" + id + ", name=" + name + ", age=" + age + "]";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You also need a main application to run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package org.spring.mongodb.example;

import static org.springframework.data.mongodb.core.query.Criteria.where;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.data.mongodb.core.MongoOperations;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.data.mongodb.core.query.Query;

import com.mongodb.Mongo;

public class MongoApp {

  private static final Log log = LogFactory.getLog(MongoApp.class);

  public static void main(String[] args) throws Exception {

    MongoOperations mongoOps = new MongoTemplate(new Mongo(), "database");
    mongoOps.insert(new Person("Joe", 34));

    log.info(mongoOps.findOne(new Query(where("name").is("Joe")), Person.class));

    mongoOps.dropCollection("person");
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you run the main program, the preceding examples produce the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>10:01:32,062 DEBUG apping.MongoPersistentEntityIndexCreator:  80 - Analyzing class class org.spring.example.Person for index information.
10:01:32,265 DEBUG ramework.data.mongodb.core.MongoTemplate: 631 - insert DBObject containing fields: [_class, age, name] in collection: Person
10:01:32,765 DEBUG ramework.data.mongodb.core.MongoTemplate:1243 - findOne using query: { "name" : "Joe"} in db.collection: database.Person
10:01:32,953  INFO      org.spring.mongodb.example.MongoApp:  25 - Person [id=4ddbba3c0be56b7e1b210166, name=Joe, age=34]
10:01:32,984 DEBUG ramework.data.mongodb.core.MongoTemplate: 375 - Dropped collection [database.person]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even in this simple example, there are few things to notice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can instantiate the central helper class of Spring Mongo, <a href="#mongo-template"><code>MongoTemplate</code></a>, by using the standard <code>com.mongodb.Mongo</code> object and the name of the database to use.</p>
</li>
<li>
<p>The mapper works against standard POJO objects without the need for any additional metadata (though you can optionally provide that information. See <a href="#mapping-chapter">here</a>.).</p>
</li>
<li>
<p>Conventions are used for handling the <code>id</code> field, converting it to be an <code>ObjectId</code> when stored in the database.</p>
</li>
<li>
<p>Mapping conventions can use field access. Notice that the <code>Person</code> class has only getters.</p>
</li>
<li>
<p>If the constructor argument names match the field names of the stored document, they are used to instantiate the object</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="mongo.examples-repo"><a class="anchor" href="#mongo.examples-repo"></a>10.2. Examples Repository</h3>
<div class="paragraph">
<p>There is a <a href="https://github.com/spring-projects/spring-data-examples">GitHub repository with several examples</a> that you can download and play around with to get a feel for how the library works.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-connectors"><a class="anchor" href="#mongodb-connectors"></a>10.3. Connecting to MongoDB with Spring&nbsp;&nbsp;<font class="pl">通过Spring连接MongoDB</font></h3>
<div class="paragraph">
<p style="margin-bottom:0px;">One of the first tasks when using MongoDB and Spring is to create a <code>com.mongodb.Mongo</code> object using the IoC container. There are two main ways to do this, either by using Java-based bean metadata or by using XML-based bean metadata. Both are discussed in the following sections.</p>
<p class="pl">要想在Spring框架的基础上操作MongoDB，首要任务是通过IoC容器创建一个<code>com.mongodb.Mongo</code>实例对象。
这里主要有两种方法：第一种是通过基于Java的bean元数据实现，第二种是通过基于XML的bean元数据实现。这两种方法在以下的章节展开讨论：
</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For those not familiar with how to configure the Spring container using Java-based bean metadata instead of XML-based metadata, see the high-level introduction in the reference docs <a href="https://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/new-in-3.0.html#new-java-configuration">here</a> as well as the detailed documentation <a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/html/beans.html#beans-java-instantiating-container">here</a>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="mongo.mongo-java-config"><a class="anchor" href="#mongo.mongo-java-config"></a>10.3.1. Registering a Mongo Instance by using Java-based Metadata&nbsp;&nbsp;<font class="pl">使用基于Java的元数据注册Mongo实例</font></h4>
<div class="paragraph">
<p>The following example shows an example of using Java-based bean metadata to register an instance of a <code>com.mongodb.Mongo</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 43. Registering a <code>com.mongodb.Mongo</code> object using Java based bean metadata</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
public class AppConfig {

  /*
   * Use the standard Mongo driver API to create a com.mongodb.Mongo instance.
   */
   public @Bean Mongo mongo() throws UnknownHostException {
       return new Mongo("localhost");
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This approach lets you use the standard <code>com.mongodb.Mongo</code> API that you may already be used to using but also pollutes the code with the UnknownHostException checked exception. The use of the checked exception is not desirable as Java based bean metadata uses methods as a means to set object dependencies, making the calling code cluttered.</p>
</div>
<div class="paragraph">
<p>An alternative is to register an instance of <code>com.mongodb.Mongo</code> instance, with the container using Spring&#8217;s <code>MongoClientFactoryBean</code>. As compared to instantiating a <code>com.mongodb.Mongo</code> instance directly, the FactoryBean approach does not throw a checked exception and has the added advantage of also providing the container with an <code>ExceptionTranslator</code> implementation that translates MongoDB exceptions to exceptions in Spring&#8217;s portable <code>DataAccessException</code> hierarchy for data access classes annotated with the <code>@Repository</code> annotation. This hierarchy and the use of <code>@Repository</code> is described in <a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/html/dao.html">Spring&#8217;s DAO support features</a>.</p>
</div>
<div class="paragraph">
<p>The following example shows an example of a Java-based bean metadata that supports exception translation on <code>@Repository</code> annotated classes:</p>
</div>
<div class="exampleblock">
<div class="title">Example 44. Registering a <code>com.mongodb.Mongo</code> object using Spring&#8217;s MongoClientFactoryBean and enabling Spring&#8217;s exception translation support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
public class AppConfig {

    /*
     * Factory bean that creates the com.mongodb.Mongo instance
     */
     public @Bean MongoClientFactoryBean mongo() {
          MongoClientFactoryBean mongo = new MongoClientFactoryBean();
          mongo.setHost("localhost");
          return mongo;
     }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To access the <code>com.mongodb.Mongo</code> object created by the <code>MongoClientFactoryBean</code> in other <code>@Configuration</code> classes or your own classes, use a <code>private @Autowired Mongo mongo;</code> field.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.mongo-xml-config"><a class="anchor" href="#mongo.mongo-xml-config"></a>10.3.2. Registering a Mongo Instance by Using XML-based Metadata</h4>
<div class="paragraph">
<p>While you can use Spring&#8217;s traditional <code>&lt;beans/&gt;</code> XML namespace to register an instance of <code>com.mongodb.Mongo</code> with the container, the XML can be quite verbose, as it is general-purpose. XML namespaces are a better alternative to configuring commonly used objects, such as the Mongo instance. The mongo namespace lets you create a Mongo instance server location, replica-sets, and options.</p>
</div>
<div class="paragraph">
<p>To use the Mongo namespace elements, you need to reference the Mongo schema, as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 45. XML schema to configure MongoDB</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xmlns:context="http://www.springframework.org/schema/context"
          xmlns:mongo="http://www.springframework.org/schema/data/mongo"
          xsi:schemaLocation=
          "http://www.springframework.org/schema/context
          http://www.springframework.org/schema/context/spring-context.xsd
          http://www.springframework.org/schema/data/mongo http://www.springframework.org/schema/data/mongo/spring-mongo.xsd
          http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;

    &lt;!-- Default bean name is 'mongo' --&gt;
    &lt;mongo:mongo host="localhost" port="27017"/&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows a more advanced configuration with <code>MongoOptions</code> (note that these are not recommended values):</p>
</div>
<div class="exampleblock">
<div class="title">Example 46. XML schema to configure a com.mongodb.Mongo object with MongoOptions</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;beans&gt;

  &lt;mongo:mongo host="localhost" port="27017"&gt;
    &lt;mongo:options connections-per-host="8"
                   threads-allowed-to-block-for-connection-multiplier="4"
                   connect-timeout="1000"
                   max-wait-time="1500}"
                   auto-connect-retry="true"
                   socket-keep-alive="true"
                   socket-timeout="1500"
                   slave-ok="true"
                   write-number="1"
                   write-timeout="0"
                   write-fsync="true"/&gt;
  &lt;/mongo:mongo/&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows a configuration using replica sets:</p>
</div>
<div class="exampleblock">
<div class="title">Example 47. XML schema to configure <code>com.mongodb.Mongo</code> object with Replica Sets</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;mongo:mongo id="replicaSetMongo" replica-set="127.0.0.1:27017,localhost:27018"/&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.mongo-db-factory"><a class="anchor" href="#mongo.mongo-db-factory"></a>10.3.3. The MongoDbFactory Interface</h4>
<div class="paragraph">
<p>While <code>com.mongodb.Mongo</code> is the entry point to the MongoDB driver API, connecting to a specific MongoDB database instance requires additional information, such as the database name and an optional username and password. With that information, you can obtain a <code>com.mongodb.DB</code> object and access all the functionality of a specific MongoDB database instance. Spring provides the <code>org.springframework.data.mongodb.core.MongoDbFactory</code> interface, shown in the following listing, to bootstrap connectivity to the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface MongoDbFactory {

  DB getDb() throws DataAccessException;

  DB getDb(String dbName) throws DataAccessException;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following sections show how you can use the container with either Java-based or XML-based metadata to configure an instance of the <code>MongoDbFactory</code> interface. In turn, you can use the <code>MongoDbFactory</code> instance to configure <code>MongoTemplate</code>.</p>
</div>
<div class="paragraph">
<p>The class <code>org.springframework.data.mongodb.core.SimpleMongoDbFactory</code> provides implements the <code>MongoDbFactory</code> interface and is created with a standard <code>com.mongodb.Mongo</code> instance, the database name and an optional <code>org.springframework.data.authentication.UserCredentials</code> constructor argument.</p>
</div>
<div class="paragraph">
<p>Instead of using the IoC container to create an instance of MongoTemplate, you can use them in standard Java code, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class MongoApp {

  private static final Log log = LogFactory.getLog(MongoApp.class);

  public static void main(String[] args) throws Exception {

    MongoOperations mongoOps = new MongoTemplate(new SimpleMongoDbFactory(new Mongo(), "database"));

    mongoOps.insert(new Person("Joe", 34));

    log.info(mongoOps.findOne(new Query(where("name").is("Joe")), Person.class));

    mongoOps.dropCollection("person");
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code in bold highlights the use of <code>SimpleMongoDbFactory</code> and is the only difference between the listing shown in the <a href="#mongodb-getting-started">getting started section</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.mongo-db-factory-java"><a class="anchor" href="#mongo.mongo-db-factory-java"></a>10.3.4. Registering a <code>MongoDbFactory</code> Instance by Using Java-based Metadata</h4>
<div class="paragraph">
<p>To register a <code>MongoDbFactory</code> instance with the container, you write code much like what was highlighted in the previous code listing. The following listing shows a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
public class MongoConfiguration {

  public @Bean MongoDbFactory mongoDbFactory() throws Exception {
    return new SimpleMongoDbFactory(new Mongo(), "database");
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To define the username and password create an instance of <code>org.springframework.data.authentication.UserCredentials</code> and pass it into the constructor as shown below. This listing also shows using <code>MongoDbFactory</code> register an instance of MongoTemplate with the container.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
public class MongoConfiguration {

  public @Bean MongoDbFactory mongoDbFactory() throws Exception {
    UserCredentials userCredentials = new UserCredentials("joe", "secret");
    return new SimpleMongoDbFactory(new Mongo(), "database", userCredentials);
  }

  public @Bean MongoTemplate mongoTemplate() throws Exception {
    return new MongoTemplate(mongoDbFactory());
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.mongo-db-factory-xml"><a class="anchor" href="#mongo.mongo-db-factory-xml"></a>10.3.5. Registering a <code>MongoDbFactory</code> Instance by Using XML-based Metadata</h4>
<div class="paragraph">
<p>The <code>mongo</code> namespace provides a convenient way to create a <code>SimpleMongoDbFactory</code>, as compared to using the <code>&lt;beans/&gt;</code> namespace, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;mongo:db-factory dbname="database"&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example a <code>com.mongodb.Mongo</code> instance is created using the default host and port number. The <code>SimpleMongoDbFactory</code> registered with the container is identified by the id 'mongoDbFactory' unless a value for the id attribute is specified.</p>
</div>
<div class="paragraph">
<p>You can also provide the host and port for the underlying <code>com.mongodb.Mongo</code> instance as shown below, in addition to username and password for the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;mongo:db-factory id="anotherMongoDbFactory"
                  host="localhost"
                  port="27017"
                  dbname="database"
                  username="joe"
                  password="secret"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your MongoDB authentication database differs from the target database, use the <code>authentication-dbname</code> attribute, as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;mongo:db-factory id="anotherMongoDbFactory"
                  host="localhost"
                  port="27017"
                  dbname="database"
                  username="joe"
                  password="secret"
                  authentication-dbname="admin"
                  /&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you need to configure additional options on the <code>com.mongodb.Mongo</code> instance that is used to create a <code>SimpleMongoDbFactory</code>, you can refer to an existing bean by using the <code>mongo-ref</code> attribute as shown in the following example. To show another common usage pattern, the following listing shows the use of a property placeholder, which lets you parametrize the configuration and the creation of a <code>MongoTemplate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;context:property-placeholder location="classpath:/com/myapp/mongodb/config/mongo.properties"/&gt;

&lt;mongo:mongo host="${mongo.host}" port="${mongo.port}"&gt;
  &lt;mongo:options
     connections-per-host="${mongo.connectionsPerHost}"
     threads-allowed-to-block-for-connection-multiplier="${mongo.threadsAllowedToBlockForConnectionMultiplier}"
     connect-timeout="${mongo.connectTimeout}"
     max-wait-time="${mongo.maxWaitTime}"
     auto-connect-retry="${mongo.autoConnectRetry}"
     socket-keep-alive="${mongo.socketKeepAlive}"
     socket-timeout="${mongo.socketTimeout}"
     slave-ok="${mongo.slaveOk}"
     write-number="1"
     write-timeout="0"
     write-fsync="true"/&gt;
&lt;/mongo:mongo&gt;

&lt;mongo:db-factory dbname="database" mongo-ref="mongo"/&gt;

&lt;bean id="anotherMongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
  &lt;constructor-arg name="mongoDbFactory" ref="mongoDbFactory"/&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo-template"><a class="anchor" href="#mongo-template"></a>10.4. Introduction to <code>MongoTemplate</code>&nbsp;&nbsp;<font class="pl">MongoTemplate的介绍</font></h3>
<div class="paragraph">
<p style="margin-bottom:0px;">The <code>MongoTemplate</code> class, located in the <code>org.springframework.data.mongodb.core</code> package, is the central class of Spring&#8217;s MongoDB support and provides a rich feature set for interacting with the database. The template offers convenience operations to create, update, delete, and query MongoDB documents and provides a mapping between your domain objects and MongoDB documents.</p>
<p class="pl">在<code>org.springframework.data.mongodb.core</code>包中的<code>MongoTemplate</code>类是Spring对MongoDB支持模块的最主要的类，它提供丰富的操作MongoDB的功能。它不仅提供了对MongoDB的增删改查便捷操作，同时可以将MongoDB中的文档映射到域对象中。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Once configured, <code>MongoTemplate</code> is thread-safe and can be reused across multiple instances.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The mapping between MongoDB documents and domain classes is done by delegating to an implementation of the interface <code>MongoConverter</code>. Spring provides two implementations, <code>SimpleMappingConverter</code> and <code>MappingMongoConverter</code>, but you can also write your own converter. Please refer to the section on MongoConverters for more detailed information.</p>
</div>
<div class="paragraph">
<p>The <code>MongoTemplate</code> class implements the interface <code>MongoOperations</code>. In as much as possible, the methods on <code>MongoOperations</code> are named after methods available on the MongoDB driver <code>Collection</code> object, to make the API familiar to existing MongoDB developers who are used to the driver API. For example, you can find methods such as <code>find</code>, <code>findAndModify</code>, <code>findOne</code>, <code>insert</code>, <code>remove</code>, <code>save</code>, <code>update</code>, and <code>updateMulti</code>. The design goal was to make it as easy as possible to transition between the use of the base MongoDB driver and <code>MongoOperations</code>. A major difference between the two APIs is that <code>MongoOperations</code> can be passed domain objects instead of <code>DBObject</code>. Also, <code>MongoOperations</code> has fluent APIs for <code>Query</code>, <code>Criteria</code>, and <code>Update</code> operations instead of populating a <code>DBObject</code> to specify the parameters for those operations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The preferred way to reference the operations on <code>MongoTemplate</code> instance is through its interface, <code>MongoOperations</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The default converter implementation used by <code>MongoTemplate</code> is <code>MappingMongoConverter</code>. While the <code>MappingMongoConverter</code> can use additional metadata to specify the mapping of objects to documents, it can also convert objects that contain no additional metadata by using some conventions for the mapping of IDs and collection names. These conventions, as well as the use of mapping annotations, are explained in the &#8220;<a href="#mapping-chapter">Mapping</a>&#8221; chapter.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the M2 release <code>SimpleMappingConverter</code>, was the default and this class is now deprecated as its functionality has been subsumed by the <code>MappingMongoConverter</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Another central feature of <code>MongoTemplate</code> is translation of exceptions thrown by the MongoDB Java driver into Spring&#8217;s portable Data Access Exception hierarchy. See &#8220;<a href="#mongo.exception">Exception Translation</a>&#8221; for more information.</p>
</div>
<div class="paragraph">
<p><code>MongoTemplate</code> offers many convenience methods to help you easily perform common tasks. However, if you need to directly access the MongoDB driver API, you can use one of several <code>Execute</code> callback methods. The execute callbacks gives you a reference to either a <code>com.mongodb.DBCollection</code> or a <code>com.mongodb.DB</code> object. See the <a href="#mongo.executioncallback">&#8220;Execution Callbacks&#8221;</a> section for more information.</p>
</div>
<div class="paragraph">
<p>The next section contains an example of how to work with the <code>MongoTemplate</code> in the context of the Spring container.</p>
</div>
<div class="sect3">
<h4 id="mongo-template.instantiating"><a class="anchor" href="#mongo-template.instantiating"></a>10.4.1. Instantiating <code>MongoTemplate</code></h4>
<div class="paragraph">
<p>You can use Java to create and register an instance of <code>MongoTemplate</code>, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 48. Registering a <code>com.mongodb.Mongo</code> object and enabling Spring&#8217;s exception translation support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
public class AppConfig {

  public @Bean Mongo mongo() throws Exception {
      return new Mongo("localhost");
  }

  public @Bean MongoTemplate mongoTemplate() throws Exception {
      return new MongoTemplate(mongo(), "mydatabase");
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There are several overloaded constructors of <code>MongoTemplate</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>MongoTemplate(Mongo mongo, String databaseName)</code>: Takes the <code>com.mongodb.Mongo</code> object and the default database name to operate against.</p>
</li>
<li>
<p><code>MongoTemplate(Mongo mongo, String databaseName, UserCredentials userCredentials)</code> - adds the username and password for authenticating with the database.</p>
</li>
<li>
<p><code>MongoTemplate(MongoDbFactory mongoDbFactory)</code>: Takes a MongoDbFactory object that encapsulated the <code>com.mongodb.Mongo</code> object, database name, and username and password.</p>
</li>
<li>
<p><code>MongoTemplate(MongoDbFactory mongoDbFactory, MongoConverter mongoConverter)</code>: Adds a <code>MongoConverter</code> to use for mapping.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also configure a MongoTemplate by using Spring&#8217;s XML &lt;beans/&gt; schema, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">&lt;mongo:mongo host="localhost" port="27017"/&gt;

&lt;bean id="mongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
  &lt;constructor-arg ref="mongo"/&gt;
  &lt;constructor-arg name="databaseName" value="geospatial"/&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Other optional properties that you might like to set when creating a <code>MongoTemplate</code> are the default <code>WriteResultCheckingPolicy</code>, <code>WriteConcern</code>, and <code>ReadPreference</code> properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The preferred way to reference the operations on <code>MongoTemplate</code> instance is through its interface, <code>MongoOperations</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.writeresultchecking"><a class="anchor" href="#mongo-template.writeresultchecking"></a>10.4.2. <code>WriteResultChecking</code> Policy</h4>
<div class="paragraph">
<p>When in development it is very handy to either log or throw an exception if the <code>com.mongodb.WriteResult</code> returned from any MongoDB operation contains an error. It is quite common to forget to do this during development and then end up with an application that looks like it runs successfully but in fact the database was not modified according to your expectations. Set MongoTemplate&#8217;s property to an enum with the following values, <code>LOG</code>, <code>EXCEPTION</code>, or <code>NONE</code> to either log the error, throw and exception or do nothing. The default is to use a <code>WriteResultChecking</code> value of <code>NONE</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.writeconcern"><a class="anchor" href="#mongo-template.writeconcern"></a>10.4.3. <code>WriteConcern</code></h4>
<div class="paragraph">
<p>If it has not yet been specified through the driver at a higher level (such as <code>com.mongodb.Mongo</code>), you can set the <code>com.mongodb.WriteConcern</code> property that the <code>MongoTemplate</code> uses for write operations. If the <code>WriteConcern</code> property is not set, it defaults to the one set in the MongoDB driver&#8217;s DB or Collection setting.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.writeconcernresolver"><a class="anchor" href="#mongo-template.writeconcernresolver"></a>10.4.4. <code>WriteConcernResolver</code></h4>
<div class="paragraph">
<p>For more advanced cases where you want to set different <code>WriteConcern</code> values on a per-operation basis (for remove, update, insert, and save operations), a strategy interface called <code>WriteConcernResolver</code> can be configured on <code>MongoTemplate</code>. Since <code>MongoTemplate</code> is used to persist POJOs, the <code>WriteConcernResolver</code> lets you create a policy that can map a specific POJO class to a <code>WriteConcern</code> value. The following listing shows the <code>WriteConcernResolver</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface WriteConcernResolver {
  WriteConcern resolve(MongoAction action);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>MongoAction</code> argument to determine the <code>WriteConcern</code> value or use the value of the Template itself as a default. <code>MongoAction</code> contains the collection name being written to, the <code>java.lang.Class</code> of the POJO, the converted <code>DBObject</code>, the operation (<code>REMOVE</code>, <code>UPDATE</code>, <code>INSERT</code>, <code>INSERT_LIST</code>, or <code>SAVE</code>), and a few other pieces of contextual information. The following example shows two sets of classes getting different <code>WriteConcern</code> settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>private class MyAppWriteConcernResolver implements WriteConcernResolver {

  public WriteConcern resolve(MongoAction action) {
    if (action.getEntityClass().getSimpleName().contains("Audit")) {
      return WriteConcern.NONE;
    } else if (action.getEntityClass().getSimpleName().contains("Metadata")) {
      return WriteConcern.JOURNAL_SAFE;
    }
    return action.getDefaultWriteConcern();
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo-template.save-update-remove"><a class="anchor" href="#mongo-template.save-update-remove"></a>10.5. Saving, Updating, and Removing Documents&nbsp;&nbsp;<font class="pl">保存、更新以及删除文档</font></h3>
<div class="paragraph">
<p style="margin-bottom:0px;"><code>MongoTemplate</code> lets you save, update, and delete your domain objects and map those objects to documents stored in MongoDB.</p>
<p class="pl"><code>MongoTemplate</code>可以让你对域对象的增删改操作映射到对MongogDB的增删改操作</p>
</div>
<div class="paragraph">
<p>Consider the following class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class Person {

  private String id;
  private String name;
  private int age;

  public Person(String name, int age) {
    this.name = name;
    this.age = age;
  }

  public String getId() {
    return id;
  }
  public String getName() {
    return name;
  }
  public int getAge() {
    return age;
  }

  @Override
  public String toString() {
    return "Person [id=" + id + ", name=" + name + ", age=" + age + "]";
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Given the <code>Person</code> class in the preceding example, you can save, update and delete the object, as the following example shows:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>MongoOperations</code> is the interface that <code>MongoTemplate</code> implements.
<p class="pl"><code>MongoTemplate</code>类实现了<code>MongoOperations</code>接口</p>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package org.spring.example;

import static org.springframework.data.mongodb.core.query.Criteria.where;
import static org.springframework.data.mongodb.core.query.Update.update;
import static org.springframework.data.mongodb.core.query.Query.query;

import java.util.List;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.data.mongodb.core.MongoOperations;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.data.mongodb.core.SimpleMongoDbFactory;

import com.mongodb.Mongo;

public class MongoApp {

  private static final Log log = LogFactory.getLog(MongoApp.class);

  public static void main(String[] args) throws Exception {

    MongoOperations mongoOps = new MongoTemplate(new SimpleMongoDbFactory(new Mongo(), "database"));

    Person p = new Person("Joe", 34);

    // Insert is used to initially store the object into the database.
    mongoOps.insert(p);
    log.info("Insert: " + p);

    // Find
    p = mongoOps.findById(p.getId(), Person.class);
    log.info("Found: " + p);

    // Update
    mongoOps.updateFirst(query(where("name").is("Joe")), update("age", 35), Person.class);
    p = mongoOps.findOne(query(where("name").is("Joe")), Person.class);
    log.info("Updated: " + p);

    // Delete
    mongoOps.remove(p);

    // Check that deletion worked
    List&lt;Person&gt; people =  mongoOps.findAll(Person.class);
    log.info("Number of people = : " + people.size());


    mongoOps.dropCollection(Person.class);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding example would produce the following log output (including debug messages from <code>MongoTemplate</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>DEBUG apping.MongoPersistentEntityIndexCreator:  80 - Analyzing class class org.spring.example.Person for index information.
DEBUG work.data.mongodb.core.MongoTemplate: 632 - insert DBObject containing fields: [_class, age, name] in collection: person
INFO               org.spring.example.MongoApp:  30 - Insert: Person [id=4ddc6e784ce5b1eba3ceaf5c, name=Joe, age=34]
DEBUG work.data.mongodb.core.MongoTemplate:1246 - findOne using query: { "_id" : { "$oid" : "4ddc6e784ce5b1eba3ceaf5c"}} in db.collection: database.person
INFO               org.spring.example.MongoApp:  34 - Found: Person [id=4ddc6e784ce5b1eba3ceaf5c, name=Joe, age=34]
DEBUG work.data.mongodb.core.MongoTemplate: 778 - calling update using query: { "name" : "Joe"} and update: { "$set" : { "age" : 35}} in collection: person
DEBUG work.data.mongodb.core.MongoTemplate:1246 - findOne using query: { "name" : "Joe"} in db.collection: database.person
INFO               org.spring.example.MongoApp:  39 - Updated: Person [id=4ddc6e784ce5b1eba3ceaf5c, name=Joe, age=35]
DEBUG work.data.mongodb.core.MongoTemplate: 823 - remove using query: { "id" : "4ddc6e784ce5b1eba3ceaf5c"} in collection: person
INFO               org.spring.example.MongoApp:  46 - Number of people = : 0
DEBUG work.data.mongodb.core.MongoTemplate: 376 - Dropped collection [database.person]</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>MongoConverter</code> caused implicit conversion between a <code>String</code> and an <code>ObjectId</code> stored in the database by recognizing (through convention) the <code>Id</code> property name.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The preceding example is meant to show the use of save, update, and remove operations on <code>MongoTemplate</code> and not to show complex mapping functionality.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The query syntax used in the preceding example is explained in more detail in the section &#8220;<a href="#mongo.query">Querying Documents</a>&#8221;.</p>
</div>
<div class="sect3">
<h4 id="mongo-template.id-handling"><a class="anchor" href="#mongo-template.id-handling"></a>10.5.1. How the <code>_id</code> Field is Handled in the Mapping Layer</h4>
<div class="paragraph">
<p>MongoDB requires that you have an <code>_id</code> field for all documents. If you do not provide one, the driver assigns an <code>ObjectId</code> with a generated value. When you use the <code>MappingMongoConverter</code>, certain rules govern how properties from the Java class are mapped to this <code>_id</code> field:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A property or field annotated with <code>@Id</code> (<code>org.springframework.data.annotation.Id</code>) maps to the <code>_id</code> field.</p>
</li>
<li>
<p>A property or field without an annotation but named <code>id</code> maps to the <code>_id</code> field.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following outlines what type conversion, if any, is done on the property mapped to the <code>_id</code> document field when using the <code>MappingMongoConverter</code> (the default for <code>MongoTemplate</code>).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If possible, an <code>id</code> property or field declared as a <code>String</code> in the Java class is converted to and stored as an <code>ObjectId</code> by using a Spring <code>Converter&lt;String, ObjectId&gt;</code>. Valid conversion rules are delegated to the MongoDB Java driver. If it cannot be converted to an <code>ObjectId</code>, then the value is stored as a string in the database.</p>
</li>
<li>
<p>An <code>id</code> property or field declared as <code>BigInteger</code> in the Java class is converted to and stored as an <code>ObjectId</code> by using a Spring <code>Converter&lt;BigInteger, ObjectId&gt;</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If no field or property specified in the previous sets of rules is present in the Java class, an implicit <code>_id</code> file is generated by the driver but not mapped to a property or field of the Java class.</p>
</div>
<div class="paragraph">
<p>When querying and updating, <code>MongoTemplate</code> uses the converter that corresponds to the preceding rules for saving documents so that field names and types used in your queries can match what is in your domain classes.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.type-mapping"><a class="anchor" href="#mongo-template.type-mapping"></a>10.5.2. Type Mapping</h4>
<div class="paragraph">
<p>MongoDB collections can contain documents that represent instances of a variety of types. This feature can be useful if you store a hierarchy of classes or have a class with a property of type <code>Object</code>. In the latter case, the values held inside that property have to be read in correctly when retrieving the object. Thus, we need a mechanism to store type information alongside the actual document.</p>
</div>
<div class="paragraph">
<p>To achieve that, the <code>MappingMongoConverter</code> uses a <code>MongoTypeMapper</code> abstraction with <code>DefaultMongoTypeMapper</code> as its main implementation. Its default behavior to store the fully qualified classname under <code>_class</code> inside the document for thetop-level document as well as for every value (if itis a complex type and a subtype of the declaredproperty type ). The following example (with a JSON representation at the end) shows how the mapping works:</p>
</div>
<div class="exampleblock">
<div class="title">Example 49. Type mapping</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class Sample {
  Contact value;
}

public abstract class Contact { … }

public class Person extends Contact { … }

Sample sample = new Sample();
sample.value = new Person();

mongoTemplate.save(sample);

{ "_class" : "com.acme.Sample",
  "value" : { "_class" : "com.acme.Person" }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As you can see we store the type information for the actual root class persistent as well as for the nested type as it is complex and a subtype of <code>Contact</code>. So if you&#8217;re now using <code>mongoTemplate.findAll(Object.class, "sample")</code> we are able to find out that the document stored shall be a <code>Sample</code> instance. We are also able to find out that the value property shall be a <code>Person</code> actually.</p>
</div>
<div class="sect4">
<h5 id="_customizing_type_mapping"><a class="anchor" href="#_customizing_type_mapping"></a>Customizing Type Mapping</h5>
<div class="paragraph">
<p>If you want to avoid writing the entire Java class name as type information but would rather like to use a key, you can use the <code>@TypeAlias</code> annotation on the entity class. If you need to customize the mapping even more, have a look at the <code>TypeInformationMapper</code> interface. An instance of that interface can be configured at the <code>DefaultMongoTypeMapper</code>, which can, in turn, be configured on <code>MappingMongoConverter</code>. The following example shows how to define a type alias for an entity:</p>
</div>
<div class="exampleblock">
<div class="title">Example 50. Defining a type alias for an Entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@TypeAlias("pers")
class Person {

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that the resulting document contains <code>pers</code> as the value in the <code>_class</code> Field.</p>
</div>
</div>
<div class="sect4">
<h5 id="_configuring_custom_type_mapping"><a class="anchor" href="#_configuring_custom_type_mapping"></a>Configuring Custom Type Mapping</h5>
<div class="paragraph">
<p>The following example shows how to configure a custom <code>MongoTypeMapper</code> in <code>MappingMongoConverter</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 51. Configuring a custom <code>MongoTypeMapper</code> with Spring Java Config</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class CustomMongoTypeMapper extends DefaultMongoTypeMapper {
  //implement custom type mapping here
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
class SampleMongoConfiguration extends AbstractMongoConfiguration {

  @Override
  protected String getDatabaseName() {
    return "database";
  }

  @Override
  public Mongo mongo() throws Exception {
    return new Mongo();
  }

  @Bean
  @Override
  public MappingMongoConverter mappingMongoConverter() throws Exception {
    MappingMongoConverter mmc = super.mappingMongoConverter();
    mmc.setTypeMapper(customTypeMapper());
    return mmc;
  }

  @Bean
  public MongoTypeMapper customTypeMapper() {
    return new CustomMongoTypeMapper();
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that the preceding example extends the <code>AbstractMongoConfiguration</code> class and overrides the bean definition of the <code>MappingMongoConverter</code> where we configured our custom <code>MongoTypeMapper</code>.</p>
</div>
<div class="paragraph">
<p>The following example shows how to use XML to configure a custom <code>MongoTypeMapper</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 52. Configuring a custom <code>MongoTypeMapper</code> with XML</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;mongo:mapping-converter type-mapper-ref="customMongoTypeMapper"/&gt;

&lt;bean name="customMongoTypeMapper" class="com.bubu.mongo.CustomMongoTypeMapper"/&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.save-insert"><a class="anchor" href="#mongo-template.save-insert"></a>10.5.3. Methods for Saving and Inserting Documents</h4>
<div class="paragraph">
<p>There are several convenient methods on <code>MongoTemplate</code> for saving and inserting your objects. To have more fine-grained control over the conversion process, you can register Spring converters with the <code>MappingMongoConverter</code>&#8201;&#8212;&#8201;for example <code>Converter&lt;Person, DBObject&gt;</code> and <code>Converter&lt;DBObject, Person&gt;</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The difference between insert and save operations is that a save operation performs an insert if the object is not already present.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The simple case of using the save operation is to save a POJO. In this case, the collection name is determined by name (not fully qualified) of the class. You may also call the save operation with a specific collection name. You can use mapping metadata to override the collection in which to store the object.</p>
</div>
<div class="paragraph">
<p>When inserting or saving, if the <code>Id</code> property is not set, the assumption is that its value will be auto-generated by the database. Consequently, for auto-generation of an <code>ObjectId</code> to succeed, the type of the <code>Id</code> property or field in your class must be a <code>String</code>, an <code>ObjectId</code>, or a <code>BigInteger</code>.</p>
</div>
<div class="paragraph">
<p>The following example shows how to save a document and retrieving its contents:</p>
</div>
<div class="exampleblock">
<div class="title">Example 53. Inserting and retrieving documents using the MongoTemplate</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import static org.springframework.data.mongodb.core.query.Criteria.where;
import static org.springframework.data.mongodb.core.query.Criteria.query;
…

Person p = new Person("Bob", 33);
mongoTemplate.insert(p);

Person qp = mongoTemplate.findOne(query(where("age").is(33)), Person.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following insert and save operations are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>void</code> <strong>save</strong> <code>(Object objectToSave)</code>: Save the object to the default collection.</p>
</li>
<li>
<p><code>void</code> <strong>save</strong> <code>(Object objectToSave, String collectionName)</code>: Save the object to the specified collection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A similar set of insert operations is also available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>void</code> <strong>insert</strong> <code>(Object objectToSave)</code>: Insert the object to the default collection.</p>
</li>
<li>
<p><code>void</code> <strong>insert</strong> <code>(Object objectToSave, String collectionName)</code>: Insert the object to the specified collection.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="mongo-template.save-insert.collection"><a class="anchor" href="#mongo-template.save-insert.collection"></a>Into Which Collection Are My Documents Saved?</h5>
<div class="paragraph">
<p>There are two ways to manage the collection name that is used for the documents. The default collection name that is used is the class name changed to start with a lower-case letter. So a <code>com.test.Person</code> class is stored in the <code>person</code> collection. You can customize this by providing a different collection name with the <code>@Document</code> annotation. You can also override the collection name by providing your own collection name as the last parameter for the selected <code>MongoTemplate</code> method calls.</p>
</div>
</div>
<div class="sect4">
<h5 id="mongo-template.save-insert.individual"><a class="anchor" href="#mongo-template.save-insert.individual"></a>Inserting or Saving Individual Objects</h5>
<div class="paragraph">
<p>The MongoDB driver supports inserting a collection of documents in a single operation. The following methods in the <code>MongoOperations</code> interface support this functionality:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>insert</strong>: Inserts an object. If there is an existing document with the same <code>id</code>, an error is generated.</p>
</li>
<li>
<p><strong>insertAll</strong>: Takes a <code>Collection</code> of objects as the first parameter. This method inspects each object and inserts it into the appropriate collection, based on the rules specified earlier.</p>
</li>
<li>
<p><strong>save</strong>: Saves the object, overwriting any object that might have the same <code>id</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="mongo-template.save-insert.batch"><a class="anchor" href="#mongo-template.save-insert.batch"></a>Inserting Several Objects in a Batch</h5>
<div class="paragraph">
<p>The MongoDB driver supports inserting a collection of documents in one operation. The following methods in the <code>MongoOperations</code> interface support this functionality:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>insert</strong> methods: Take a <code>Collection</code> as the first argument. They insert a list of objects in a single batch write to the database.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongodb-template-update"><a class="anchor" href="#mongodb-template-update"></a>10.5.4. Updating Documents in a Collection</h4>
<div class="paragraph">
<p>For updates, you can update the first document found by using <code>MongoOperation.updateFirst</code> or you can update all documents that were found to match the query by using the <code>MongoOperation.updateMulti</code> method. The following example shows an update of all <code>SAVINGS</code> accounts where we are adding a one-time $50.00 bonus to the balance by using the <code>$inc</code> operator:</p>
</div>
<div class="exampleblock">
<div class="title">Example 54. Updating documents by using the <code>MongoTemplate</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import static org.springframework.data.mongodb.core.query.Criteria.where;
import static org.springframework.data.mongodb.core.query.Query;
import static org.springframework.data.mongodb.core.query.Update;

...

WriteResult wr = mongoTemplate.updateMulti(new Query(where("accounts.accountType").is(Account.Type.SAVINGS)),
  new Update().inc("accounts.$.balance", 50.00), Account.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In addition to the <code>Query</code> discussed earlier, we provide the update definition by using an <code>Update</code> object. The <code>Update</code> class has methods that match the update modifiers available for MongoDB.</p>
</div>
<div class="paragraph">
<p>Most methods return the <code>Update</code> object to provide a fluent style for the API.</p>
</div>
<div class="sect4">
<h5 id="mongodb-template-update.methods"><a class="anchor" href="#mongodb-template-update.methods"></a>Methods for Executing Updates for Documents</h5>
<div class="ulist">
<ul>
<li>
<p><strong>updateFirst</strong>: Updates the first document that matches the query document criteria with the updated document.</p>
</li>
<li>
<p><strong>updateMulti</strong>: Updates all objects that match the query document criteria with the updated document.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="mongodb-template-update.update"><a class="anchor" href="#mongodb-template-update.update"></a>Methods in the <code>Update</code> Class</h5>
<div class="paragraph">
<p>You can use a little "'syntax sugar'" with the <code>Update</code> class, as its methods are meant to be chained together. Also, you can kick-start the creation of a new <code>Update</code> instance by using <code>public static Update update(String key, Object value)</code> and using static imports.</p>
</div>
<div class="paragraph">
<p>The <code>Update</code> class contains the following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Update</code> <strong>addToSet</strong> <code>(String key, Object value)</code> Update using the <code>$addToSet</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>currentDate</strong> <code>(String key)</code> Update using the <code>$currentDate</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>currentTimestamp</strong> <code>(String key)</code> Update using the <code>$currentDate</code> update modifier with <code>$type</code> <code>timestamp</code></p>
</li>
<li>
<p><code>Update</code> <strong>inc</strong> <code>(String key, Number inc)</code> Update using the <code>$inc</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>max</strong> <code>(String key, Object max)</code> Update using the <code>$max</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>min</strong> <code>(String key, Object min)</code> Update using the <code>$min</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>multiply</strong> <code>(String key, Number multiplier)</code> Update using the <code>$mul</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>pop</strong> <code>(String key, Update.Position pos)</code> Update using the <code>$pop</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>pull</strong> <code>(String key, Object value)</code> Update using the <code>$pull</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>pullAll</strong> <code>(String key, Object[] values)</code> Update using the <code>$pullAll</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>push</strong> <code>(String key, Object value)</code> Update using the <code>$push</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>pushAll</strong> <code>(String key, Object[] values)</code> Update using the <code>$pushAll</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>rename</strong> <code>(String oldName, String newName)</code> Update using the <code>$rename</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>set</strong> <code>(String key, Object value)</code> Update using the <code>$set</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>setOnInsert</strong> <code>(String key, Object value)</code> Update using the <code>$setOnInsert</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>unset</strong> <code>(String key)</code> Update using the <code>$unset</code> update modifier</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some update modifiers, such as <code>$push</code> and <code>$addToSet</code>, allow nesting of additional operators.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>// { $push : { "category" : { "$each" : [ "spring" , "data" ] } } }
new Update().push("category").each("spring", "data")

// { $push : { "key" : { "$position" : 0 , "$each" : [ "Arya" , "Arry" , "Weasel" ] } } }
new Update().push("key").atPosition(Position.FIRST).each(Arrays.asList("Arya", "Arry", "Weasel"));

// { $push : { "key" : { "$slice" : 5 , "$each" : [ "Arya" , "Arry" , "Weasel" ] } } }
new Update().push("key").slice(5).each(Arrays.asList("Arya", "Arry", "Weasel"));

// { $addToSet : { "values" : { "$each" : [ "spring" , "data" , "mongodb" ] } } }
new Update().addToSet("values").each("spring", "data", "mongodb");</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.upserts"><a class="anchor" href="#mongo-template.upserts"></a>10.5.5. &#8220;Upserting&#8221; Documents in a Collection</h4>
<div class="paragraph">
<p>Related to performing an <code>updateFirst</code> operation, you can also perform an &#8220;upsert&#8221; operation, which will perform an insert if no document is found that matches the query. The document that is inserted is a combination of the query document and the update document. The following example shows how to use the <code>upsert</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>template.upsert(query(where("ssn").is(1111).and("firstName").is("Joe").and("Fraizer").is("Update")), update("address", addr), Person.class);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.find-and-upsert"><a class="anchor" href="#mongo-template.find-and-upsert"></a>10.5.6. Finding and Upserting Documents in a Collection</h4>
<div class="paragraph">
<p>The <code>findAndModify(…)</code> method on <code>DBCollection</code> can update a document and return either the old or newly updated document in a single operation. <code>MongoTemplate</code> provides four <code>findAndModify</code> overloaded methods that take <code>Query</code> and <code>Update</code> classes and converts from <code>DBObject</code> to your POJOs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">&lt;T&gt; T findAndModify(Query query, Update update, Class&lt;T&gt; entityClass);

&lt;T&gt; T findAndModify(Query query, Update update, Class&lt;T&gt; entityClass, String collectionName);

&lt;T&gt; T findAndModify(Query query, Update update, FindAndModifyOptions options, Class&lt;T&gt; entityClass);

&lt;T&gt; T findAndModify(Query query, Update update, FindAndModifyOptions options, Class&lt;T&gt; entityClass, String collectionName);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example inserts a few <code>Person</code> objects into the container and performs a <code>findAndUpdate</code> operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">mongoTemplate.insert(new Person("Tom", 21));
mongoTemplate.insert(new Person("Dick", 22));
mongoTemplate.insert(new Person("Harry", 23));

Query query = new Query(Criteria.where("firstName").is("Harry"));
Update update = new Update().inc("age", 1);
Person p = mongoTemplate.findAndModify(query, update, Person.class); // return's old person object

assertThat(p.getFirstName(), is("Harry"));
assertThat(p.getAge(), is(23));
p = mongoTemplate.findOne(query, Person.class);
assertThat(p.getAge(), is(24));

// Now return the newly updated document when updating
p = template.findAndModify(query, update, new FindAndModifyOptions().returnNew(true), Person.class);
assertThat(p.getAge(), is(25));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>FindAndModifyOptions</code> method lets you set the options of <code>returnNew</code>, <code>upsert</code>, and <code>remove</code>. An example extending from the previous code snippet follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Query query2 = new Query(Criteria.where("firstName").is("Mary"));
p = mongoTemplate.findAndModify(query2, update, new FindAndModifyOptions().returnNew(true).upsert(true), Person.class);
assertThat(p.getFirstName(), is("Mary"));
assertThat(p.getAge(), is(1));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.delete"><a class="anchor" href="#mongo-template.delete"></a>10.5.7. Methods for Removing Documents</h4>
<div class="paragraph">
<p>You can use one of five overloaded methods to remove an object from the database:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">template.remove(tywin, "GOT");                                              <i class="conum" data-value="1"></i><b>(1)</b>

template.remove(query(where("lastname").is("lannister")), "GOT");           <i class="conum" data-value="2"></i><b>(2)</b>

template.remove(new Query().limit(3), "GOT");                               <i class="conum" data-value="3"></i><b>(3)</b>

template.findAllAndRemove(query(where("lastname").is("lannister"), "GOT");  <i class="conum" data-value="4"></i><b>(4)</b>

template.findAllAndRemove(new Query().limit(3), "GOT");                     <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Remove a single entity specified by its <code>_id</code> from the associated collection.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Remove all documents that match the criteria of the query from the <code>GOT</code> collection.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Remove the first three documents in the <code>GOT</code> collection. Unlike &lt;2&gt;, the documents to remove are identified by their <code>_id</code>, executing the given query, applying <code>sort</code>, <code>limit</code>, and <code>skip</code> options first, and then removing all at once in a separate step.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Remove all documents matching the criteria of the query from the <code>GOT</code> collection. Unlike &lt;3&gt;, documents do not get deleted in a batch but one by one.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Remove the first three documents in the <code>GOT</code> collection. Unlike &lt;3&gt;, documents do not get deleted in a batch but one by one.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.optimistic-locking"><a class="anchor" href="#mongo-template.optimistic-locking"></a>10.5.8. Optimistic Locking</h4>
<div class="paragraph">
<p>The <code>@Version</code> annotation provides syntax similar to that of JPA in the context of MongoDB and makes sure updates are only applied to documents with a matching version. Therefore, the actual value of the version property is added to the update query in such a way that the update does not have any effect if another operation altered the document in the meantime. In that case, an <code>OptimisticLockingFailureException</code> is thrown. The following example shows these features:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Document
class Person {

  @Id String id;
  String firstname;
  String lastname;
  @Version Long version;
}

Person daenerys = template.insert(new Person("Daenerys"));                            <i class="conum" data-value="1"></i><b>(1)</b>

Person tmp = template.findOne(query(where("id").is(daenerys.getId())), Person.class); <i class="conum" data-value="2"></i><b>(2)</b>

daenerys.setLastname("Targaryen");
template.save(daenerys);                                                              <i class="conum" data-value="3"></i><b>(3)</b>

template.save(tmp); // throws OptimisticLockingFailureException                       <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Intially insert document. <code>version</code> is set to <code>0</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Load the just inserted document. <code>version</code> is still <code>0</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Update the document with <code>version = 0</code>. Set the <code>lastname</code> and bump <code>version</code> to <code>1</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Try to update the previously loaded document that still has <code>version = 0</code>. The operation fails with an <code>OptimisticLockingFailureException</code>, as the current <code>version</code> is <code>1</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Optimistic Locking requires to set the <code>WriteConcern</code> to <code>ACKNOWLEDGED</code>. Otherwise <code>OptimisticLockingFailureException</code> can be silently swallowed.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.query"><a class="anchor" href="#mongo.query"></a>10.6. Querying Documents</h3>
<div class="paragraph">
<p>You can use the <code>Query</code> and <code>Criteria</code> classes to express your queries. They have method names that mirror the native MongoDB operator names, such as <code>lt</code>, <code>lte</code>, <code>is</code>, and others. The <code>Query</code> and <code>Criteria</code> classes follow a fluent API style so that you can chain together multiple method criteria and queries while having easy-to-understand code. To improve readability, static imports let you avoid using the 'new' keyword for creating <code>Query</code> and <code>Criteria</code> instances. You can also use <code>BasicQuery</code> to create <code>Query</code> instances from plain JSON Strings, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 55. Creating a Query instance from a plain JSON String</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">BasicQuery query = new BasicQuery("{ age : { $lt : 50 }, accounts.balance : { $gt : 1000.00 }}");
List&lt;Person&gt; result = mongoTemplate.find(query, Person.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Spring MongoDB also supports GeoSpatial queries (see the <a href="#mongo.geospatial">GeoSpatial Queries</a> section) and Map-Reduce operations (see the <a href="#mongo.mapreduce">Map-Reduce</a> section.).</p>
</div>
<div class="sect3">
<h4 id="mongodb-template-query"><a class="anchor" href="#mongodb-template-query"></a>10.6.1. Querying Documents in a Collection</h4>
<div class="paragraph">
<p>Earlier, we saw how to retrieve a single document by using the <code>findOne</code> and <code>findById</code> methods on <code>MongoTemplate</code>. These methods return a single domain object. We can also query for a collection of documents to be returned as a list of domain objects. Assuming that we have a number of <code>Person</code> objects with name and age stored as documents in a collection and that each person has an embedded account document with a balance, we can now run a query using the following code:</p>
</div>
<div class="exampleblock">
<div class="title">Example 56. Querying for documents using the MongoTemplate</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import static org.springframework.data.mongodb.core.query.Criteria.where;
import static org.springframework.data.mongodb.core.query.Query.query;

…

List&lt;Person&gt; result = mongoTemplate.find(query(where("age").lt(50)
  .and("accounts.balance").gt(1000.00d)), Person.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>All find methods take a <code>Query</code> object as a parameter. This object defines the criteria and options used to perform the query. The criteria are specified by using a <code>Criteria</code> object that has a static factory method named <code>where</code> to instantiate a new <code>Criteria</code> object. We recommend using static imports for <code>org.springframework.data.mongodb.core.query.Criteria.where</code> and <code>Query.query</code> to make the query more readable.</p>
</div>
<div class="paragraph">
<p>The query should return a list of <code>Person</code> objects that meet the specified criteria. The rest of this section lists the methods of the <code>Criteria</code> and <code>Query</code> classes that correspond to the operators provided in MongoDB. Most methods return the <code>Criteria</code> object, to provide a fluent style for the API.</p>
</div>
<div class="sect4">
<h5 id="mongodb-template-query.criteria"><a class="anchor" href="#mongodb-template-query.criteria"></a>Methods for the Criteria Class</h5>
<div class="paragraph">
<p>The <code>Criteria</code> class provides the following methods, all of which correspond to operators in MongoDB:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Criteria</code> <strong>all</strong> <code>(Object o)</code> Creates a criterion using the <code>$all</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>and</strong> <code>(String key)</code> Adds a chained <code>Criteria</code> with the specified <code>key</code> to the current <code>Criteria</code> and returns the newly created one</p>
</li>
<li>
<p><code>Criteria</code> <strong>andOperator</strong> <code>(Criteria&#8230;&#8203; criteria)</code> Creates an and query using the <code>$and</code> operator for all of the provided criteria (requires MongoDB 2.0 or later)</p>
</li>
<li>
<p><code>Criteria</code> <strong>elemMatch</strong> <code>(Criteria c)</code> Creates a criterion using the <code>$elemMatch</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>exists</strong> <code>(boolean b)</code> Creates a criterion using the <code>$exists</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>gt</strong> <code>(Object o)</code> Creates a criterion using the <code>$gt</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>gte</strong> <code>(Object o)</code> Creates a criterion using the <code>$gte</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>in</strong> <code>(Object&#8230;&#8203; o)</code> Creates a criterion using the <code>$in</code> operator for a varargs argument.</p>
</li>
<li>
<p><code>Criteria</code> <strong>in</strong> <code>(Collection&lt;?&gt; collection)</code> Creates a criterion using the <code>$in</code> operator using a collection</p>
</li>
<li>
<p><code>Criteria</code> <strong>is</strong> <code>(Object o)</code> Creates a criterion using the <code>$is</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>lt</strong> <code>(Object o)</code> Creates a criterion using the <code>$lt</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>lte</strong> <code>(Object o)</code> Creates a criterion using the <code>$lte</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>mod</strong> <code>(Number value, Number remainder)</code> Creates a criterion using the <code>$mod</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>ne</strong> <code>(Object o)</code> Creates a criterion using the <code>$ne</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>nin</strong> <code>(Object&#8230;&#8203; o)</code> Creates a criterion using the <code>$nin</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>norOperator</strong> <code>(Criteria&#8230;&#8203; criteria)</code> Creates an nor query using the <code>$nor</code> operator for all of the provided criteria</p>
</li>
<li>
<p><code>Criteria</code> <strong>not</strong> <code>()</code> Creates a criterion using the <code>$not</code> meta operator which affects the clause directly following</p>
</li>
<li>
<p><code>Criteria</code> <strong>orOperator</strong> <code>(Criteria&#8230;&#8203; criteria)</code> Creates an or query using the <code>$or</code> operator for all of the provided criteria</p>
</li>
<li>
<p><code>Criteria</code> <strong>regex</strong> <code>(String re)</code> Creates a criterion using a <code>$regex</code></p>
</li>
<li>
<p><code>Criteria</code> <strong>size</strong> <code>(int s)</code> Creates a criterion using the <code>$size</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>type</strong> <code>(int t)</code> Creates a criterion using the <code>$type</code> operator</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Criteria class also provides the following methods for geospatial queries (see the <a href="#mongo.geospatial">GeoSpatial Queries</a> section to see them in action):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Criteria</code> <strong>within</strong> <code>(Circle circle)</code> Creates a geospatial criterion using <code>$geoWithin $center</code> operators.</p>
</li>
<li>
<p><code>Criteria</code> <strong>within</strong> <code>(Box box)</code> Creates a geospatial criterion using a <code>$geoWithin $box</code> operation.</p>
</li>
<li>
<p><code>Criteria</code> <strong>withinSphere</strong> <code>(Circle circle)</code> Creates a geospatial criterion using <code>$geoWithin $center</code> operators.</p>
</li>
<li>
<p><code>Criteria</code> <strong>near</strong> <code>(Point point)</code> Creates a geospatial criterion using a <code>$near</code> operation</p>
</li>
<li>
<p><code>Criteria</code> <strong>nearSphere</strong> <code>(Point point)</code> Creates a geospatial criterion using <code>$nearSphere$center</code> operations. This is only available for MongoDB 1.7 and higher.</p>
</li>
<li>
<p><code>Criteria</code> <strong>minDistance</strong> <code>(double minDistance)</code> Creates a geospatial criterion using the <code>$minDistance</code> operation, for use with $near.</p>
</li>
<li>
<p><code>Criteria</code> <strong>maxDistance</strong> <code>(double maxDistance)</code> Creates a geospatial criterion using the <code>$maxDistance</code> operation, for use with $near.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="mongodb-template-query.query"><a class="anchor" href="#mongodb-template-query.query"></a>Methods for the Query class</h5>
<div class="paragraph">
<p>The <code>Query</code> class has some additional methods that provide options for the query:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Query</code> <strong>addCriteria</strong> <code>(Criteria criteria)</code> used to add additional criteria to the query</p>
</li>
<li>
<p><code>Field</code> <strong>fields</strong> <code>()</code> used to define fields to be included in the query results</p>
</li>
<li>
<p><code>Query</code> <strong>limit</strong> <code>(int limit)</code> used to limit the size of the returned results to the provided limit (used for paging)</p>
</li>
<li>
<p><code>Query</code> <strong>skip</strong> <code>(int skip)</code> used to skip the provided number of documents in the results (used for paging)</p>
</li>
<li>
<p><code>Query</code> <strong>with</strong> <code>(Sort sort)</code> used to provide sort definition for the results</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.querying"><a class="anchor" href="#mongo-template.querying"></a>10.6.2. Methods for Querying for Documents</h4>
<div class="paragraph">
<p>The query methods need to specify the target type <code>T</code> that is returned, and they are overloaded with an explicit collection name for queries that should operate on a collection other than the one indicated by the return type. The following query methods let you find one or more documents:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>findAll</strong>: Query for a list of objects of type <code>T</code> from the collection.</p>
</li>
<li>
<p><strong>findOne</strong>: Map the results of an ad-hoc query on the collection to a single instance of an object of the specified type.</p>
</li>
<li>
<p><strong>findById</strong>: Return an object of the given ID and target class.</p>
</li>
<li>
<p><strong>find</strong>: Map the results of an ad-hoc query on the collection to a <code>List</code> of the specified type.</p>
</li>
<li>
<p><strong>findAndRemove</strong>: Map the results of an ad-hoc query on the collection to a single instance of an object of the specified type. The first document that matches the query is returned and removed from the collection in the database.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="mongo.geospatial"><a class="anchor" href="#mongo.geospatial"></a>10.6.3. GeoSpatial Queries</h4>
<div class="paragraph">
<p>MongoDB supports GeoSpatial queries through the use of operators such as <code>$near</code>, <code>$within</code>, <code>geoWithin</code>, and <code>$nearSphere</code>. Methods specific to geospatial queries are available on the <code>Criteria</code> class. There are also a few shape classes (<code>Box</code>, <code>Circle</code>, and <code>Point</code>) that are used in conjunction with geospatial related <code>Criteria</code> methods.</p>
</div>
<div class="paragraph">
<p>To understand how to perform GeoSpatial queries, consider the following <code>Venue</code> class (taken from the integration tests and relying on the rich <code>MappingMongoConverter</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Document(collection="newyork")
public class Venue {

  @Id
  private String id;
  private String name;
  private double[] location;

  @PersistenceConstructor
  Venue(String name, double[] location) {
    super();
    this.name = name;
    this.location = location;
  }

  public Venue(String name, double x, double y) {
    super();
    this.name = name;
    this.location = new double[] { x, y };
  }

  public String getName() {
    return name;
  }

  public double[] getLocation() {
    return location;
  }

  @Override
  public String toString() {
    return "Venue [id=" + id + ", name=" + name + ", location="
        + Arrays.toString(location) + "]";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find locations within a <code>Circle</code>, you can use the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Circle circle = new Circle(-73.99171, 40.738868, 0.01);
List&lt;Venue&gt; venues =
    template.find(new Query(Criteria.where("location").within(circle)), Venue.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find venues within a <code>Circle</code> using spherical coordinates, you can use the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Circle circle = new Circle(-73.99171, 40.738868, 0.003712240453784);
List&lt;Venue&gt; venues =
    template.find(new Query(Criteria.where("location").withinSphere(circle)), Venue.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find venues within a <code>Box</code>, you can use the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">//lower-left then upper-right
Box box = new Box(new Point(-73.99756, 40.73083), new Point(-73.988135, 40.741404));
List&lt;Venue&gt; venues =
    template.find(new Query(Criteria.where("location").within(box)), Venue.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find venues near a <code>Point</code>, you can use the following queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Point point = new Point(-73.99171, 40.738868);
List&lt;Venue&gt; venues =
    template.find(new Query(Criteria.where("location").near(point).maxDistance(0.01)), Venue.class);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Point point = new Point(-73.99171, 40.738868);
List&lt;Venue&gt; venues =
    template.find(new Query(Criteria.where("location").near(point).minDistance(0.01).maxDistance(100)), Venue.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find venues near a <code>Point</code> using spherical coordinates, you can use the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Point point = new Point(-73.99171, 40.738868);
List&lt;Venue&gt; venues =
    template.find(new Query(
        Criteria.where("location").nearSphere(point).maxDistance(0.003712240453784)),
        Venue.class);</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="mongo.geo-near"><a class="anchor" href="#mongo.geo-near"></a>Geo-near Queries</h5>
<div class="paragraph">
<p>MongoDB supports querying the database for geo locations and calculating the distance from a given origin at the same time. With geo-near queries, you can express queries such as "find all restaurants in the surrounding 10 miles". To let you do so, <code>MongoOperations</code> provides <code>geoNear(…)</code> methods that take a <code>NearQuery</code> as an argument (as well as the already familiar entity type and collection), as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Point location = new Point(-73.99171, 40.738868);
NearQuery query = NearQuery.near(location).maxDistance(new Distance(10, Metrics.MILES));

GeoResults&lt;Restaurant&gt; = operations.geoNear(query, Restaurant.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use the <code>NearQuery</code> builder API to set up a query to return all <code>Restaurant</code> instances surrounding the given <code>Point</code> out to 10 miles. The <code>Metrics</code> enum used here actually implements an interface so that other metrics could be plugged into a distance as well. A <code>Metric</code> is backed by a multiplier to transform the distance value of the given metric into native distances. The sample shown here would consider the 10 to be miles. Using one of the built-in metrics (miles and kilometers) automatically triggers the spherical flag to be set on the query. If you want to avoid that, pass plain <code>double</code> values into <code>maxDistance(…)</code>. For more information, see the <a href="https://docs.spring.io/spring-data/mongodb/docs/1.10.18.RELEASE/api/index.html">JavaDoc</a> of <code>NearQuery</code> and <code>Distance</code>.</p>
</div>
<div class="paragraph">
<p>The geo-near operations return a <code>GeoResults</code> wrapper object that encapsulates <code>GeoResult</code> instances. Wrapping <code>GeoResults</code> allows accessing the average distance of all results. A single <code>GeoResult</code> object carries the entity found plus its distance from the origin.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.geo-json"><a class="anchor" href="#mongo.geo-json"></a>10.6.4. GeoJSON Support</h4>
<div class="paragraph">
<p>MongoDB supports <a href="http://geojson.org/">GeoJSON</a> and simple (legacy) coordinate pairs for geospatial data. Those formats can both be used for storing as well as querying data. See the <a href="http://docs.mongodb.org/manual/core/2dsphere/#geospatial-indexes-store-geojson/">MongoDB manual on GeoJSON support</a> to learn about requirements and restrictions.</p>
</div>
<div class="sect4">
<h5 id="_geojson_types_in_domain_classes"><a class="anchor" href="#_geojson_types_in_domain_classes"></a>GeoJSON Types in Domain Classes</h5>
<div class="paragraph">
<p>Usage of <a href="http://geojson.org/">GeoJSON</a> types in domain classes is straightforward. The <code>org.springframework.data.mongodb.core.geo</code> package contains types such as <code>GeoJsonPoint</code>, <code>GeoJsonPolygon</code>, and others. These types are extend the existing <code>org.springframework.data.geo</code> types. The following example uses a <code>GeoJsonPoint</code>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class Store {

	String id;

	/**
	 * location is stored in GeoJSON format.
	 * {
	 *   "type" : "Point",
	 *   "coordinates" : [ x, y ]
	 * }
	 */
	GeoJsonPoint location;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_geojson_types_in_repository_query_methods"><a class="anchor" href="#_geojson_types_in_repository_query_methods"></a>GeoJSON Types in Repository Query Methods</h5>
<div class="paragraph">
<p>Using GeoJSON types as repository query parameters forces usage of the <code>$geometry</code> operator when creating the query, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface StoreRepository extends CrudRepository&lt;Store, String&gt; {

	List&lt;Store&gt; findByLocationWithin(Polygon polygon);  <i class="conum" data-value="1"></i><b>(1)</b>

}

/*
 * {
 *   "location": {
 *     "$geoWithin": {
 *       "$geometry": {
 *         "type": "Polygon",
 *         "coordinates": [
 *           [
 *             [-73.992514,40.758934],
 *             [-73.961138,40.760348],
 *             [-73.991658,40.730006],
 *             [-73.992514,40.758934]
 *           ]
 *         ]
 *       }
 *     }
 *   }
 * }
 */
repo.findByLocationWithin(                              <i class="conum" data-value="2"></i><b>(2)</b>
  new GeoJsonPolygon(
    new Point(-73.992514, 40.758934),
    new Point(-73.961138, 40.760348),
    new Point(-73.991658, 40.730006),
    new Point(-73.992514, 40.758934)));                 <i class="conum" data-value="3"></i><b>(3)</b>

/*
 * {
 *   "location" : {
 *     "$geoWithin" : {
 *        "$polygon" : [ [-73.992514,40.758934] , [-73.961138,40.760348] , [-73.991658,40.730006] ]
 *     }
 *   }
 * }
 */
repo.findByLocationWithin(                              <i class="conum" data-value="4"></i><b>(4)</b>
  new Polygon(
    new Point(-73.992514, 40.758934),
    new Point(-73.961138, 40.760348),
    new Point(-73.991658, 40.730006));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Repository method definition using the commons type allows calling it with both the GeoJSON and the legacy format.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use GeoJSON type to make use of <code>$geometry</code> operator.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Note that GeoJSON polygons need to define a closed ring.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use the legacy format <code>$polygon</code> operator.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.textsearch"><a class="anchor" href="#mongo.textsearch"></a>10.6.5. Full-text Queries</h4>
<div class="paragraph">
<p>Since version 2.6 of MongoDB, you can run full-text queries by using the <code>$text</code> operator. Methods and operations specific to full-text queries are available in <code>TextQuery</code> and <code>TextCriteria</code>. When doing full text search, see the <a href="http://docs.mongodb.org/manual/reference/operator/query/text/#behavior">MongoDB reference</a> for its behavior and limitations.</p>
</div>
<div class="sect4">
<h5 id="_full_text_search"><a class="anchor" href="#_full_text_search"></a>Full-text Search</h5>
<div class="paragraph">
<p>Before you can actually use full-text search, you must set up the search index correctly. See <a href="#mapping-usage-indexes.text-index">Text Index</a> for more detail on how to create index structures. The following example shows how to set up a full-text search:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">db.foo.createIndex(
{
  title : "text",
  content : "text"
},
{
  weights : {
              title : 3
            }
}
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A query searching for <code>coffee cake</code>, sorted by relevance according to the <code>weights</code>, can be defined and executed as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Query query = TextQuery.searching(new TextCriteria().matchingAny("coffee", "cake")).sortByScore();
List&lt;Document&gt; page = template.find(query, Document.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can exclude search terms by prefixing the term with <code>-</code> or by using <code>notMatching</code>, as shown in the following example (note that the two lines have the same effect and are thus redundant):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">// search for 'coffee' and not 'cake'
TextQuery.searching(new TextCriteria().matching("coffee").matching("-cake"));
TextQuery.searching(new TextCriteria().matching("coffee").notMatching("cake"));</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>TextCriteria.matching</code> takes the provided term as is. Therefore, you can define phrases by putting them between double quotation marks (for example, <code>\"coffee cake\")</code> or using by <code>TextCriteria.phrase.</code> The following example shows both ways of defining a phrase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">// search for phrase 'coffee cake'
TextQuery.searching(new TextCriteria().matching("\"coffee cake\""));
TextQuery.searching(new TextCriteria().phrase("coffee cake"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can set flags for <code>$caseSensitive</code> and <code>$diacriticSensitive</code> by using the corresponding methods on <code>TextCriteria</code>. Note that these two optional flags have been introduced in MongoDB 3.2 and are not included in the query unless explicitly set.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="query-by-example"><a class="anchor" href="#query-by-example"></a>10.7. Query by Example</h3>
<div class="sect3">
<h4 id="query-by-example.introduction"><a class="anchor" href="#query-by-example.introduction"></a>10.7.1. Introduction</h4>
<div class="paragraph">
<p>This chapter provides an introduction to Query by Example and explains how to use it.</p>
</div>
<div class="paragraph">
<p>Query by Example (QBE) is a user-friendly querying technique with a simple interface. It allows dynamic query creation and does not require you to write queries that contain field names. In fact, Query by Example does not require you to write queries by using store-specific query languages at all.</p>
</div>
</div>
<div class="sect3">
<h4 id="query-by-example.usage"><a class="anchor" href="#query-by-example.usage"></a>10.7.2. Usage</h4>
<div class="paragraph">
<p>The Query by Example API consists of three parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Probe: The actual example of a domain object with populated fields.</p>
</li>
<li>
<p><code>ExampleMatcher</code>: The <code>ExampleMatcher</code> carries details on how to match particular fields. It can be reused across multiple Examples.</p>
</li>
<li>
<p><code>Example</code>: An <code>Example</code> consists of the probe and the <code>ExampleMatcher</code>. It is used to create the query.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Query by Example is well suited for several use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Querying your data store with a set of static or dynamic constraints.</p>
</li>
<li>
<p>Frequent refactoring of the domain objects without worrying about breaking existing queries.</p>
</li>
<li>
<p>Working independently from the underlying data store API.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Query by Example also has several limitations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No support for nested or grouped property constraints, such as <code>firstname = ?0 or (firstname = ?1 and lastname = ?2)</code>.</p>
</li>
<li>
<p>Only supports starts/contains/ends/regex matching for strings and exact matching for other property types.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before getting started with Query by Example, you need to have a domain object. To get started, create an interface for your repository, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 57. Sample Person object</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class Person {

  @Id
  private String id;
  private String firstname;
  private String lastname;
  private Address address;

  // … getters and setters omitted
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding example shows a simple domain object. You can use it to create an <code>Example</code>. By default, fields having <code>null</code> values are ignored, and strings are matched by using the store specific defaults. Examples can be built by either using the <code>of</code> factory method or by using <a href="#query-by-example.matcher"><code>ExampleMatcher</code></a>. <code>Example</code> is immutable. The following listing shows a simple Example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 58. Simple Example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Person person = new Person();                         <i class="conum" data-value="1"></i><b>(1)</b>
person.setFirstname("Dave");                          <i class="conum" data-value="2"></i><b>(2)</b>

Example&lt;Person&gt; example = Example.of(person);         <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a new instance of the domain object.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the properties to query.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create the <code>Example</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Examples are ideally be executed with repositories. To do so, let your repository interface extend <code>QueryByExampleExecutor&lt;T&gt;</code>. The following listing shows an excerpt from the <code>QueryByExampleExecutor</code> interface:</p>
</div>
<div class="exampleblock">
<div class="title">Example 59. The <code>QueryByExampleExecutor</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface QueryByExampleExecutor&lt;T&gt; {

  &lt;S extends T&gt; S findOne(Example&lt;S&gt; example);

  &lt;S extends T&gt; Iterable&lt;S&gt; findAll(Example&lt;S&gt; example);

  // … more functionality omitted.
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can read more about <a href="#query-by-example.execution">Query by Example Execution</a> below.</p>
</div>
</div>
<div class="sect3">
<h4 id="query-by-example.matchers"><a class="anchor" href="#query-by-example.matchers"></a>10.7.3. Example Matchers</h4>
<div class="paragraph">
<p>Examples are not limited to default settings. You can specify your own defaults for string matching, null handling, and property-specific settings by using the <code>ExampleMatcher</code>, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 60. Example matcher with customized matching</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Person person = new Person();                          <i class="conum" data-value="1"></i><b>(1)</b>
person.setFirstname("Dave");                           <i class="conum" data-value="2"></i><b>(2)</b>

ExampleMatcher matcher = ExampleMatcher.matching()     <i class="conum" data-value="3"></i><b>(3)</b>
  .withIgnorePaths("lastname")                         <i class="conum" data-value="4"></i><b>(4)</b>
  .withIncludeNullValues()                             <i class="conum" data-value="5"></i><b>(5)</b>
  .withStringMatcherEnding();                          <i class="conum" data-value="6"></i><b>(6)</b>

Example&lt;Person&gt; example = Example.of(person, matcher); <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a new instance of the domain object.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set properties.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create an <code>ExampleMatcher</code> to expect all values to match. It is usable at this stage even without further configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Construct a new <code>ExampleMatcher</code> to ignore the <code>lastname</code> property path.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Construct a new <code>ExampleMatcher</code> to ignore the <code>lastname</code> property path and to include null values.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Construct a new <code>ExampleMatcher</code> to ignore the <code>lastname</code> property path, to include null values, and to perform suffix string matching.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Create a new <code>Example</code> based on the domain object and the configured <code>ExampleMatcher</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>By default, the <code>ExampleMatcher</code> expects all values set on the probe to match. If you want to get results matching any of the predicates defined implicitly, use <code>ExampleMatcher.matchingAny()</code>.</p>
</div>
<div class="paragraph">
<p>You can specify behavior for individual properties (such as "firstname" and "lastname" or, for nested properties, "address.city"). You can tune it with matching options and case sensitivity, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 61. Configuring matcher options</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">ExampleMatcher matcher = ExampleMatcher.matching()
  .withMatcher("firstname", endsWith())
  .withMatcher("lastname", startsWith().ignoreCase());
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Another way to configure matcher options is to use lambdas (introduced in Java 8). This approach creates a callback that asks the implementor to modify the matcher. You need not return the matcher, because configuration options are held within the matcher instance. The following example shows a matcher that uses lambdas:</p>
</div>
<div class="exampleblock">
<div class="title">Example 62. Configuring matcher options with lambdas</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">ExampleMatcher matcher = ExampleMatcher.matching()
  .withMatcher("firstname", match -&gt; match.endsWith())
  .withMatcher("firstname", match -&gt; match.startsWith());
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Queries created by <code>Example</code> use a merged view of the configuration. Default matching settings can be set at the <code>ExampleMatcher</code> level, while individual settings can be applied to particular property paths. Settings that are set on <code>ExampleMatcher</code> are inherited by property path settings unless they are defined explicitly. Settings on a property patch have higher precedence than default settings. The following table describes the scope of the various <code>ExampleMatcher</code> settings:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Scope of <code>ExampleMatcher</code> settings</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Setting</th>
<th class="tableblock halign-left valign-top">Scope</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null-handling</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ExampleMatcher</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">String matching</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ExampleMatcher</code> and property path</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ignoring properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property path</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Case sensitivity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ExampleMatcher</code> and property path</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value transformation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property path</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="query-by-example.execution"><a class="anchor" href="#query-by-example.execution"></a>10.7.4. Running an Example</h4>
<div class="paragraph">
<p>The following example shows how to query by example when using a repository (of <code>Person</code> objects, in this case):</p>
</div>
<div class="exampleblock">
<div class="title">Example 63. Query by Example using a repository</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface PersonRepository extends QueryByExampleExecutor&lt;Person&gt; {

}

public class PersonService {

  @Autowired PersonRepository personRepository;

  public List&lt;Person&gt; findPeople(Person probe) {
    return personRepository.findAll(Example.of(probe));
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>An <code>Example</code> containing an untyped <code>ExampleSpec</code> uses the Repository type and its collection name. Typed <code>ExampleSpec</code> instances use their type as the result type and the collection name from the <code>Repository</code> instance.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When including <code>null</code> values in the <code>ExampleSpec</code>, Spring Data Mongo uses embedded document matching instead of dot notation property matching. Doing so forces exact document matching for all property values and the property order in the embedded document.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring Data MongoDB provides support for the following matching options:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. <code>StringMatcher</code> options</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Matching</th>
<th class="tableblock halign-left valign-top">Logical result</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DEFAULT</code> (case-sensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : firstname}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DEFAULT</code> (case-insensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: firstname, $options: 'i'}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EXACT</code> (case-sensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /^firstname$/}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EXACT</code> (case-insensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /^firstname$/, $options: 'i'}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>STARTING</code> (case-sensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /^firstname/}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>STARTING</code> (case-insensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /^firstname/, $options: 'i'}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ENDING</code> (case-sensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /firstname$/}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ENDING</code> (case-insensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /firstname$/, $options: 'i'}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CONTAINING</code> (case-sensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /.*firstname.*/}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CONTAINING</code> (case-insensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /.*firstname.*/, $options: 'i'}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REGEX</code> (case-sensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /firstname/}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REGEX</code> (case-insensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /firstname/, $options: 'i'}}</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mongo.mapreduce"><a class="anchor" href="#mongo.mapreduce"></a>10.8. Map-Reduce Operations</h3>
<div class="paragraph">
<p>You can query MongoDB by using Map-Reduce, which is useful for batch processing, for data aggregation, and for when the query language does not fulfill your needs.</p>
</div>
<div class="paragraph">
<p>Spring provides integration with MongoDB&#8217;s Map-Reduce by providing methods on <code>MongoOperations</code> to simplify the creation and execution of Map-Reduce operations. It can convert the results of a Map-Reduce operation to a POJO and integrates with Spring&#8217;s <a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/html/resources.html">Resource abstraction</a>. This lets you place your JavaScript files on the file system, classpath, HTTP server, or any other Spring Resource implementation and then reference the JavaScript resources through an easy URI style syntax&#8201;&#8212;&#8201;for example, <code>classpath:reduce.js;</code>. Externalizing JavaScript code in files is often preferable to embedding them as Java strings in your code. Note that you can still pass JavaScript code as Java strings if you prefer.</p>
</div>
<div class="sect3">
<h4 id="mongo.mapreduce.example"><a class="anchor" href="#mongo.mapreduce.example"></a>10.8.1. Example Usage</h4>
<div class="paragraph">
<p>To understand how to perform Map-Reduce operations, we use an example from the book, <em>MongoDB - The Definitive Guide</em> <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup>. In this example, we create three documents that have the values [a,b], [b,c], and [c,d], respectively. The values in each document are associated with the key, 'x', as the following example shows (assume these documents are in a collection named <code>jmr1</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>{ "_id" : ObjectId("4e5ff893c0277826074ec533"), "x" : [ "a", "b" ] }
{ "_id" : ObjectId("4e5ff893c0277826074ec534"), "x" : [ "b", "c" ] }
{ "_id" : ObjectId("4e5ff893c0277826074ec535"), "x" : [ "c", "d" ] }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following map function counts the occurrence of each letter in the array for each document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">function () {
    for (var i = 0; i &lt; this.x.length; i++) {
        emit(this.x[i], 1);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The follwing reduce function sums up the occurrence of each letter across all the documents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">function (key, values) {
    var sum = 0;
    for (var i = 0; i &lt; values.length; i++)
        sum += values[i];
    return sum;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the preceding functions result in the following collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>{ "_id" : "a", "value" : 1 }
{ "_id" : "b", "value" : 2 }
{ "_id" : "c", "value" : 2 }
{ "_id" : "d", "value" : 1 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming that the map and reduce functions are located in <code>map.js</code> and <code>reduce.js</code> and bundled in your jar so they are available on the classpath, you can run a Map-Reduce operation as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">MapReduceResults&lt;ValueObject&gt; results = mongoOperations.mapReduce("jmr1", "classpath:map.js", "classpath:reduce.js", ValueObject.class);
for (ValueObject valueObject : results) {
  System.out.println(valueObject);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding exmaple produces the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>ValueObject [id=a, value=1.0]
ValueObject [id=b, value=2.0]
ValueObject [id=c, value=2.0]
ValueObject [id=d, value=1.0]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>MapReduceResults</code> class implements <code>Iterable</code> and provides access to the raw output and timing and count statistics. The following listing shows the <code>ValueObject</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class ValueObject {

  private String id;
  private float value;

  public String getId() {
    return id;
  }

  public float getValue() {
    return value;
  }

  public void setValue(float value) {
    this.value = value;
  }

  @Override
  public String toString() {
    return "ValueObject [id=" + id + ", value=" + value + "]";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the output type of <code>INLINE</code> is used so that you need not specify an output collection. To specify additional Map-Reduce options, use an overloaded method that takes an additional <code>MapReduceOptions</code> argument. The class <code>MapReduceOptions</code> has a fluent API, so adding additional options can be done in a compact syntax. The following example sets the output collection to <code>jmr1_out</code> (note that setting only the output collection assumes a default output type of <code>REPLACE</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">MapReduceResults&lt;ValueObject&gt; results = mongoOperations.mapReduce("jmr1", "classpath:map.js", "classpath:reduce.js",
                                                                     new MapReduceOptions().outputCollection("jmr1_out"), ValueObject.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is also a static import (<code>import static org.springframework.data.mongodb.core.mapreduce.MapReduceOptions.options;</code>) that can be used to make the syntax slightly more compact, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">MapReduceResults&lt;ValueObject&gt; results = mongoOperations.mapReduce("jmr1", "classpath:map.js", "classpath:reduce.js",
                                                                     options().outputCollection("jmr1_out"), ValueObject.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify a query to reduce the set of data that is fed into the Map-Reduce operation. The following example removes the document that contains [a,b] from consideration for Map-Reduce operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Query query = new Query(where("x").ne(new String[] { "a", "b" }));
MapReduceResults&lt;ValueObject&gt; results = mongoOperations.mapReduce(query, "jmr1", "classpath:map.js", "classpath:reduce.js",
                                                                     options().outputCollection("jmr1_out"), ValueObject.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that you can specify additional limit and sort values on the query, but you cannot skip values.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.server-side-scripts"><a class="anchor" href="#mongo.server-side-scripts"></a>10.9. Script Operations</h3>
<div class="paragraph">
<p>MongoDB allows executing JavaScript functions on the server by either directly sending the script or calling a stored one. <code>ScriptOperations</code> can be accessed through <code>MongoTemplate</code> and provides basic abstraction for <code>JavaScript</code> usage. The following example shows how to us the <code>ScriptOperations</code> class:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">ScriptOperations scriptOps = template.scriptOps();

ExecutableMongoScript echoScript = new ExecutableMongoScript("function(x) { return x; }");
scriptOps.execute(echoScript, "directly execute script");     <i class="conum" data-value="1"></i><b>(1)</b>

scriptOps.register(new NamedMongoScript("echo", echoScript)); <i class="conum" data-value="2"></i><b>(2)</b>
scriptOps.call("echo", "execute script via name");            <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Execute the script directly without storing the function on server side.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Store the script using 'echo' as its name. The given name identifies the script and allows calling it later.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Execute the script with name 'echo' using the provided parameters.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.group"><a class="anchor" href="#mongo.group"></a>10.10. Group Operations</h3>
<div class="paragraph">
<p>As an alternative to using Map-Reduce to perform data aggregation, you can use the <a href="https://www.mongodb.org/display/DOCS/Aggregation#Aggregation-Group"><code>group</code> operation</a> which feels similar to using SQL&#8217;s group by query style, so it may feel more approachable vs. using Map-Reduce. Using the group operations does have some limitations, for example it is not supported in a shared environment and it returns the full result set in a single BSON object, so the result should be small, less than 10,000 keys.</p>
</div>
<div class="paragraph">
<p>Spring provides integration with MongoDB&#8217;s group operation by providing methods on MongoOperations to simplify the creation and execution of group operations. It can convert the results of the group operation to a POJO and also integrates with Spring&#8217;s <a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/html/resources.html">Resource abstraction</a> abstraction. This will let you place your JavaScript files on the file system, classpath, http server or any other Spring Resource implementation and then reference the JavaScript resources via an easy URI style syntax, e.g. 'classpath:reduce.js;. Externalizing JavaScript code in files if often preferable to embedding them as Java strings in your code. Note that you can still pass JavaScript code as Java strings if you prefer.</p>
</div>
<div class="sect3">
<h4 id="mongo.group.example"><a class="anchor" href="#mongo.group.example"></a>10.10.1. Example Usage</h4>
<div class="paragraph">
<p>In order to understand how group operations work the following example is used, which is somewhat artificial. For a more realistic example consult the book 'MongoDB - The definitive guide'. A collection named <code>group_test_collection</code> created with the following rows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>{ "_id" : ObjectId("4ec1d25d41421e2015da64f1"), "x" : 1 }
{ "_id" : ObjectId("4ec1d25d41421e2015da64f2"), "x" : 1 }
{ "_id" : ObjectId("4ec1d25d41421e2015da64f3"), "x" : 2 }
{ "_id" : ObjectId("4ec1d25d41421e2015da64f4"), "x" : 3 }
{ "_id" : ObjectId("4ec1d25d41421e2015da64f5"), "x" : 3 }
{ "_id" : ObjectId("4ec1d25d41421e2015da64f6"), "x" : 3 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>We would like to group by the only field in each row, the <code>x</code> field and aggregate the number of times each specific value of <code>x</code> occurs. To do this we need to create an initial document that contains our count variable and also a reduce function which will increment it each time it is encountered. The Java code to execute the group operation is shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">GroupByResults&lt;XObject&gt; results = mongoTemplate.group("group_test_collection",
                                                      GroupBy.key("x").initialDocument("{ count: 0 }").reduceFunction("function(doc, prev) { prev.count += 1 }"),
                                                      XObject.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first argument is the name of the collection to run the group operation over, the second is a fluent API that specifies properties of the group operation via a <code>GroupBy</code> class. In this example we are using just the <code>intialDocument</code> and <code>reduceFunction</code> methods. You can also specify a key-function, as well as a finalizer as part of the fluent API. If you have multiple keys to group by, you can pass in a comma separated list of keys.</p>
</div>
<div class="paragraph">
<p>The raw results of the group operation is a JSON document that looks like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>{
  "retval" : [ { "x" : 1.0 , "count" : 2.0} ,
               { "x" : 2.0 , "count" : 1.0} ,
               { "x" : 3.0 , "count" : 3.0} ] ,
  "count" : 6.0 ,
  "keys" : 3 ,
  "ok" : 1.0
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The document under the "retval" field is mapped onto the third argument in the group method, in this case XObject which is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class XObject {

  private float x;

  private float count;


  public float getX() {
    return x;
  }

  public void setX(float x) {
    this.x = x;
  }

  public float getCount() {
    return count;
  }

  public void setCount(float count) {
    this.count = count;
  }

  @Override
  public String toString() {
    return "XObject [x=" + x + " count = " + count + "]";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also obtain the raw result as a <code>DbObject</code> by calling the method <code>getRawResults</code> on the <code>GroupByResults</code> class.</p>
</div>
<div class="paragraph">
<p>There is an additional method overload of the group method on <code>MongoOperations</code> which lets you specify a <code>Criteria</code> object for selecting a subset of the rows. An example which uses a <code>Criteria</code> object, with some syntax sugar using static imports, as well as referencing a key-function and reduce function javascript files via a Spring Resource string is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>import static org.springframework.data.mongodb.core.mapreduce.GroupBy.keyFunction;
import static org.springframework.data.mongodb.core.query.Criteria.where;

GroupByResults&lt;XObject&gt; results = mongoTemplate.group(where("x").gt(0),
                                        "group_test_collection",
                                        keyFunction("classpath:keyFunction.js").initialDocument("{ count: 0 }").reduceFunction("classpath:groupReduce.js"), XObject.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.aggregation"><a class="anchor" href="#mongo.aggregation"></a>10.11. Aggregation Framework Support</h3>
<div class="paragraph">
<p>Spring Data MongoDB provides support for the Aggregation Framework introduced to MongoDB in version 2.2.</p>
</div>
<div class="paragraph">
<p>For further information, see the full <a href="http://docs.mongodb.org/manual/aggregation/">reference documentation</a> of the aggregation framework and other data aggregation tools for MongoDB.</p>
</div>
<div class="sect3">
<h4 id="mongo.aggregation.basic-concepts"><a class="anchor" href="#mongo.aggregation.basic-concepts"></a>10.11.1. Basic Concepts</h4>
<div class="paragraph">
<p>The Aggregation Framework support in Spring Data MongoDB is based on the following key abstractions: <code>Aggregation</code>, <code>AggregationOperation</code>, and <code>AggregationResults</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Aggregation</code></p>
<div class="paragraph">
<p>An <code>Aggregation</code> represents a MongoDB <code>aggregate</code> operation and holds the description of the aggregation pipeline instructions. Aggregations are created by invoking the appropriate <code>newAggregation(…)</code> static factory method of the <code>Aggregation</code> class, which takes a list of <code>AggregateOperation</code> and an optional input class.</p>
</div>
<div class="paragraph">
<p>The actual aggregate operation is executed by the <code>aggregate</code> method of the <code>MongoTemplate</code>, which takes the desired output class as a parameter.</p>
</div>
</li>
<li>
<p><code>AggregationOperation</code></p>
<div class="paragraph">
<p>An <code>AggregationOperation</code> represents a MongoDB aggregation pipeline operation and describes the processing that should be performed in this aggregation step. Although you could manually create an <code>AggregationOperation</code>, we recommend using the static factory methods provided by the <code>Aggregate</code> class to construct an <code>AggregateOperation</code>.</p>
</div>
</li>
<li>
<p><code>AggregationResults</code></p>
<div class="paragraph">
<p><code>AggregationResults</code> is the container for the result of an aggregate operation. It provides access to the raw aggregation result, in the form of a <code>DBObject</code> to the mapped objects and other information about the aggregation.</p>
</div>
<div class="paragraph">
<p>The following listing shows the canonical example for using the Spring Data MongoDB support for the MongoDB Aggregation Framework:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

Aggregation agg = newAggregation(
    pipelineOP1(),
    pipelineOP2(),
    pipelineOPn()
);

AggregationResults&lt;OutputType&gt; results = mongoTemplate.aggregate(agg, "INPUT_COLLECTION_NAME", OutputType.class);
List&lt;OutputType&gt; mappedResult = results.getMappedResults();</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that, if you provide an input class as the first parameter to the <code>newAggregation</code> method, the <code>MongoTemplate</code> derives the name of the input collection from this class. Otherwise, if you do not not specify an input class, you must provide the name of the input collection explicitly. If both an input class and an input collection are provided, the latter takes precedence.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.aggregation.supported-aggregation-operations"><a class="anchor" href="#mongo.aggregation.supported-aggregation-operations"></a>10.11.2. Supported Aggregation Operations</h4>
<div class="paragraph">
<p>The MongoDB Aggregation Framework provides the following types of aggregation operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pipeline Aggregation Operators</p>
</li>
<li>
<p>Group Aggregation Operators</p>
</li>
<li>
<p>Boolean Aggregation Operators</p>
</li>
<li>
<p>Comparison Aggregation Operators</p>
</li>
<li>
<p>Arithmetic Aggregation Operators</p>
</li>
<li>
<p>String Aggregation Operators</p>
</li>
<li>
<p>Date Aggregation Operators</p>
</li>
<li>
<p>Array Aggregation Operators</p>
</li>
<li>
<p>Conditional Aggregation Operators</p>
</li>
<li>
<p>Lookup Aggregation Operators</p>
</li>
<li>
<p>Convert Aggregation Operators</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At the time of this writing, we provide support for the following Aggregation Operations in Spring Data MongoDB:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. Aggregation Operations currently supported by Spring Data MongoDB</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pipeline Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bucket</code>, <code>bucketAuto</code>, <code>count</code>, <code>facet</code>, <code>geoNear</code>, <code>graphLookup</code>, <code>group</code>, <code>limit</code>, <code>lookup</code>, <code>match</code>, <code>project</code>, <code>replaceRoot</code>, <code>skip</code>, <code>sort</code>, <code>unwind</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setEquals</code>, <code>setIntersection</code>, <code>setUnion</code>, <code>setDifference</code>, <code>setIsSubset</code>, <code>anyElementTrue</code>, <code>allElementsTrue</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Group Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>addToSet</code>, <code>first</code>, <code>last</code>, <code>max</code>, <code>min</code>, <code>avg</code>, <code>push</code>, <code>sum</code>, <code>(*count)</code>, <code>stdDevPop</code>, <code>stdDevSamp</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arithmetic Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>abs</code>, <code>add</code> (*via <code>plus</code>), <code>ceil</code>, <code>divide</code>, <code>exp</code>, <code>floor</code>, <code>ln</code>, <code>log</code>, <code>log10</code>, <code>mod</code>, <code>multiply</code>, <code>pow</code>, <code>sqrt</code>, <code>subtract</code> (*via <code>minus</code>), <code>trunc</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">String Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>concat</code>, <code>substr</code>, <code>toLower</code>, <code>toUpper</code>, <code>stcasecmp</code>, <code>indexOfBytes</code>, <code>indexOfCP</code>, <code>split</code>, <code>strLenBytes</code>, <code>strLenCP</code>, <code>substrCP</code>, <code>trim</code>, <code>ltrim</code>, <code>rtim</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comparison Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eq</code> (*via: <code>is</code>), <code>gt</code>, <code>gte</code>, <code>lt</code>, <code>lte</code>, <code>ne</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>arrayElementAt</code>, <code>concatArrays</code>, <code>filter</code>, <code>in</code>, <code>indexOfArray</code>, <code>isArray</code>, <code>range</code>, <code>reverseArray</code>, <code>reduce</code>, <code>size</code>, <code>slice</code>, <code>zip</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Literal Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>literal</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dayOfYear</code>, <code>dayOfMonth</code>, <code>dayOfWeek</code>, <code>year</code>, <code>month</code>, <code>week</code>, <code>hour</code>, <code>minute</code>, <code>second</code>, <code>millisecond</code>, <code>dateToString</code>, <code>dateFromString</code>, <code>dateFromParts</code>, <code>dateToParts</code>, <code>isoDayOfWeek</code>, <code>isoWeek</code>, <code>isoWeekYear</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variable Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>map</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conditional Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cond</code>, <code>ifNull</code>, <code>switch</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Convert Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>convert</code>, <code>toBool</code>, <code>toDate</code>, <code>toDecimal</code>, <code>toDouble</code>, <code>toInt</code>, <code>toLong</code>, <code>toObjectId</code>, <code>toString</code></p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>The operation is mapped or added by Spring Data MongoDB.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the aggregation operations not listed here are currently not supported by Spring Data MongoDB. Comparison aggregation operators are expressed as <code>Criteria</code> expressions.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.aggregation.projection"><a class="anchor" href="#mongo.aggregation.projection"></a>10.11.3. Projection Expressions</h4>
<div class="paragraph">
<p>Projection expressions are used to define the fields that are the outcome of a particular aggregation step. Projection expressions can be defined through the <code>project</code> method of the <code>Aggregation</code> class, either by passing a list of <code>String</code> objects or an aggregation framework <code>Fields</code> object. The projection can be extended with additional fields through a fluent API by using the <code>and(String)</code> method and aliased by using the <code>as(String)</code> method.
Note that you can also define fields with aliases by using the <code>Fields.field</code> static factory method of the aggregation framework, which you can then use to construct a new <code>Fields</code> instance. References to projected fields in later aggregation stages are valid only for the field names of included fields or their aliases (including newly defined fields and their aliases). Fields not included in the projection cannot be referenced in later aggregation stages. The following listings show examples of projection expression:</p>
</div>
<div class="exampleblock">
<div class="title">Example 64. Projection expression examples</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">// generates {$project: {name: 1, netPrice: 1}}
project("name", "netPrice")

// generates {$project: {thing1: $thing2}}
project().and("thing1").as("thing2")

// generates {$project: {a: 1, b: 1, thing2: $thing1}}
project("a","b").and("thing1").as("thing2")</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 65. Multi-Stage Aggregation using Projection and Sorting</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">// generates {$project: {name: 1, netPrice: 1}}, {$sort: {name: 1}}
project("name", "netPrice"), sort(ASC, "name")

// generates {$project: {name: $firstname}}, {$sort: {name: 1}}
project().and("firstname").as("name"), sort(ASC, "name")

// does not work
project().and("firstname").as("name"), sort(ASC, "firstname")</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>More examples for project operations can be found in the <code>AggregationTests</code> class. Note that further details regarding the projection expressions can be found in the <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/project/#pipe._S_project">corresponding section</a> of the MongoDB Aggregation Framework reference documentation.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.aggregation.facet"><a class="anchor" href="#mongo.aggregation.facet"></a>10.11.4. Faceted Classification</h4>
<div class="paragraph">
<p>As of Version 3.4, MongoDB supports faceted classification by using the Aggregation Framework. A faceted classification uses semantic categories (either general or subject-specific) that are combined to create the full classification entry. Documents flowing through the aggregation pipeline are classified into buckets. A multi-faceted classification enables various aggregations on the same set of input documents, without needing to retrieve the input documents multiple times.</p>
</div>
<div class="sect4">
<h5 id="_buckets"><a class="anchor" href="#_buckets"></a>Buckets</h5>
<div class="paragraph">
<p>Bucket operations categorize incoming documents into groups, called buckets, based on a specified expression and bucket boundaries. Bucket operations require a grouping field or a grouping expression. You can define them by using the <code>bucket()</code> and <code>bucketAuto()</code> methods of the <code>Aggregate</code> class. <code>BucketOperation</code> and <code>BucketAutoOperation</code> can expose accumulations based on aggregation expressions for input documents. You can extend the bucket operation with additional parameters through a fluent API by using the <code>with…()</code> methods and the <code>andOutput(String)</code> method. You can alias the operation by using the <code>as(String)</code> method. Each bucket is represented as a document in the output.</p>
</div>
<div class="paragraph">
<p><code>BucketOperation</code> takes a defined set of boundaries to group incoming documents into these categories. Boundaries are required to be sorted. The following listing shows some examples of bucket operations:</p>
</div>
<div class="exampleblock">
<div class="title">Example 66. Bucket operation examples</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">// generates {$bucket: {groupBy: $price, boundaries: [0, 100, 400]}}
bucket("price").withBoundaries(0, 100, 400);

// generates {$bucket: {groupBy: $price, default: "Other" boundaries: [0, 100]}}
bucket("price").withBoundaries(0, 100).withDefault("Other");

// generates {$bucket: {groupBy: $price, boundaries: [0, 100], output: { count: { $sum: 1}}}}
bucket("price").withBoundaries(0, 100).andOutputCount().as("count");

// generates {$bucket: {groupBy: $price, boundaries: [0, 100], 5, output: { titles: { $push: "$title"}}}
bucket("price").withBoundaries(0, 100).andOutput("title").push().as("titles");</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>BucketAutoOperation</code> determines boundaries in an attempt to evenly distribute documents into a specified number of buckets. <code>BucketAutoOperation</code> optionally takes a granularity value that specifies the <a href="https://en.wikipedia.org/wiki/Preferred_number">preferred number</a> series to use to ensure that the calculated boundary edges end on preferred round numbers or on powers of 10. The following listing shows examples of bucket operations:</p>
</div>
<div class="exampleblock">
<div class="title">Example 67. Bucket operation examples</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">// generates {$bucketAuto: {groupBy: $price, buckets: 5}}
bucketAuto("price", 5)

// generates {$bucketAuto: {groupBy: $price, buckets: 5, granularity: "E24"}}
bucketAuto("price", 5).withGranularity(Granularities.E24).withDefault("Other");

// generates {$bucketAuto: {groupBy: $price, buckets: 5, output: { titles: { $push: "$title"}}}
bucketAuto("price", 5).andOutput("title").push().as("titles");</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To create output fields in buckets, bucket operations can use <code>AggregationExpression</code> through <code>andOutput()</code> and <a href="#mongo.aggregation.projection.expressions">SpEL expressions</a> through <code>andOutputExpression()</code>.</p>
</div>
<div class="paragraph">
<p>Note that further details regarding bucket expressions can be found in the <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/bucket/"><code>$bucket</code> section</a> and
<a href="http://docs.mongodb.org/manual/reference/operator/aggregation/bucketAuto/"><code>$bucketAuto</code> section</a> of the MongoDB Aggregation Framework reference documentation.</p>
</div>
</div>
<div class="sect4">
<h5 id="_multi_faceted_aggregation"><a class="anchor" href="#_multi_faceted_aggregation"></a>Multi-faceted Aggregation</h5>
<div class="paragraph">
<p>Multiple aggregation pipelines can be used to create multi-faceted aggregations that characterize data across multiple dimensions (or facets) within a single aggregation stage. Multi-faceted aggregations provide multiple filters and categorizations to guide data browsing and analysis. A common implementation of faceting is how many online retailers provide ways to narrow down search results by applying filters on product price, manufacturer, size, and other factors.</p>
</div>
<div class="paragraph">
<p>You can define a <code>FacetOperation</code> by using the <code>facet()</code> method of the <code>Aggregation</code> class. You can customize it with multiple aggregation pipelines by using the <code>and()</code> method. Each sub-pipeline has its own field in the output document where its results are stored as an array of documents.</p>
</div>
<div class="paragraph">
<p>Sub-pipelines can project and filter input documents prior to grouping. Common use cases include extraction of date parts or calculations before categorization. The following listing shows facet operation examples:</p>
</div>
<div class="exampleblock">
<div class="title">Example 68. Facet operation examples</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">// generates {$facet: {categorizedByPrice: [ { $match: { price: {$exists : true}}}, { $bucketAuto: {groupBy: $price, buckets: 5}}]}}
facet(match(Criteria.where("price").exists(true)), bucketAuto("price", 5)).as("categorizedByPrice"))

// generates {$facet: {categorizedByCountry: [ { $match: { country: {$exists : true}}}, { $sortByCount: "$country"}]}}
facet(match(Criteria.where("country").exists(true)), sortByCount("country")).as("categorizedByCountry"))

// generates {$facet: {categorizedByYear: [
//     { $project: { title: 1, publicationYear: { $year: "publicationDate"}}},
//     { $bucketAuto: {groupBy: $price, buckets: 5, output: { titles: {$push:"$title"}}}
// ]}}
facet(project("title").and("publicationDate").extractYear().as("publicationYear"),
      bucketAuto("publicationYear", 5).andOutput("title").push().as("titles"))
  .as("categorizedByYear"))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that further details regarding facet operation can be found in the <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/facet/"><code>$facet</code> section</a> of the MongoDB Aggregation Framework reference documentation.</p>
</div>
</div>
<div class="sect4">
<h5 id="mongo.aggregation.projection.expressions"><a class="anchor" href="#mongo.aggregation.projection.expressions"></a>Spring Expression Support in Projection Expressions</h5>
<div class="paragraph">
<p>We support the use of SpEL expressions in projection expressions through the <code>andExpression</code> method of the <code>ProjectionOperation</code> and <code>BucketOperation</code> classes. This feature lets you define the desired expression as a SpEL expression. On query execution, the SpEL expression is translated into a corresponding MongoDB projection expression part. This arrangement makes it much easier to express complex calculations.</p>
</div>
<div class="sect5">
<h6 id="_complex_calculations_with_spel_expressions"><a class="anchor" href="#_complex_calculations_with_spel_expressions"></a>Complex Calculations with SpEL expressions</h6>
<div class="paragraph">
<p>Consider the following SpEL expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">1 + (q + 1) / (q - 1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding expression is translated into the following projection expression part:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{ "$add" : [ 1, {
    "$divide" : [ {
        "$add":["$q", 1]}, {
        "$subtract":[ "$q", 1]}
    ]
}]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see examples in more context in <a href="#mongo.aggregation.examples.example5">Aggregation Framework Example 5</a> and <a href="#mongo.aggregation.examples.example6">Aggregation Framework Example 6</a>. You can find more usage examples for supported SpEL expression constructs in <code>SpelExpressionTransformerUnitTests</code>. The following table shows the SpEL transformations supported by Spring Data MongoDB:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 5. Supported SpEL transformations</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">SpEL Expression</th>
<th class="tableblock halign-left valign-top">Mongo Expression Part</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a == b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $eq : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a != b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $ne : [$a , $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a &gt; b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $gt : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a &gt;= b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $gte : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a &lt; b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $lt : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a &#8656; b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $lte : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a + b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $add : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a - b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $subtract : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a * b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $multiply : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a / b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $divide : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a^b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $pow : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a % b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $mod : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a &amp;&amp; b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $and : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a || b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $or : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">!a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $not : [$a] }</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In addition to the transformations shown in the preceding table, you can use standard SpEL operations such as <code>new</code> to (for example) create arrays and reference expressions through their names (followed by the arguments to use in brackets). The following example shows how to create an array in this fashion:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">// { $setEquals : [$a, [5, 8, 13] ] }
.andExpression("setEquals(a, new int[]{5, 8, 13})");</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="mongo.aggregation.examples"><a class="anchor" href="#mongo.aggregation.examples"></a>Aggregation Framework Examples</h5>
<div class="paragraph">
<p>The examples in this section demonstrate the usage patterns for the MongoDB Aggregation Framework with Spring Data MongoDB.</p>
</div>
<div class="sect5">
<h6 id="mongo.aggregation.examples.example1"><a class="anchor" href="#mongo.aggregation.examples.example1"></a>Aggregation Framework Example 1</h6>
<div class="paragraph">
<p>In this introductory example, we want to aggregate a list of tags to get the occurrence count of a particular tag from a MongoDB collection (called <code>tags</code>) sorted by the occurrence count in descending order. This example demonstrates the usage of grouping, sorting, projections (selection), and unwinding (result splitting).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class TagCount {
 String tag;
 int n;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

Aggregation agg = newAggregation(
    project("tags"),
    unwind("tags"),
    group("tags").count().as("n"),
    project("n").and("tag").previousOperation(),
    sort(DESC, "n")
);

AggregationResults&lt;TagCount&gt; results = mongoTemplate.aggregate(agg, "tags", TagCount.class);
List&lt;TagCount&gt; tagCount = results.getMappedResults();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding listing uses the following algorithm:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new aggregation by using the <code>newAggregation</code> static factory method, to which we pass a list of aggregation operations. These aggregate operations define the aggregation pipeline of our <code>Aggregation</code>.</p>
</li>
<li>
<p>Use the <code>project</code> operation to select the <code>tags</code> field (which is an array of strings) from the input collection.</p>
</li>
<li>
<p>Use the <code>unwind</code> operation to generate a new document for each tag within the <code>tags</code> array.</p>
</li>
<li>
<p>Use the <code>group</code> operation to define a group for each <code>tags</code> value for which we aggregate the occurrence count (by using the <code>count</code> aggregation operator and collecting the result in a new field called <code>n</code>).</p>
</li>
<li>
<p>Select the <code>n</code> field and create an alias for the ID field generated from the previous group operation (hence the call to <code>previousOperation()</code>) with a name of <code>tag</code>.</p>
</li>
<li>
<p>Use the <code>sort</code> operation to sort the resulting list of tags by their occurrence count in descending order.</p>
</li>
<li>
<p>Call the <code>aggregate</code> method on <code>MongoTemplate</code> to let MongoDB perform the actual aggregation operation, with the created <code>Aggregation</code> as an argument.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that the input collection is explicitly specified as the <code>tags</code> parameter to the <code>aggregate</code> Method. If the name of the input collection is not specified explicitly, it is derived from the input class passed as the first parameter to the <code>newAggreation</code> method.</p>
</div>
</div>
<div class="sect5">
<h6 id="mongo.aggregation.examples.example2"><a class="anchor" href="#mongo.aggregation.examples.example2"></a>Aggregation Framework Example 2</h6>
<div class="paragraph">
<p>This example is based on the <a href="http://docs.mongodb.org/manual/tutorial/aggregation-examples/#largest-and-smallest-cities-by-state">Largest and Smallest Cities by State</a> example from the MongoDB Aggregation Framework documentation. We added additional sorting to produce stable results with different MongoDB versions. Here we want to return the smallest and largest cities by population for each state by using the aggregation framework. This example demonstrates grouping, sorting, and projections (selection).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class ZipInfo {
   String id;
   String city;
   String state;
   @Field("pop") int population;
   @Field("loc") double[] location;
}

class City {
   String name;
   int population;
}

class ZipInfoStats {
   String id;
   String state;
   City biggestCity;
   City smallestCity;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

TypedAggregation&lt;ZipInfo&gt; aggregation = newAggregation(ZipInfo.class,
    group("state", "city")
       .sum("population").as("pop"),
    sort(ASC, "pop", "state", "city"),
    group("state")
       .last("city").as("biggestCity")
       .last("pop").as("biggestPop")
       .first("city").as("smallestCity")
       .first("pop").as("smallestPop"),
    project()
       .and("state").previousOperation()
       .and("biggestCity")
          .nested(bind("name", "biggestCity").and("population", "biggestPop"))
       .and("smallestCity")
          .nested(bind("name", "smallestCity").and("population", "smallestPop")),
    sort(ASC, "state")
);

AggregationResults&lt;ZipInfoStats&gt; result = mongoTemplate.aggregate(aggregation, ZipInfoStats.class);
ZipInfoStats firstZipInfoStats = result.getMappedResults().get(0);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>ZipInfo</code> class maps the structure of the given input-collection. The <code>ZipInfoStats</code> class defines the structure in the desired output format.</p>
</div>
<div class="paragraph">
<p>The preceding listings use the following algorithm:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the <code>group</code> operation to define a group from the input-collection. The grouping criteria is the combination of the <code>state</code> and <code>city</code> fields, which forms the ID structure of the group. We aggregate the value of the <code>population</code> property from the grouped elements by using the <code>sum</code> operator and save the result in the <code>pop</code> field.</p>
</li>
<li>
<p>Use the <code>sort</code> operation to sort the intermediate-result by the <code>pop</code>, <code>state</code> and <code>city</code> fields, in ascending order, such that the smallest city is at the top and the biggest city is at the bottom of the result. Note that the sorting on <code>state</code> and <code>city</code> is implicitly performed against the group ID fields (which Spring Data MongoDB handled).</p>
</li>
<li>
<p>Use a <code>group</code> operation again to group the intermediate result by <code>state</code>. Note that <code>state</code> again implicitly references a group ID field. We select the name and the population count of the biggest and smallest city with calls to the <code>last(…)</code> and <code>first(&#8230;&#8203;)</code> operators, respectively, in the <code>project</code> operation.</p>
</li>
<li>
<p>Select the <code>state</code> field from the previous <code>group</code> operation. Note that <code>state</code> again implicitly references a group ID field. Because we do not want an implicitly generated ID to appear, we exclude the ID from the previous operation by using <code>and(previousOperation()).exclude()</code>. Because we want to populate the nested <code>City</code> structures in our output class, we have to emit appropriate sub-documents by using the nested method.</p>
</li>
<li>
<p>Sort the resulting list of <code>StateStats</code> by their state name in ascending order in the <code>sort</code> operation.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that we derive the name of the input collection from the <code>ZipInfo</code> class passed as the first parameter to the <code>newAggregation</code> method.</p>
</div>
</div>
<div class="sect5">
<h6 id="mongo.aggregation.examples.example3"><a class="anchor" href="#mongo.aggregation.examples.example3"></a>Aggregation Framework Example 3</h6>
<div class="paragraph">
<p>This example is based on the <a href="http://docs.mongodb.org/manual/tutorial/aggregation-examples/#states-with-populations-over-10-million">States with Populations Over 10 Million</a> example from the MongoDB Aggregation Framework documentation. We added additional sorting to produce stable results with different MongoDB versions. Here we want to return all states with a population greater than 10 million, using the aggregation framework. This example demonstrates grouping, sorting, and matching (filtering).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class StateStats {
   @Id String id;
   String state;
   @Field("totalPop") int totalPopulation;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

TypedAggregation&lt;ZipInfo&gt; agg = newAggregation(ZipInfo.class,
    group("state").sum("population").as("totalPop"),
    sort(ASC, previousOperation(), "totalPop"),
    match(where("totalPop").gte(10 * 1000 * 1000))
);

AggregationResults&lt;StateStats&gt; result = mongoTemplate.aggregate(agg, StateStats.class);
List&lt;StateStats&gt; stateStatsList = result.getMappedResults();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding listings use the following algorithm:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Group the input collection by the <code>state</code> field and calculate the sum of the <code>population</code> field and store the result in the new field <code>"totalPop"</code>.</p>
</li>
<li>
<p>Sort the intermediate result by the id-reference of the previous group operation in addition to the <code>"totalPop"</code> field in ascending order.</p>
</li>
<li>
<p>Filter the intermediate result by using a <code>match</code> operation which accepts a <code>Criteria</code> query as an argument.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that we derive the name of the input collection from the <code>ZipInfo</code> class passed as first parameter to the <code>newAggregation</code> method.</p>
</div>
</div>
<div class="sect5">
<h6 id="mongo.aggregation.examples.example4"><a class="anchor" href="#mongo.aggregation.examples.example4"></a>Aggregation Framework Example 4</h6>
<div class="paragraph">
<p>This example demonstrates the use of simple arithmetic operations in the projection operation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class Product {
    String id;
    String name;
    double netPrice;
    int spaceUnits;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

TypedAggregation&lt;Product&gt; agg = newAggregation(Product.class,
    project("name", "netPrice")
        .and("netPrice").plus(1).as("netPricePlus1")
        .and("netPrice").minus(1).as("netPriceMinus1")
        .and("netPrice").multiply(1.19).as("grossPrice")
        .and("netPrice").divide(2).as("netPriceDiv2")
        .and("spaceUnits").mod(2).as("spaceUnitsMod2")
);

AggregationResults&lt;DBObject&gt; result = mongoTemplate.aggregate(agg, DBObject.class);
List&lt;DBObject&gt; resultList = result.getMappedResults();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we derive the name of the input collection from the <code>Product</code> class passed as first parameter to the <code>newAggregation</code> method.</p>
</div>
</div>
<div class="sect5">
<h6 id="mongo.aggregation.examples.example5"><a class="anchor" href="#mongo.aggregation.examples.example5"></a>Aggregation Framework Example 5</h6>
<div class="paragraph">
<p>This example demonstrates the use of simple arithmetic operations derived from SpEL Expressions in the projection operation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class Product {
    String id;
    String name;
    double netPrice;
    int spaceUnits;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

TypedAggregation&lt;Product&gt; agg = newAggregation(Product.class,
    project("name", "netPrice")
        .andExpression("netPrice + 1").as("netPricePlus1")
        .andExpression("netPrice - 1").as("netPriceMinus1")
        .andExpression("netPrice / 2").as("netPriceDiv2")
        .andExpression("netPrice * 1.19").as("grossPrice")
        .andExpression("spaceUnits % 2").as("spaceUnitsMod2")
        .andExpression("(netPrice * 0.8  + 1.2) * 1.19").as("grossPriceIncludingDiscountAndCharge")

);

AggregationResults&lt;DBObject&gt; result = mongoTemplate.aggregate(agg, DBObject.class);
List&lt;DBObject&gt; resultList = result.getMappedResults();</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="mongo.aggregation.examples.example6"><a class="anchor" href="#mongo.aggregation.examples.example6"></a>Aggregation Framework Example 6</h6>
<div class="paragraph">
<p>This example demonstrates the use of complex arithmetic operations derived from SpEL Expressions in the projection operation.</p>
</div>
<div class="paragraph">
<p>Note: The additional parameters passed to the <code>addExpression</code> method can be referenced with indexer expressions according to their position. In this example, we reference the first parameter of the parameters array with <code>[0]</code>. When the SpEL expression is transformed into a MongoDB aggregation framework expression, external parameter expressions are replaced with their respective values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class Product {
    String id;
    String name;
    double netPrice;
    int spaceUnits;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

double shippingCosts = 1.2;

TypedAggregation&lt;Product&gt; agg = newAggregation(Product.class,
    project("name", "netPrice")
        .andExpression("(netPrice * (1-discountRate)  + [0]) * (1+taxRate)", shippingCosts).as("salesPrice")
);

AggregationResults&lt;DBObject&gt; result = mongoTemplate.aggregate(agg, DBObject.class);
List&lt;DBObject&gt; resultList = result.getMappedResults();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we can also refer to other fields of the document within the SpEL expression.</p>
</div>
</div>
<div class="sect5">
<h6 id="mongo.aggregation.examples.example7"><a class="anchor" href="#mongo.aggregation.examples.example7"></a>Aggregation Framework Example 7</h6>
<div class="paragraph">
<p>This example uses conditional projection. It is derived from the <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/cond/">$cond reference documentation</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class InventoryItem {

  @Id int id;
  String item;
  String description;
  int qty;
}

public class InventoryItemProjection {

  @Id int id;
  String item;
  String description;
  int qty;
  int discount
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

TypedAggregation&lt;InventoryItem&gt; agg = newAggregation(InventoryItem.class,
  project("item").and("discount")
    .applyCondition(ConditionalOperator.newBuilder().when(Criteria.where("qty").gte(250))
      .then(30)
      .otherwise(20))
    .and(ifNull("description", "Unspecified")).as("description")
);

AggregationResults&lt;InventoryItemProjection&gt; result = mongoTemplate.aggregate(agg, "inventory", InventoryItemProjection.class);
List&lt;InventoryItemProjection&gt; stateStatsList = result.getMappedResults();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This one-step aggregation uses a projection operation with the <code>inventory</code> collection. We project the <code>discount</code> field by using a conditional operation for all inventory items that have a <code>qty</code> greater than or equal to <code>250</code>. A second conditional projection is performed for the <code>description</code> field. We apply the <code>Unspecified</code> description to all items that either do not have a <code>description</code> field or items that have a <code>null</code> description.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.custom-converters"><a class="anchor" href="#mongo.custom-converters"></a>10.12. Overriding Default Mapping with Custom Converters</h3>
<div class="paragraph">
<p>To have more fine-grained control over the mapping process, you can register Spring converters with the <code>MongoConverter</code> implementations, such as the <code>MappingMongoConverter</code>.</p>
</div>
<div class="paragraph">
<p>The <code>MappingMongoConverter</code> checks to see if any Spring converters can handle a specific class before attempting to map the object itself. To 'hijack' the normal mapping strategies of the <code>MappingMongoConverter</code>, perhaps for increased performance or other custom mapping needs, you first need to create an implementation of the Spring <code>Converter</code> interface and then register it with the <code>MappingConverter</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For more information on the Spring type conversion service, see the reference docs <a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/html/validation.html#core-convert">here</a>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="mongo.custom-converters.writer"><a class="anchor" href="#mongo.custom-converters.writer"></a>10.12.1. Saving by Using a Registered Spring Converter</h4>
<div class="paragraph">
<p>The following example shows an implementation of the <code>Converter</code> that converts from a <code>Person</code> object to a <code>com.mongodb.DBObject</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import org.springframework.core.convert.converter.Converter;

import com.mongodb.BasicDBObject;
import com.mongodb.DBObject;

public class PersonWriteConverter implements Converter&lt;Person, DBObject&gt; {

  public DBObject convert(Person source) {
    DBObject dbo = new BasicDBObject();
    dbo.put("_id", source.getId());
    dbo.put("name", source.getFirstName());
    dbo.put("age", source.getAge());
    return dbo;
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.custom-converters.reader"><a class="anchor" href="#mongo.custom-converters.reader"></a>10.12.2. Reading by Using a Spring Converter</h4>
<div class="paragraph">
<p>The following example shows an implementation of a <code>Converter</code> that converts from a <code>DBObject</code> to a <code>Person</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class PersonReadConverter implements Converter&lt;DBObject, Person&gt; {

  public Person convert(DBObject source) {
    Person p = new Person((ObjectId) source.get("_id"), (String) source.get("name"));
    p.setAge((Integer) source.get("age"));
    return p;
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.custom-converters.xml"><a class="anchor" href="#mongo.custom-converters.xml"></a>10.12.3. Registering Spring Converters with the <code>MongoConverter</code></h4>
<div class="paragraph">
<p>The Mongo Spring namespace provides a convenient way to register Spring <code>Converter</code> instances with the <code>MappingMongoConverter</code>. The following configuration snippet shows how to manually register converter beans as well as configure the wrapping <code>MappingMongoConverter</code> into a <code>MongoTemplate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;mongo:db-factory dbname="database"/&gt;

&lt;mongo:mapping-converter&gt;
  &lt;mongo:custom-converters&gt;
    &lt;mongo:converter ref="readConverter"/&gt;
    &lt;mongo:converter&gt;
      &lt;bean class="org.springframework.data.mongodb.test.PersonWriteConverter"/&gt;
    &lt;/mongo:converter&gt;
  &lt;/mongo:custom-converters&gt;
&lt;/mongo:mapping-converter&gt;

&lt;bean id="readConverter" class="org.springframework.data.mongodb.test.PersonReadConverter"/&gt;

&lt;bean id="mongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
  &lt;constructor-arg name="mongoDbFactory" ref="mongoDbFactory"/&gt;
  &lt;constructor-arg name="mongoConverter" ref="mappingConverter"/&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the <code>base-package</code> attribute of the <code>custom-converters</code> element to enable classpath scanning for all <code>Converter</code> and <code>GenericConverter</code> implementations below the given package, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;mongo:mapping-converter&gt;
  &lt;mongo:custom-converters base-package="com.acme.**.converters" /&gt;
&lt;/mongo:mapping-converter&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.converter-disambiguation"><a class="anchor" href="#mongo.converter-disambiguation"></a>10.12.4. Converter Disambiguation</h4>
<div class="paragraph">
<p>Generally, we inspect the <code>Converter</code> implementations for the source and target types they convert from and to. Depending on whether one of those is a type MongoDB can handle natively, we register the converter instance as a reading or a writing converter. The following examples show a writer converter and a read converter (note the difference is in the order of the qualifiers on <code>Converter</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">// Write converter as only the target type is one Mongo can handle natively
class MyConverter implements Converter&lt;Person, String&gt; { … }

// Read converter as only the source type is one Mongo can handle natively
class MyConverter implements Converter&lt;String, Person&gt; { … }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you write a <code>Converter</code> whose source and target type are native Mongo types, we cannot determine whether we should consider it as a reading or a writing converter. Registering the converter instance as both might lead to unwanted results. For example, a <code>Converter&lt;String, Long&gt;</code> is ambiguous, although it probably does not make sense to try to convert all <code>String</code> instances into <code>Long</code> instances when writing. To let you force the infrastructure to register a converter for only one way, we provide <code>@ReadingConverter</code> and <code>@WritingConverter</code> annotations to be used in the converter implementation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo-template.index-and-collections"><a class="anchor" href="#mongo-template.index-and-collections"></a>10.13. Index and Collection Management</h3>
<div class="paragraph">
<p><code>MongoTemplate</code> provides a few methods for managing indexes and collections. These methods are collected into a helper interface called <code>IndexOperations</code>. You can access these operations by calling the <code>indexOps</code> method and passing in either the collection name or the <code>java.lang.Class</code> of your entity (the collection name is derived from the <code>.class</code>, either by name or from annotation metadata).</p>
</div>
<div class="paragraph">
<p>The following listing shows the <code>IndexOperations</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface IndexOperations {

  void ensureIndex(IndexDefinition indexDefinition);

  void dropIndex(String name);

  void dropAllIndexes();

  void resetIndexCache();

  List&lt;IndexInfo&gt; getIndexInfo();
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.index-and-collections.index"><a class="anchor" href="#mongo-template.index-and-collections.index"></a>10.13.1. Methods for Creating an Index</h4>
<div class="paragraph">
<p>You can create an index on a collection to improve query performance by using the MongoTemplate class, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">mongoTemplate.indexOps(Person.class).ensureIndex(new Index().on("name",Order.ASCENDING));</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ensureIndex</code> makes sure that an index for the provided IndexDefinition exists for the collection.</p>
</div>
<div class="paragraph">
<p>You can create standard, geospatial, and text indexes by using the <code>IndexDefinition</code>, <code>GeoSpatialIndex</code> and <code>TextIndexDefinition</code> classes. For example, given the <code>Venue</code> class defined in a previous section, you could declare a geospatial query, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">mongoTemplate.indexOps(Venue.class).ensureIndex(new GeospatialIndex("location"));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.index-and-collections.access"><a class="anchor" href="#mongo-template.index-and-collections.access"></a>10.13.2. Accessing Index Information</h4>
<div class="paragraph">
<p>The <code>IndexOperations</code> interface has the <code>getIndexInfo</code> method that returns a list of <code>IndexInfo</code> objects. This list contains all the indexes defined on the collection. The following example defines an index on the <code>Person</code> class that has an <code>age</code> property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">template.indexOps(Person.class).ensureIndex(new Index().on("age", Order.DESCENDING).unique(Duplicates.DROP));

List&lt;IndexInfo&gt; indexInfoList = template.indexOps(Person.class).getIndexInfo();

// Contains
// [IndexInfo [fieldSpec={_id=ASCENDING}, name=_id_, unique=false, dropDuplicates=false, sparse=false],
//  IndexInfo [fieldSpec={age=DESCENDING}, name=age_-1, unique=true, dropDuplicates=true, sparse=false]]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.index-and-collections.collection"><a class="anchor" href="#mongo-template.index-and-collections.collection"></a>10.13.3. Methods for Working with a Collection</h4>
<div class="paragraph">
<p>The following example shows how to create a collection:</p>
</div>
<div class="exampleblock">
<div class="title">Example 69. Working with collections by using <code>MongoTemplate</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">DBCollection collection = null;
if (!mongoTemplate.getCollectionNames().contains("MyNewCollection")) {
    collection = mongoTemplate.createCollection("MyNewCollection");
}

mongoTemplate.dropCollection("MyNewCollection");</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>getCollectionNames</strong>: Returns a set of collection names.</p>
</li>
<li>
<p><strong>collectionExists</strong>: Checks to see if a collection with a given name exists.</p>
</li>
<li>
<p><strong>createCollection</strong>: Creates an uncapped collection.</p>
</li>
<li>
<p><strong>dropCollection</strong>: Drops the collection.</p>
</li>
<li>
<p><strong>getCollection</strong>: Gets a collection by name, creating it if it does not exist.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo-template.commands"><a class="anchor" href="#mongo-template.commands"></a>10.14. Executing Commands</h3>
<div class="paragraph">
<p>You can get at the MongoDB driver&#8217;s <code>DB.command( )</code> method by using the <code>executeCommand(…)</code> methods on <code>MongoTemplate</code>. These methods also perform exception translation into Spring&#8217;s <code>DataAccessException</code> hierarchy.</p>
</div>
<div class="sect3">
<h4 id="mongo-template.commands.execution"><a class="anchor" href="#mongo-template.commands.execution"></a>10.14.1. Methods for executing commands</h4>
<div class="ulist">
<ul>
<li>
<p><code>CommandResult</code> <strong>executeCommand</strong> <code>(DBObject command)</code>: Run a MongoDB command.</p>
</li>
<li>
<p><code>CommandResult</code> <strong>executeCommand</strong> <code>(String jsonCommand)</code>: Execute a MongoDB command expressed as a JSON string.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongodb.mapping-usage.events"><a class="anchor" href="#mongodb.mapping-usage.events"></a>10.15. Lifecycle Events</h3>
<div class="paragraph">
<p>The MongoDB mapping framework includes several <code>org.springframework.context.ApplicationEvent</code> events that your application can respond to by registering special beans in the <code>ApplicationContext</code>. Being based on Spring&#8217;s <code>ApplicationContext</code> event infrastructure enables other products, such as Spring Integration, to easily receive these events, as they are a well known eventing mechanism in Spring-based applications.</p>
</div>
<div class="paragraph">
<p>To intercept an object before it goes through the conversion process (which turns your domain object into a <code>com.mongodb.DBObject</code>), you can register a subclass of <code>AbstractMongoEventListener</code> that overrides the <code>onBeforeConvert</code> method. When the event is dispatched, your listener is called and passed the domain object before it goes into the converter. The following example shows how to do so:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class BeforeConvertListener extends AbstractMongoEventListener&lt;Person&gt; {
  @Override
  public void onBeforeConvert(BeforeConvertEvent&lt;Person&gt; event) {
    ... does some auditing manipulation, set timestamps, whatever ...
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To intercept an object before it goes into the database, you can register a subclass of <code>org.springframework.data.mongodb.core.mapping.event.AbstractMongoEventListener</code> that overrides the <code>onBeforeSave</code> method. When the event is dispatched, your listener is called and passed the domain object and the converted <code>com.mongodb.DBObject</code>. The following example shows how to do so:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class BeforeSaveListener extends AbstractMongoEventListener&lt;Person&gt; {
  @Override
  public void onBeforeSave(BeforeSaveEvent&lt;Person&gt; event) {
    … change values, delete them, whatever …
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Declaring these beans in your Spring ApplicationContext causes them to be invoked whenever the event is dispatched.</p>
</div>
<div class="paragraph">
<p>The following callback methods are present in <code>AbstractMappingEventListener</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>onBeforeConvert</code>: Called in <code>MongoTemplate</code> <code>insert</code>, <code>insertList</code>, and <code>save</code> operations before the object is converted to a <code>DBObject</code> by a <code>MongoConverter</code>.</p>
</li>
<li>
<p><code>onBeforeSave</code>: Called in <code>MongoTemplate</code> <code>insert</code>, <code>insertList</code>, and <code>save</code> operations <strong>before</strong> inserting or saving the <code>DBObject</code> in the database.</p>
</li>
<li>
<p><code>onAfterSave</code>: Called in <code>MongoTemplate</code> <code>insert</code>, <code>insertList</code>, and <code>save</code> operations <strong>after</strong> inserting or saving the <code>DBObject</code> in the database.</p>
</li>
<li>
<p><code>onAfterLoad</code>: Called in <code>MongoTemplate</code> <code>find</code>, <code>findAndRemove</code>, <code>findOne</code>, and <code>getCollection</code> methods after the <code>DBObject</code> has been retrieved from the database.</p>
</li>
<li>
<p><code>onAfterConvert</code>: Called in <code>MongoTemplate</code> <code>find</code>, <code>findAndRemove</code>, <code>findOne</code>, and <code>getCollection</code> methods after the <code>DBObject</code> has been retrieved from the database was converted to a POJO.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Lifecycle events are only emitted for root level types. Complex types used as properties within a document root are not subject to event publication unless they are document references annotated with <code>@DBRef</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mongo.exception"><a class="anchor" href="#mongo.exception"></a>10.16. Exception Translation</h3>
<div class="paragraph">
<p>The Spring framework provides exception translation for a wide variety of database and mapping technologies. This has traditionally been for JDBC and JPA. The Spring support for MongoDB extends this feature to the MongoDB Database by providing an implementation of the <code>org.springframework.dao.support.PersistenceExceptionTranslator</code> interface.</p>
</div>
<div class="paragraph">
<p>The motivation behind mapping to Spring&#8217;s <a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/html/dao.html#dao-exceptions">consistent data access exception hierarchy</a> is that you are then able to write portable and descriptive exception handling code without resorting to coding against <a href="https://www.mongodb.org/about/contributors/error-codes/">MongoDB error codes</a>. All of Spring&#8217;s data access exceptions are inherited from the root <code>DataAccessException</code> class so that you can be sure to catch all database related exception within a single try-catch block. Note that not all exceptions thrown by the MongoDB driver inherit from the <code>MongoException</code> class. The inner exception and message are preserved so that no information is lost.</p>
</div>
<div class="paragraph">
<p>Some of the mappings performed by the <code>MongoExceptionTranslator</code> are <code>com.mongodb.Network to DataAccessResourceFailureException</code> and <code>MongoException</code> error codes 1003, 12001, 12010, 12011, and 12012 to <code>InvalidDataAccessApiUsageException</code>. Look into the implementation for more details on the mapping.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongo.executioncallback"><a class="anchor" href="#mongo.executioncallback"></a>10.17. Execution Callbacks</h3>
<div class="paragraph">
<p>One common design feature of all Spring template classes is that all functionality is routed into one of the template&#8217;s execute callback methods. Doing so helps to ensure that exceptions and any resource management that may be required are performed consistently. While JDBC and JMS need this feature much more than MongoDB does, it still offers a single spot for exception translation and logging to occur. Consequently, using these execute callbacks is the preferred way to access the MongoDB driver&#8217;s <code>DB</code> and <code>DBCollection</code> objects to perform uncommon operations that were not exposed as methods on <code>MongoTemplate</code>.</p>
</div>
<div class="paragraph">
<p>The following list describes the execute callback methods.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;T&gt; T</code> <strong>execute</strong> <code>(Class&lt;?&gt; entityClass, CollectionCallback&lt;T&gt; action)</code>: Executes the given <code>CollectionCallback</code> for the entity collection of the specified class.</p>
</li>
<li>
<p><code>&lt;T&gt; T</code> <strong>execute</strong> <code>(String collectionName, CollectionCallback&lt;T&gt; action)</code>: Executes the given <code>CollectionCallback</code> on the collection of the given name.</p>
</li>
<li>
<p><code>&lt;T&gt; T</code> <strong>execute</strong> <code>(DbCallback&lt;T&gt; action)</code>: Executes a DbCallback translating any exceptions as necessary. Spring Data MongoDB provides support for the Aggregation Framework introduced to MongoDB in version 2.2.</p>
</li>
<li>
<p><code>&lt;T&gt; T</code> <strong>execute</strong> <code>(String collectionName, DbCallback&lt;T&gt; action)</code>: Executes a <code>DbCallback</code> on the collection of the given name translating any exceptions as necessary.</p>
</li>
<li>
<p><code>&lt;T&gt; T</code> <strong>executeInSession</strong> <code>(DbCallback&lt;T&gt; action)</code>: Executes the given <code>DbCallback</code> within the same connection to the database so as to ensure consistency in a write-heavy environment where you may read the data that you wrote.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example uses the <code>CollectionCallback</code> to return information about an index:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">boolean hasIndex = template.execute("geolocation", new CollectionCallbackBoolean&gt;() {
  public Boolean doInCollection(Venue.class, DBCollection collection) throws MongoException, DataAccessException {
    List&lt;DBObject&gt; indexes = collection.getIndexInfo();
    for (DBObject dbo : indexes) {
      if ("location_2d".equals(dbo.get("name"))) {
        return true;
      }
    }
    return false;
  }
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="gridfs"><a class="anchor" href="#gridfs"></a>10.18. GridFS Support</h3>
<div class="paragraph">
<p>MongoDB supports storing binary files inside its filesystem, GridFS. Spring Data MongoDB provides a <code>GridFsOperations</code> interface as well as the corresponding implementation, <code>GridFsTemplate</code>, to let you interact with the filesystem. You can set up a <code>GridFsTemplate</code> instance by handing it a <code>MongoDbFactory</code> as well as a <code>MongoConverter</code>, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 70. JavaConfig setup for a GridFsTemplate</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class GridFsConfiguration extends AbstractMongoConfiguration {

  // … further configuration omitted

  @Bean
  public GridFsTemplate gridFsTemplate() {
    return new GridFsTemplate(mongoDbFactory(), mappingMongoConverter());
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The corresponding XML configuration follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 71. XML configuration for a GridFsTemplate</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:mongo="http://www.springframework.org/schema/data/mongo"
  xsi:schemaLocation="http://www.springframework.org/schema/data/mongo
                      http://www.springframework.org/schema/data/mongo/spring-mongo.xsd
                      http://www.springframework.org/schema/beans
                      http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;

  &lt;mongo:db-factory id="mongoDbFactory" dbname="database" /&gt;
  &lt;mongo:mapping-converter id="converter" /&gt;

  &lt;bean class="org.springframework.data.mongodb.gridfs.GridFsTemplate"&gt;
    &lt;constructor-arg ref="mongoDbFactory" /&gt;
    &lt;constructor-arg ref="converter" /&gt;
  &lt;/bean&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The template can now be injected and used to perform storage and retrieval operations, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 72. Using GridFsTemplate to store files</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class GridFsClient {

  @Autowired
  GridFsOperations operations;

  @Test
  public void storeFileToGridFs {

    FileMetadata metadata = new FileMetadata();
    // populate metadata
    Resource file = … // lookup File or Resource

    operations.store(file.getInputStream(), "filename.txt", metadata);
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>store(…)</code> operations take an <code>InputStream</code>, a filename, and (optionally) metadata information about the file to store. The metadata can be an arbitrary object, which will be marshaled by the <code>MongoConverter</code> configured with the <code>GridFsTemplate</code>. Alternatively, you can also provide a <code>DBObject</code>.</p>
</div>
<div class="paragraph">
<p>You can read files from the filesystem through either the <code>find(…)</code> or the <code>getResources(…)</code> methods. Let&#8217;s have a look at the <code>find(…)</code> methods first. You can either find a single file or multiple files that match a <code>Query</code>. You can use the <code>GridFsCriteria</code> helper class to define queries. It provides static factory methods to encapsulate default metadata fields (such as <code>whereFilename()</code> and <code>whereContentType()</code>) or a custom one through <code>whereMetaData()</code>. The following example shows how to use <code>GridFsTemplate</code> to query for files:</p>
</div>
<div class="exampleblock">
<div class="title">Example 73. Using GridFsTemplate to query for files</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class GridFsClient {

  @Autowired
  GridFsOperations operations;

  @Test
  public void findFilesInGridFs {
    List&lt;GridFSDBFile&gt; result = operations.find(query(whereFilename().is("filename.txt")))
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently, MongoDB does not support defining sort criteria when retrieving files from GridFS. For this reason, any sort criteria defined on the <code>Query</code> instance handed into the <code>find(…)</code> method are disregarded.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The other option to read files from the GridFs is to use the methods introduced by the <code>ResourcePatternResolver</code> interface. They allow handing an Ant path into the method and can thus retrieve files matching the given pattern. The following example shows how to use <code>GridFsTemplate</code> to read files:</p>
</div>
<div class="exampleblock">
<div class="title">Example 74. Using GridFsTemplate to read files</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class GridFsClient {

  @Autowired
  GridFsOperations operations;

  @Test
  public void readFilesFromGridFs {
    GridFsResources[] txtFiles = operations.getResources("*.txt");
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>GridFsOperations</code> extends <code>ResourcePatternResolver</code> and lets the <code>GridFsTemplate</code> (for example) to be plugged into an <code>ApplicationContext</code> to read Spring Config files from MongoDB database.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.repositories"><a class="anchor" href="#mongo.repositories"></a>11. MongoDB Repositories</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="mongo-repo-intro"><a class="anchor" href="#mongo-repo-intro"></a>11.1. Introduction</h3>
<div class="paragraph">
<p>This chapter points out the specialties for repository support for MongoDB. This chapter builds on the core repository support explained in <a href="#repositories">Working with Spring Data Repositories</a>. You should have a sound understanding of the basic concepts explained there.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongo-repo-usage"><a class="anchor" href="#mongo-repo-usage"></a>11.2. Usage</h3>
<div class="paragraph">
<p>To access domain entities stored in a MongoDB, you can use our sophisticated repository support that eases implementation quite significantly. To do so, create an interface for your repository, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 75. Sample Person entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class Person {

  @Id
  private String id;
  private String firstname;
  private String lastname;
  private Address address;

  // … getters and setters omitted
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that the domain type shown in the preceding example has a property named <code>id</code> of type <code>ObjectId</code>. The default serialization mechanism used in <code>MongoTemplate</code> (which backs the repository support) regards properties named <code>id</code> as the document ID. Currently, we support <code>String</code>, <code>ObjectId</code>, and <code>BigInteger</code> as ID types. Now that we have a domain object, we can define an interface that uses it, as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 76. Basic repository interface to persist Person entities</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>public interface PersonRepository extends PagingAndSortingRepository&lt;Person, String&gt; {

  // additional custom query methods go here
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Right now this interface serves only to provide type information, but we can add additional methods to it later. To do so, in your Spring configuration, add the following content:</p>
</div>
<div class="exampleblock">
<div class="title">Example 77. General MongoDB repository Spring configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:mongo="http://www.springframework.org/schema/data/mongo"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
    http://www.springframework.org/schema/data/mongo
    http://www.springframework.org/schema/data/mongo/spring-mongo-1.0.xsd"&gt;

  &lt;mongo:mongo id="mongo" /&gt;

  &lt;bean id="mongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
    &lt;constructor-arg ref="mongo" /&gt;
    &lt;constructor-arg value="databaseName" /&gt;
  &lt;/bean&gt;

  &lt;mongo:repositories base-package="com.acme.*.repositories" /&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This namespace element causes the base packages to be scanned for interfaces that extend <code>MongoRepository</code> and create Spring beans for each one found. By default, the repositories get a <code>MongoTemplate</code> Spring bean wired that is called <code>mongoTemplate</code>, so you only need to configure <code>mongo-template-ref</code> explicitly if you deviate from this convention.</p>
</div>
<div class="paragraph">
<p>If you would rather go with Java-based configuration, use the <code>@EnableMongoRepositories</code> annotation. That annotation carries the same attributes as the namespace element. If no base package is configured, the infrastructure scans the package of the annotated configuration class. The following example shows how to use Java configuration for a repository:</p>
</div>
<div class="exampleblock">
<div class="title">Example 78. Java configuration for repositories</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@EnableMongoRepositories
class ApplicationConfig extends AbstractMongoConfiguration {

  @Override
  protected String getDatabaseName() {
    return "e-store";
  }

  @Override
  public Mongo mongo() throws Exception {
    return new Mongo();
  }

  @Override
  protected String getMappingBasePackage() {
    return "com.oreilly.springdata.mongodb"
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Because our domain repository extends <code>PagingAndSortingRepository</code>, it provides you with CRUD operations as well as methods for paginated and sorted access to the entities. Working with the repository instance is just a matter of dependency injecting it into a client. Consequently, accessing the second page of <code>Person</code> objects at a page size of 10 would resemble the following code:</p>
</div>
<div class="exampleblock">
<div class="title">Example 79. Paging access to Person entities</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration
public class PersonRepositoryTests {

    @Autowired PersonRepository repository;

    @Test
    public void readsFirstPageCorrectly() {

      Page&lt;Person&gt; persons = repository.findAll(new PageRequest(0, 10));
      assertThat(persons.isFirstPage(), is(true));
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding example creates an application context with Spring&#8217;s unit test support, which performs annotation-based dependency injection into test cases. Inside the test method, we use the repository to query the datastore. We hand the repository a <code>PageRequest</code> instance that requests the first page of <code>Person</code> objects at a page size of 10.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb.repositories.queries"><a class="anchor" href="#mongodb.repositories.queries"></a>11.3. Query Methods</h3>
<div class="paragraph">
<p>Most of the data access operations you usually trigger on a repository result in a query being executed against the MongoDB databases. Defining such a query is a matter of declaring a method on the repository interface, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 80. PersonRepository with query methods</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface PersonRepository extends PagingAndSortingRepository&lt;Person, String&gt; {

    List&lt;Person&gt; findByLastname(String lastname);                      <i class="conum" data-value="1"></i><b>(1)</b>

    Page&lt;Person&gt; findByFirstname(String firstname, Pageable pageable); <i class="conum" data-value="2"></i><b>(2)</b>

    Person findByShippingAddresses(Address address);                   <i class="conum" data-value="3"></i><b>(3)</b>

    Stream&lt;Person&gt; findAllBy();                                        <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>findByLastname</code> method shows a query for all people with the given last name. The query is derived by parsing the method name for constraints that can be concatenated with <code>And</code> and <code>Or</code>. Thus, the method name results in a query expression of <code>{"lastname" : lastname}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Applies pagination to a query. You can equip your method signature with a <code>Pageable</code> parameter and let the method return a <code>Page</code> instance and Spring Data automatically pages the query accordingly.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Shows that you can query based on properties that are not primitive types. Throws <code>IncorrectResultSizeDataAccessException</code> if more than one match is found.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Uses the <code>First</code> keyword to restrict the query to only the first result. Unlike &lt;3&gt;, this method does not throw an exception if more than one match is found.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Uses a Java 8 <code>Stream</code> that reads and converts individual elements while iterating the stream.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We do not support referring to parameters that are mapped as <code>DBRef</code> in the domain class.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following table shows the keywords that are supported for query methods:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 6. Supported keywords for query methods</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 33.3333%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Keyword</th>
<th class="tableblock halign-left valign-top">Sample</th>
<th class="tableblock halign-left valign-top">Logical result</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>After</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByBirthdateAfter(Date date)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"birthdate" : {"$gt" : date}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GreaterThan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAgeGreaterThan(int age)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"age" : {"$gt" : age}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GreaterThanEqual</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAgeGreaterThanEqual(int age)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"age" : {"$gte" : age}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Before</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByBirthdateBefore(Date date)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"birthdate" : {"$lt" : date}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LessThan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAgeLessThan(int age)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"age" : {"$lt" : age}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LessThanEqual</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAgeLessThanEqual(int age)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"age" : {"$lte" : age}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Between</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAgeBetween(int from, int to)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"age" : {"$gt" : from, "$lt" : to}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>In</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAgeIn(Collection ages)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"age" : {"$in" : [ages&#8230;&#8203;]}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotIn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAgeNotIn(Collection ages)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"age" : {"$nin" : [ages&#8230;&#8203;]}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsNotNull</code>, <code>NotNull</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameNotNull()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : {"$ne" : null}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsNull</code>, <code>Null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameNull()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : null}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Like</code>, <code>StartingWith</code>, <code>EndingWith</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameLike(String name)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : name} (name as regex)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotLike</code>, <code>IsNotLike</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameNotLike(String name)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { "$not" : name }} (name as regex)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Containing</code> on String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameContaining(String name)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : name} (name as regex)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotContaining</code> on String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameNotContaining(String name)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { "$not" : name}} (name as regex)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Containing</code> on Collection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAddressesContaining(Address address)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"addresses" : { "$in" : address}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotContaining</code> on Collection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAddressesNotContaining(Address address)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"addresses" : { "$not" : { "$in" : address}}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Regex</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameRegex(String firstname)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : {"$regex" : firstname }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(No keyword)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstname(String name)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : name}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Not</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameNot(String name)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : {"$ne" : name}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Near</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLocationNear(Point point)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"location" : {"$near" : [x,y]}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Near</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLocationNear(Point point, Distance max)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"location" : {"$near" : [x,y], "$maxDistance" : max}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Near</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLocationNear(Point point, Distance min, Distance max)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"location" : {"$near" : [x,y], "$minDistance" : min, "$maxDistance" : max}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Within</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLocationWithin(Circle circle)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"location" : {"$geoWithin" : {"$center" : [ [x, y], distance]}}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Within</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLocationWithin(Box box)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"location" : {"$geoWithin" : {"$box" : [ [x1, y1], x2, y2]}}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsTrue</code>, <code>True</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByActiveIsTrue()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"active" : true}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsFalse</code>, <code>False</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByActiveIsFalse()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"active" : false}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Exists</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLocationExists(boolean exists)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"location" : {"$exists" : exists }}</code></p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="mongodb.repositories.queries.delete"><a class="anchor" href="#mongodb.repositories.queries.delete"></a>11.3.1. Repository Delete Queries</h4>
<div class="paragraph">
<p>The keywords in the preceding table can be used in conjunction with <code>delete…By</code> or <code>remove…By</code> to create queries that delete matching documents.</p>
</div>
<div class="exampleblock">
<div class="title">Example 81. <code>Delete…By</code> Query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface PersonRepository extends MongoRepository&lt;Person, String&gt; {

  List &lt;Person&gt; deleteByLastname(String lastname);

  Long deletePersonByLastname(String lastname);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Using a return type of <code>List</code> retrieves and returns all matching documents before actually deleting them. A numeric return type directly removes the matching documents, returning the total number of documents removed.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.geo-spatial"><a class="anchor" href="#mongodb.repositories.queries.geo-spatial"></a>11.3.2. Geo-spatial Repository Queries</h4>
<div class="paragraph">
<p>As you saw in the preceding table of keywords, a few keywords trigger geo-spatial operations within a MongoDB query. The <code>Near</code> keyword allows some further modification, as the next few examples show.</p>
</div>
<div class="paragraph">
<p>The following example shows how to define a <code>near</code> query that finds all persons with a given distance of a given point:</p>
</div>
<div class="exampleblock">
<div class="title">Example 82. Advanced <code>Near</code> queries</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface PersonRepository extends MongoRepository&lt;Person, String&gt;

  // { 'location' : { '$near' : [point.x, point.y], '$maxDistance' : distance}}
  List&lt;Person&gt; findByLocationNear(Point location, Distance distance);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Adding a <code>Distance</code> parameter to the query method allows restricting results to those within the given distance. If the <code>Distance</code> was set up containing a <code>Metric</code>, we transparently use <code>$nearSphere</code> instead of <code>$code</code>, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 83. Using <code>Distance</code> with <code>Metrics</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Point point = new Point(43.7, 48.8);
Distance distance = new Distance(200, Metrics.KILOMETERS);
… = repository.findByLocationNear(point, distance);
// {'location' : {'$nearSphere' : [43.7, 48.8], '$maxDistance' : 0.03135711885774796}}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Using a <code>Distance</code> with a <code>Metric</code> causes a <code>$nearSphere</code> (instead of a plain <code>$near</code>) clause to be added. Beyond that, the actual distance gets calculated according to the <code>Metrics</code> used.</p>
</div>
<div class="paragraph">
<p>(Note that <code>Metric</code> does not refer to metric units of measure. It could be miles rather than kilometers. Rather, <code>metric</code> refers to the concept of a system of measurement, regardless of which system you use.)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using <code>@GeoSpatialIndexed(type = GeoSpatialIndexType.GEO_2DSPHERE)</code> on the target property forces usage of the <code>$nearSphere</code> operator.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_geo_near_queries"><a class="anchor" href="#_geo_near_queries"></a>Geo-near Queries</h5>
<div class="paragraph">
<p>Spring Data MongoDb supports geo-near queries, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface PersonRepository extends MongoRepository&lt;Person, String&gt;

  // {'geoNear' : 'location', 'near' : [x, y] }
  GeoResults&lt;Person&gt; findByLocationNear(Point location);

  // No metric: {'geoNear' : 'person', 'near' : [x, y], maxDistance : distance }
  // Metric: {'geoNear' : 'person', 'near' : [x, y], 'maxDistance' : distance,
  //          'distanceMultiplier' : metric.multiplier, 'spherical' : true }
  GeoResults&lt;Person&gt; findByLocationNear(Point location, Distance distance);

  // Metric: {'geoNear' : 'person', 'near' : [x, y], 'minDistance' : min,
  //          'maxDistance' : max, 'distanceMultiplier' : metric.multiplier,
  //          'spherical' : true }
  GeoResults&lt;Person&gt; findByLocationNear(Point location, Distance min, Distance max);

  // {'geoNear' : 'location', 'near' : [x, y] }
  GeoResults&lt;Person&gt; findByLocationNear(Point location);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.json-based"><a class="anchor" href="#mongodb.repositories.queries.json-based"></a>11.3.3. MongoDB JSON-based Query Methods and Field Restriction</h4>
<div class="paragraph">
<p>By adding the <code>org.springframework.data.mongodb.repository.Query</code> annotation to your repository query methods, you can specify a MongoDB JSON query string to use instead of having the query be derived from the method name, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface PersonRepository extends MongoRepository&lt;Person, String&gt;

  @Query("{ 'firstname' : ?0 }")
  List&lt;Person&gt; findByThePersonsFirstname(String firstname);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>?0</code> placeholder lets you substitute the value from the method arguments into the JSON query string.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>String</code> parameter values are escaped during the binding process, which means that it is not possible to add MongoDB specific operators through the argument.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also use the filter property to restrict the set of properties that is mapped into the Java object, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface PersonRepository extends MongoRepository&lt;Person, String&gt;

  @Query(value="{ 'firstname' : ?0 }", fields="{ 'firstname' : 1, 'lastname' : 1}")
  List&lt;Person&gt; findByThePersonsFirstname(String firstname);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The query in the preceding example returns only the <code>firstname</code>, <code>lastname</code> and <code>Id</code> properties of the <code>Person</code> objects. The <code>age</code> property, a <code>java.lang.Integer</code>, is not set and its value is therefore null.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.json-spel"><a class="anchor" href="#mongodb.repositories.queries.json-spel"></a>11.3.4. JSON-based Queries with SpEL Expressions</h4>
<div class="paragraph">
<p>Query strings and field definitions can be used together with SpEL expressions to create dynamic queries at runtime.
SpEL expressions can provide predicate values and can be used to extend predicates with subdocuments.</p>
</div>
<div class="paragraph">
<p>Expressions expose method arguments through an array that contains all the arguments. The following query uses <code>[0]</code>
to declare the predicate value for <code>lastname</code> (which is equivalent to the <code>?0</code> parameter binding):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface PersonRepository extends MongoRepository&lt;Person, String&gt;

  @Query("{'lastname': ?#{[0]} }")
  List&lt;Person&gt; findByQueryWithExpression(String param0);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Expressions can be used to invoke functions, evaluate conditionals, and construct values. SpEL expressions
used in conjunction with JSON reveal a side-effect, because Map-like declarations inside of SpEL read like JSON, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface PersonRepository extends MongoRepository&lt;Person, String&gt;

  @Query("{'id': ?#{ [0] ? {$exists :true} : [1] }}")
  List&lt;Person&gt; findByQueryWithExpressionAndNestedObject(boolean param0, String param1);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>SpEL in query strings can be a powerful way to enhance queries. However, they can also accept a broad range of unwanted arguments.
You should make sure to sanitize strings before passing them to the query to avoid unwanted changes to your query.</p>
</div>
<div class="paragraph">
<p>Expression support is extensible through the Query SPI: <code>org.springframework.data.repository.query.spi.EvaluationContextExtension</code>.
The Query SPI can contribute properties and functions and can customize the root object. Extensions are retrieved from the application context
at the time of SpEL evaluation when the query is built. The following example shows how to use <code>EvaluationContextExtension</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class SampleEvaluationContextExtension extends EvaluationContextExtensionSupport {

  @Override
  public String getExtensionId() {
    return "security";
  }

  @Override
  public Map&lt;String, Object&gt; getProperties() {
    return Collections.singletonMap("principal", SecurityContextHolder.getCurrent().getPrincipal());
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Bootstrapping <code>MongoRepositoryFactory</code> yourself is not application context-aware and requires further configuration
to pick up Query SPI extensions.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.type-safe"><a class="anchor" href="#mongodb.repositories.queries.type-safe"></a>11.3.5. Type-safe Query Methods</h4>
<div class="paragraph">
<p>MongoDB repository support integrates with the <a href="http://www.querydsl.com/">Querydsl</a> project, which provides a way to perform type-safe queries. To quote from the project description, "Instead of writing queries as inline strings or externalizing them into XML files they are constructed via a fluent API." It provides the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Code completion in the IDE (all properties, methods, and operations can be expanded in your favorite Java IDE).</p>
</li>
<li>
<p>Almost no syntactically invalid queries allowed (type-safe on all levels).</p>
</li>
<li>
<p>Domain types and properties can be referenced safely&#8201;&#8212;&#8201;no strings involved!</p>
</li>
<li>
<p>Adapts better to refactoring changes in domain types.</p>
</li>
<li>
<p>Incremental query definition is easier.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See the <a href="http://www.querydsl.com/static/querydsl/latest/reference/html/">QueryDSL documentation</a> for how to bootstrap your environment for APT-based code generation using Maven or Ant.</p>
</div>
<div class="paragraph">
<p>QueryDSL lets you write queries such as the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">QPerson person = new QPerson("person");
List&lt;Person&gt; result = repository.findAll(person.address.zipCode.eq("C0123"));

Page&lt;Person&gt; page = repository.findAll(person.lastname.contains("a"),
                                       new PageRequest(0, 2, Direction.ASC, "lastname"));</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>QPerson</code> is a class that is generated by the Java annotation post-processing tool. It is a <code>Predicate</code> that lets you write type-safe queries. Notice that there are no strings in the query other than the <code>C0123</code> value.</p>
</div>
<div class="paragraph">
<p>You can use the generated <code>Predicate</code> class by using the <code>QuerydslPredicateExecutor</code> interface, which the following listing shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface QuerydslPredicateExecutor&lt;T&gt; {

  T findOne(Predicate predicate);

  List&lt;T&gt; findAll(Predicate predicate);

  List&lt;T&gt; findAll(Predicate predicate, OrderSpecifier&lt;?&gt;... orders);

  Page&lt;T&gt; findAll(Predicate predicate, Pageable pageable);

  Long count(Predicate predicate);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use this in your repository implementation, add it to the list of repository interfaces from which your interface inherits, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface PersonRepository extends MongoRepository&lt;Person, String&gt;, QuerydslPredicateExecutor&lt;Person&gt; {

   // additional query methods go here
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.full-text"><a class="anchor" href="#mongodb.repositories.queries.full-text"></a>11.3.6. Full-text Search Queries</h4>
<div class="paragraph">
<p>MongoDB&#8217;s full-text search feature is store-specific and, therefore, can be found on <code>MongoRepository</code> rather than on the more general <code>CrudRepository</code>. We need a document with a full-text index (see &#8220;<a href="#mapping-usage-indexes.text-index">Text Indexes</a>&#8221; to learn how to create a full-text index).</p>
</div>
<div class="paragraph">
<p>Additional methods on <code>MongoRepository</code> take <code>TextCriteria</code> as an input parameter. In addition to those explicit methods, it is also possible to add a <code>TextCriteria</code>-derived repository method. The criteria are added as an additional <code>AND</code> criteria. Once the entity contains a <code>@TextScore</code>-annotated property, the document&#8217;s full-text score can be retrieved. Furthermore, the <code>@TextScore</code> annotated also makes it possible to sort by the document&#8217;s score, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Document
class FullTextDocument {

  @Id String id;
  @TextIndexed String title;
  @TextIndexed String content;
  @TextScore Float score;
}

interface FullTextRepository extends Repository&lt;FullTextDocument, String&gt; {

  // Execute a full-text search and define sorting dynamically
  List&lt;FullTextDocument&gt; findAllBy(TextCriteria criteria, Sort sort);

  // Paginate over a full-text search result
  Page&lt;FullTextDocument&gt; findAllBy(TextCriteria criteria, Pageable pageable);

  // Combine a derived query with a full-text search
  List&lt;FullTextDocument&gt; findByTitleOrderByScoreDesc(String title, TextCriteria criteria);
}


Sort sort = new Sort("score");
TextCriteria criteria = TextCriteria.forDefaultLanguage().matchingAny("spring", "data");
List&lt;FullTextDocument&gt; result = repository.findAllBy(criteria, sort);

criteria = TextCriteria.forDefaultLanguage().matching("film");
Page&lt;FullTextDocument&gt; page = repository.findAllBy(criteria, new PageRequest(1, 1, sort));
List&lt;FullTextDocument&gt; result = repository.findByTitleOrderByScoreDesc("mongodb", criteria);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="projections"><a class="anchor" href="#projections"></a>11.3.7. Projections</h4>
<div class="paragraph">
<p>Spring Data query methods usually return one or multiple instances of the aggregate root managed by the repository.
However, it might sometimes be desirable to create projections based on certain attributes of those types.
Spring Data allows modeling dedicated return types, to more selectively retrieve partial views of the managed aggregates.</p>
</div>
<div class="paragraph">
<p>Imagine a repository and aggregate root type such as the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 84. A sample aggregate and repository</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class Person {

  @Id UUID id;
  String firstname, lastname;
  Address address;

  static class Address {
    String zipCode, city, street;
  }
}

interface PersonRepository extends Repository&lt;Person, UUID&gt; {

  Collection&lt;Person&gt; findByLastname(String lastname);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now imagine that we want to retrieve the person&#8217;s name attributes only.
What means does Spring Data offer to achieve this? The rest of this chapter answers that question.</p>
</div>
<div class="sect4">
<h5 id="projections.interfaces"><a class="anchor" href="#projections.interfaces"></a>Interface-based Projections</h5>
<div class="paragraph">
<p>The easiest way to limit the result of the queries to only the name attributes is by declaring an interface that exposes accessor methods for the properties to be read, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 85. A projection interface to retrieve a subset of attributes</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface NamesOnly {

  String getFirstname();
  String getLastname();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The important bit here is that the properties defined here exactly match properties in the aggregate root.
Doing so lets a query method be added as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 86. A repository using an interface based projection with a query method</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface PersonRepository extends Repository&lt;Person, UUID&gt; {

  Collection&lt;NamesOnly&gt; findByLastname(String lastname);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The query execution engine creates proxy instances of that interface at runtime for each element returned and forwards calls to the exposed methods to the target object.</p>
</div>
<div id="projections.interfaces.nested" class="paragraph">
<p>Projections can be used recursively. If you want to include some of the <code>Address</code> information as well, create a projection interface for that and return that interface from the declaration of <code>getAddress()</code>, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 87. A projection interface to retrieve a subset of attributes</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface PersonSummary {

  String getFirstname();
  String getLastname();
  AddressSummary getAddress();

  interface AddressSummary {
    String getCity();
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>On method invocation, the <code>address</code> property of the target instance is obtained and wrapped into a projecting proxy in turn.</p>
</div>
<div class="sect5">
<h6 id="projections.interfaces.closed"><a class="anchor" href="#projections.interfaces.closed"></a>Closed Projections</h6>
<div class="paragraph">
<p>A projection interface whose accessor methods all match properties of the target aggregate is considered to be a closed projection. The following example (which we used earlier in this chapter, too) is a closed projection:</p>
</div>
<div class="exampleblock">
<div class="title">Example 88. A closed projection</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface NamesOnly {

  String getFirstname();
  String getLastname();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you use a closed projection, Spring Data can optimize the query execution, because we know about all the attributes that are needed to back the projection proxy.
For more details on that, see the module-specific part of the reference documentation.</p>
</div>
</div>
<div class="sect5">
<h6 id="projections.interfaces.open"><a class="anchor" href="#projections.interfaces.open"></a>Open Projections</h6>
<div class="paragraph">
<p>Accessor methods in projection interfaces can also be used to compute new values by using the <code>@Value</code> annotation, as shown in the following example:</p>
</div>
<div id="projections.interfaces.open.simple" class="exampleblock">
<div class="title">Example 89. An Open Projection</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface NamesOnly {

  @Value("#{target.firstname + ' ' + target.lastname}")
  String getFullName();
  …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The aggregate root backing the projection is available in the <code>target</code> variable.
A projection interface using <code>@Value</code> is an open projection.
Spring Data cannot apply query execution optimizations in this case, because the SpEL expression could use any attribute of the aggregate root.</p>
</div>
<div class="paragraph">
<p>The expressions used in <code>@Value</code> should not be too complex&#8201;&#8212;&#8201;you want to avoid programming in <code>String</code> variables.
For very simple expressions, one option might be to resort to default methods (introduced in Java 8), as shown in the following example:</p>
</div>
<div id="projections.interfaces.open.default" class="exampleblock">
<div class="title">Example 90. A projection interface using a default method for custom logic</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface NamesOnly {

  String getFirstname();
  String getLastname();

  default String getFullName() {
    return getFirstname.concat(" ").concat(getLastname());
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This approach requires you to be able to implement logic purely based on the other accessor methods exposed on the projection interface.
A second, more flexible, option is to implement the custom logic in a Spring bean and then invoke that from the SpEL expression, as shown in the following example:</p>
</div>
<div id="projections.interfaces.open.bean-reference" class="exampleblock">
<div class="title">Example 91. Sample Person object</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Component
class MyBean {

  String getFullName(Person person) {
    …
  }
}

interface NamesOnly {

  @Value("#{@myBean.getFullName(target)}")
  String getFullName();
  …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Notice how the SpEL expression refers to <code>myBean</code> and invokes the <code>getFullName(…)</code> method and forwards the projection target as a method parameter.
Methods backed by SpEL expression evaluation can also use method parameters, which can then be referred to from the expression.
The method parameters are available through an <code>Object</code> array named <code>args</code>. The following example shows how to get a method parameter from the <code>args</code> array:</p>
</div>
<div class="exampleblock">
<div class="title">Example 92. Sample Person object</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface NamesOnly {

  @Value("#{args[0] + ' ' + target.firstname + '!'}")
  String getSalutation(String prefix);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Again, for more complex expressions, you should use a Spring bean and let the expression invoke a method, as described <a href="#projections.interfaces.open.bean-reference">earlier</a>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="projections.dtos"><a class="anchor" href="#projections.dtos"></a>Class-based Projections (DTOs)</h5>
<div class="paragraph">
<p>Another way of defining projections is by using value type DTOs (Data Transfer Objects) that hold properties for the fields that are supposed to be retrieved.
These DTO types can be used in exactly the same way projection interfaces are used, except that no proxying happens and no nested projections can be applied.</p>
</div>
<div class="paragraph">
<p>If the store optimizes the query execution by limiting the fields to be loaded, the fields to be loaded are determined from the parameter names of the constructor that is exposed.</p>
</div>
<div class="paragraph">
<p>The following example shows a projecting DTO:</p>
</div>
<div class="exampleblock">
<div class="title">Example 93. A projecting DTO</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class NamesOnly {

  private final String firstname, lastname;

  NamesOnly(String firstname, String lastname) {

    this.firstname = firstname;
    this.lastname = lastname;
  }

  String getFirstname() {
    return this.firstname;
  }

  String getLastname() {
    return this.lastname;
  }

  // equals(…) and hashCode() implementations
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Avoid boilerplate code for projection DTOs</div>
<div class="paragraph">
<p>You can dramatically simplify the code for a DTO by using <a href="https://projectlombok.org">Project Lombok</a>, which provides an <code>@Value</code> annotation (not to be confused with Spring&#8217;s <code>@Value</code> annotation shown in the earlier interface examples).
If you use Project Lombok&#8217;s <code>@Value</code> annotation, the sample DTO shown earlier would become the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Value
class NamesOnly {
	String firstname, lastname;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fields are <code>private final</code> by default, and the class exposes a constructor that takes all fields and automatically gets <code>equals(…)</code> and <code>hashCode()</code> methods implemented.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="projection.dynamic"><a class="anchor" href="#projection.dynamic"></a>Dynamic Projections</h5>
<div class="paragraph">
<p>So far, we have used the projection type as the return type or element type of a collection.
However, you might want to select the type to be used at invocation time (which makes it dynamic).
To apply dynamic projections, use a query method such as the one shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 94. A repository using a dynamic projection parameter</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface PersonRepository extends Repository&lt;Person, UUID&gt; {

  &lt;T&gt; Collection&lt;T&gt; findByLastname(String lastname, Class&lt;T&gt; type);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This way, the method can be used to obtain the aggregates as is or with a projection applied, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 95. Using a repository with dynamic projections</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">void someMethod(PersonRepository people) {

  Collection&lt;Person&gt; aggregates =
    people.findByLastname("Matthews", Person.class);

  Collection&lt;NamesOnly&gt; aggregates =
    people.findByLastname("Matthews", NamesOnly.class);
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongodb.repositories.misc.cdi-integration"><a class="anchor" href="#mongodb.repositories.misc.cdi-integration"></a>11.4. CDI Integration</h3>
<div class="paragraph">
<p>Instances of the repository interfaces are usually created by a container, and Spring is the most natural choice when working with Spring Data. As of version 1.3.0, Spring Data MongoDB ships with a custom CDI extension that lets you use the repository abstraction in CDI environments. The extension is part of the JAR. To activate it, drop the Spring Data MongoDB JAR into your classpath. You can now set up the infrastructure by implementing a CDI Producer for the <code>MongoTemplate</code>, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class MongoTemplateProducer {

    @Produces
    @ApplicationScoped
    public MongoOperations createMongoTemplate() throws UnknownHostException, MongoException {

        MongoDbFactory factory = new SimpleMongoDbFactory(new Mongo(), "database");
        return new MongoTemplate(factory);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Spring Data MongoDB CDI extension picks up the <code>MongoTemplate</code> available as a CDI bean and creates a proxy for a Spring Data repository whenever a bean of a repository type is requested by the container. Thus, obtaining an instance of a Spring Data repository is a matter of declaring an <code>@Inject</code>-ed property, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class RepositoryClient {

  @Inject
  PersonRepository repository;

  public void businessMethod() {
    List&lt;Person&gt; people = repository.findAll();
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="auditing"><a class="anchor" href="#auditing"></a>12. Auditing</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="auditing.basics"><a class="anchor" href="#auditing.basics"></a>12.1. Basics</h3>
<div class="paragraph">
<p>Spring Data provides sophisticated support to transparently keep track of who created or changed an entity and when the change happened. To benefit from that functionality, you have to equip your entity classes with auditing metadata that can be defined either using annotations or by implementing an interface.</p>
</div>
<div class="sect3">
<h4 id="auditing.annotations"><a class="anchor" href="#auditing.annotations"></a>12.1.1. Annotation-based Auditing Metadata</h4>
<div class="paragraph">
<p>We provide <code>@CreatedBy</code> and <code>@LastModifiedBy</code> to capture the user who created or modified the entity as well as <code>@CreatedDate</code> and <code>@LastModifiedDate</code> to capture when the change happened.</p>
</div>
<div class="exampleblock">
<div class="title">Example 96. An audited entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class Customer {

  @CreatedBy
  private User user;

  @CreatedDate
  private DateTime createdDate;

  // … further properties omitted
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As you can see, the annotations can be applied selectively, depending on which information you want to capture. The annotations capturing when changes were made can be used on properties of type Joda-Time, <code>DateTime</code>, legacy Java <code>Date</code> and <code>Calendar</code>, JDK8 date and time types, and <code>long</code> or <code>Long</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="auditing.interfaces"><a class="anchor" href="#auditing.interfaces"></a>12.1.2. Interface-based Auditing Metadata</h4>
<div class="paragraph">
<p>In case you do not want to use annotations to define auditing metadata, you can let your domain class implement the <code>Auditable</code> interface. It exposes setter methods for all of the auditing properties.</p>
</div>
<div class="paragraph">
<p>There is also a convenience base class, <code>AbstractAuditable</code>, which you can extend to avoid the need to manually implement the interface methods. Doing so increases the coupling of your domain classes to Spring Data, which might be something you want to avoid. Usually, the annotation-based way of defining auditing metadata is preferred as it is less invasive and more flexible.</p>
</div>
</div>
<div class="sect3">
<h4 id="auditing.auditor-aware"><a class="anchor" href="#auditing.auditor-aware"></a>12.1.3. <code>AuditorAware</code></h4>
<div class="paragraph">
<p>In case you use either <code>@CreatedBy</code> or <code>@LastModifiedBy</code>, the auditing infrastructure somehow needs to become aware of the current principal. To do so, we provide an <code>AuditorAware&lt;T&gt;</code> SPI interface that you have to implement to tell the infrastructure who the current user or system interacting with the application is. The generic type <code>T</code> defines what type the properties annotated with <code>@CreatedBy</code> or <code>@LastModifiedBy</code> have to be.</p>
</div>
<div class="paragraph">
<p>The following example shows an implementation of the interface that uses Spring Security&#8217;s <code>Authentication</code> object:</p>
</div>
<div class="exampleblock">
<div class="title">Example 97. Implementation of AuditorAware based on Spring Security</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class SpringSecurityAuditorAware implements AuditorAware&lt;User&gt; {

  public User getCurrentAuditor() {

    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();

    if (authentication == null || !authentication.isAuthenticated()) {
      return null;
    }

    return ((MyUserDetails) authentication.getPrincipal()).getUser();
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The implementation accesses the <code>Authentication</code> object provided by Spring Security and looks up the custom <code>UserDetails</code> instance that you have created in your <code>UserDetailsService</code> implementation. We assume here that you are exposing the domain user through the <code>UserDetails</code> implementation but that, based on the <code>Authentication</code> found, you could also look it up from anywhere.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.auditing"><a class="anchor" href="#mongo.auditing"></a>12.2. General Auditing Configuration for MongoDB</h3>
<div class="paragraph">
<p>To activate auditing functionality, add the Spring Data Mongo <code>auditing</code> namespace element to your configuration, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 98. Activating auditing by using XML configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;mongo:auditing mapping-context-ref="customMappingContext" auditor-aware-ref="yourAuditorAwareImpl"/&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Since Spring Data MongoDB 1.4, auditing can be enabled by annotating a configuration class with the <code>@EnableMongoAuditing</code> annotation, as the followign example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 99. Activating auditing using JavaConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
@EnableMongoAuditing
class Config {

  @Bean
  public AuditorAware&lt;AuditableUser&gt; myAuditorProvider() {
      return new AuditorAwareImpl();
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you expose a bean of type <code>AuditorAware</code> to the <code>ApplicationContext</code>, the auditing infrastructure picks it up automatically and uses it to determine the current user to be set on domain types. If you have multiple implementations registered in the <code>ApplicationContext</code>, you can select the one to be used by explicitly setting the <code>auditorAwareRef</code> attribute of <code>@EnableMongoAuditing</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mapping-chapter"><a class="anchor" href="#mapping-chapter"></a>13. Mapping</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rich mapping support is provided by the <code>MappingMongoConverter</code>. <code>MappingMongoConverter</code> has a rich metadata model that provides a full feature set to map domain objects to MongoDB documents. The mapping metadata model is populated by using annotations on your domain objects. However, the infrastructure is not limited to using annotations as the only source of metadata information. The <code>MappingMongoConverter</code> also lets you map objects to documents without providing any additional metadata, by following a set of conventions.</p>
</div>
<div class="paragraph">
<p>This section describes the features of the <code>MappingMongoConverter</code>, including how to use conventions for mapping objects to documents and how to override those conventions with annotation-based mapping metadata.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>SimpleMongoConverter</code> has been deprecated in Spring Data MongoDB M3 as all of its functionality has been subsumed into <code>MappingMongoConverter</code>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="mapping-conventions"><a class="anchor" href="#mapping-conventions"></a>13.1. Convention-based Mapping</h3>
<div class="paragraph">
<p><code>MappingMongoConverter</code> has a few conventions for mapping objects to documents when no additional mapping metadata is provided. The conventions are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The short Java class name is mapped to the collection name in the following manner. The class <code>com.bigbank.SavingsAccount</code> maps to the <code>savingsAccount</code> collection name.</p>
</li>
<li>
<p>All nested objects are stored as nested objects in the document and <strong>not</strong> as DBRefs.</p>
</li>
<li>
<p>The converter uses any Spring Converters registered with it to override the default mapping of object properties to document fields and values.</p>
</li>
<li>
<p>The fields of an object are used to convert to and from fields in the document. Public <code>JavaBean</code> properties are not used.</p>
</li>
<li>
<p>If you have a single non-zero-argument constructor whose constructor argument names match top-level field names of document, that constructor is used. Otherwise, the zero-argument constructor is used. If there is more than one non-zero-argument constructor, an exception will be thrown.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="mapping.conventions.id-field"><a class="anchor" href="#mapping.conventions.id-field"></a>13.1.1. How the <code>_id</code> field is handled in the mapping layer.</h4>
<div class="paragraph">
<p>MongoDB requires that you have an <code>_id</code> field for all documents. If you don&#8217;t provide one the driver will assign a ObjectId with a generated value. The "_id" field can be of any type the, other than arrays, so long as it is unique. The driver naturally supports all primitive types and Dates. When using the <code>MappingMongoConverter</code> there are certain rules that govern how properties from the Java class is mapped to this <code>_id</code> field.</p>
</div>
<div class="paragraph">
<p>The following outlines what field will be mapped to the <code>_id</code> document field:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A field annotated with <code>@Id</code> (<code>org.springframework.data.annotation.Id</code>) will be mapped to the <code>_id</code> field.</p>
</li>
<li>
<p>A field without an annotation but named <code>id</code> will be mapped to the <code>_id</code> field.</p>
</li>
<li>
<p>The default field name for identifiers is <code>_id</code> and can be customized via the <code>@Field</code> annotation.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 7. Examples for the translation of <code>_id</code> field definitions</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field definition</th>
<th class="tableblock halign-left valign-top">Resulting Id-Fieldname in MongoDB</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code> id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>_id</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Field</code> <code>String</code> id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>_id</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Field("x")</code> <code>String</code> id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Id</code> <code>String</code> x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>_id</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Field("x")</code> <code>@Id</code> <code>String</code> x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>_id</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following outlines what type conversion, if any, will be done on the property mapped to the _id document field.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a field named <code>id</code> is declared as a String or BigInteger in the Java class it will be converted to and stored as an ObjectId if possible. ObjectId as a field type is also valid. If you specify a value for <code>id</code> in your application, the conversion to an ObjectId is detected to the MongoDBdriver. If the specified <code>id</code> value cannot be converted to an ObjectId, then the value will be stored as is in the document&#8217;s _id field.</p>
</li>
<li>
<p>If a field named <code>id</code> id field is not declared as a String, BigInteger, or ObjectID in the Java class then you should assign it a value in your application so it can be stored 'as-is' in the document&#8217;s _id field.</p>
</li>
<li>
<p>If no field named <code>id</code> is present in the Java class then an implicit <code>_id</code> file will be generated by the driver but not mapped to a property or field of the Java class.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When querying and updating <code>MongoTemplate</code> will use the converter to handle conversions of the <code>Query</code> and <code>Update</code> objects that correspond to the above rules for saving documents so field names and types used in your queries will be able to match what is in your domain classes.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-conversion"><a class="anchor" href="#mapping-conversion"></a>13.2. Data Mapping and Type Conversion</h3>
<div class="paragraph">
<p>This section explains how types are mapped to and from a MongoDB representation. Spring Data MongoDB supports all types that can be represented as BSON, MongoDB&#8217;s internal document format.
In addition to these types, Spring Data MongoDB provides a set of built-in converters to map additional types. You can provide your own converters to adjust type conversion. See <a href="#mapping-explicit-converters">Overriding Mapping with Explicit Converters</a> for further details.</p>
</div>
<div class="paragraph">
<p>The following provides samples of each available type conversion:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 8. Type</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 10%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Type conversion</th>
<th class="tableblock halign-left valign-top">Sample</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : "Dave"}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>double</code>, <code>Double</code>, <code>float</code>, <code>Float</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"weight" : 42.5}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code>, <code>Integer</code>, <code>short</code>, <code>Short</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native<br>
32-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"height" : 42}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code>, <code>Long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native<br>
64-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"height" : 42}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Date</code>, <code>Timestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"date" : ISODate("2019-11-12T23:00:00.809Z")}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byte[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"bin" : { "$binary" : "AQIDBA==", "$type" : "00" }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.UUID</code> (Legacy UUID)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"uuid" : { "$binary" : "MEaf1CFQ6lSphaa3b9AtlA==", "$type" : "03" }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"date" : ISODate("2019-11-12T23:00:00.809Z")}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ObjectId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"_id" : ObjectId("5707a2690364aba3136ab870")}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array, <code>List</code>, <code>BasicDBList</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"cookies" : [ … ]}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code>, <code>Boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"active" : true}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"value" : null}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DBObject</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"value" : { … }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Decimal128</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"value" : NumberDecimal(…)}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AtomicInteger</code><br>
calling <code>get()</code> before the actual conversion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter<br>
32-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"value" : "741" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AtomicLong</code><br>
calling <code>get()</code> before the actual conversion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter<br>
64-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"value" : "741" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BigInteger</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter<br>
<code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"value" : "741" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BigDecimal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter<br>
<code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"value" : "741.99" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>URL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"website" : "http://projects.spring.io/spring-data-mongodb/" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Locale</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"locale : "en_US" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>char</code>, <code>Character</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"char" : "a" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NamedMongoScript</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter<br>
<code>Code</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"_id" : "script name", value: (some javascript code)</code>}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Currency</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"currencyCode" : "EUR"}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalDate</code><br>
(Joda, Java 8, JSR310-BackPort)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"date" : ISODate("2019-11-12T00:00:00.000Z")}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalDateTime</code>, <code>LocalTime</code>, <code>Instant</code><br>
(Joda, Java 8, JSR310-BackPort)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"date" : ISODate("2019-11-12T23:00:00.809Z")}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DateTime</code> (Joda)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"date" : ISODate("2019-11-12T23:00:00.809Z")}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DateMidnight</code> (Joda)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"date" : ISODate("2019-11-12T00:00:00.000Z")}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ZoneId</code> (Java 8, JSR310-BackPort)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"zoneId" : "ECT - Europe/Paris"}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Box</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"box" : { "first" : { "x" : 1.0 , "y" : 2.0} , "second" : { "x" : 3.0 , "y" : 4.0}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Polygon</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"polygon" : { "points" : [ { "x" : 1.0 , "y" : 2.0} , { "x" : 3.0 , "y" : 4.0} , { "x" : 4.0 , "y" : 5.0}]}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Circle</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"circle" : { "center" : { "x" : 1.0 , "y" : 2.0} , "radius" : 3.0 , "metric" : "NEUTRAL"}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Point</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"point" : { "x" : 1.0 , "y" : 2.0}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoJsonPoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"point" : { "type" : "Point" , "coordinates" : [3.0 , 4.0] }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoJsonMultiPoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"geoJsonLineString" : {"type":"MultiPoint", "coordinates": [ [ 0 , 0 ], [ 0 , 1 ], [ 1 , 1 ] ] }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Sphere</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"sphere" : { "center" : { "x" : 1.0 , "y" : 2.0} , "radius" : 3.0 , "metric" : "NEUTRAL"}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoJsonPolygon</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"polygon" : { "type" : "Polygon", "coordinates" : [[ [ 0 , 0 ], [ 3 , 6 ], [ 6 , 1 ], [ 0 , 0 ] ]] }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoJsonMultiPolygon</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"geoJsonMultiPolygon" : { "type" : "MultiPolygon", "coordinates" : [
[ [ [ -73.958 , 40.8003 ] , [ -73.9498 , 40.7968 ] ] ],
[ [ [ -73.973 , 40.7648 ] , [ -73.9588 , 40.8003 ] ] ]
] }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoJsonLineString</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{ "geoJsonLineString" : { "type" : "LineString", "coordinates" : [ [ 40 , 5 ], [ 41 , 6 ] ] }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoJsonMultiLineString</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"geoJsonLineString" : { "type" : "MultiLineString", coordinates: [
[ [ -73.97162 , 40.78205 ], [ -73.96374 , 40.77715 ] ],
[ [ -73.97880 , 40.77247 ], [ -73.97036 , 40.76811 ] ]
] }}</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="mapping-configuration"><a class="anchor" href="#mapping-configuration"></a>13.3. Mapping Configuration</h3>
<div class="paragraph">
<p>Unless explicitly configured, an instance of <code>MappingMongoConverter</code> is created by default when you create a <code>MongoTemplate</code>. You can create your own instance of the <code>MappingMongoConverter</code>. Doing so lets you dictate where in the classpath your domain classes can be found, so that Spring Data MongoDB can extract metadata and construct indexes. Also, by creating your own instance, you can register Spring converters to map specific classes to and from the database.</p>
</div>
<div class="paragraph">
<p>You can configure the <code>MappingMongoConverter</code> as well as <code>com.mongodb.Mongo</code> and MongoTemplate by using either Java-based or XML-based metadata. The following example uses Spring&#8217;s Java-based configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 100. @Configuration class to configure MongoDB mapping support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
public class GeoSpatialAppConfig extends AbstractMongoConfiguration {

  @Bean
  public Mongo mongo() throws Exception {
    return new Mongo("localhost");
  }

  @Override
  public String getDatabaseName() {
    return "database";
  }

  @Override
  public String getMappingBasePackage() {
    return "com.bigbank.domain";
  }

  // the following are optional


  @Bean
  @Override
  public CustomConversions customConversions() throws Exception {
    List&lt;Converter&lt;?, ?&gt;&gt; converterList = new ArrayList&lt;Converter&lt;?, ?&gt;&gt;();
    converterList.add(new org.springframework.data.mongodb.test.PersonReadConverter());
    converterList.add(new org.springframework.data.mongodb.test.PersonWriteConverter());
    return new CustomConversions(converterList);
  }

  @Bean
  public LoggingEventListener&lt;MongoMappingEvent&gt; mappingEventsListener() {
    return new LoggingEventListener&lt;MongoMappingEvent&gt;();
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>AbstractMongoConfiguration</code> requires you to implement methods that define a <code>com.mongodb.Mongo</code> as well as provide a database name. <code>AbstractMongoConfiguration</code> also has a method named <code>getMappingBasePackage(…)</code> that you can override to tell the converter where to scan for classes annotated with the <code>@Document</code> annotation.</p>
</div>
<div class="paragraph">
<p>You can add additional converters to the converter by overriding the <code>customConversions</code> method. Also shown in the preceding example is a <code>LoggingEventListener</code>, which logs <code>MongoMappingEvent</code> instances that are posted onto Spring&#8217;s <code>ApplicationContextEvent</code> infrastructure.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>AbstractMongoConfiguration</code> creates a <code>MongoTemplate</code> instance and registers it with the container under the name <code>mongoTemplate</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring&#8217;s MongoDB namespace lets you enable mapping functionality in XML, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 101. XML schema to configure MongoDB mapping support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:context="http://www.springframework.org/schema/context"
  xmlns:mongo="http://www.springframework.org/schema/data/mongo"
  xsi:schemaLocation="http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd
    http://www.springframework.org/schema/data/mongo http://www.springframework.org/schema/data/mongo/spring-mongo-1.0.xsd
    http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;

  &lt;!-- Default bean name is 'mongo' --&gt;
  &lt;mongo:mongo host="localhost" port="27017"/&gt;

  &lt;mongo:db-factory dbname="database" mongo-ref="mongo"/&gt;

  &lt;!-- by default look for a Mongo object named 'mongo' - default name used for the converter is 'mappingConverter' --&gt;
  &lt;mongo:mapping-converter base-package="com.bigbank.domain"&gt;
    &lt;mongo:custom-converters&gt;
      &lt;mongo:converter ref="readConverter"/&gt;
      &lt;mongo:converter&gt;
        &lt;bean class="org.springframework.data.mongodb.test.PersonWriteConverter"/&gt;
      &lt;/mongo:converter&gt;
    &lt;/mongo:custom-converters&gt;
  &lt;/mongo:mapping-converter&gt;

  &lt;bean id="readConverter" class="org.springframework.data.mongodb.test.PersonReadConverter"/&gt;

  &lt;!-- set the mapping converter to be used by the MongoTemplate --&gt;
  &lt;bean id="mongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
    &lt;constructor-arg name="mongoDbFactory" ref="mongoDbFactory"/&gt;
    &lt;constructor-arg name="mongoConverter" ref="mappingConverter"/&gt;
  &lt;/bean&gt;

  &lt;bean class="org.springframework.data.mongodb.core.mapping.event.LoggingEventListener"/&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>base-package</code> property tells it where to scan for classes annotated with the <code>@org.springframework.data.mongodb.core.mapping.Document</code> annotation.</p>
</div>
</div>
<div class="sect2">
<h3 id="mapping-usage"><a class="anchor" href="#mapping-usage"></a>13.4. Metadata-based Mapping</h3>
<div class="paragraph">
<p>To take full advantage of the object mapping functionality inside the Spring Data MongoDB support, you should annotate your mapped objects with the <code>@Document</code> annotation. Although it is not necessary for the mapping framework to have this annotation (your POJOs are mapped correctly, even without any annotations), it lets the classpath scanner find and pre-process your domain objects to extract the necessary metadata. If you do not use this annotation, your application takes a slight performance hit the first time you store a domain object, because the mapping framework needs to build up its internal metadata model so that it knows about the properties of your domain object and how to persist them. The following example shows a domain object:</p>
</div>
<div class="exampleblock">
<div class="title">Example 102. Example domain object</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package com.mycompany.domain;

@Document
public class Person {

  @Id
  private ObjectId id;

  @Indexed
  private Integer ssn;

  private String firstName;

  @Indexed
  private String lastName;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <code>@Id</code> annotation tells the mapper which property you want to use for the MongoDB <code>_id</code> property, and the <code>@Indexed</code> annotation tells the mapping framework to call <code>createIndex(…)</code> on that property of your document, making searches faster.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Automatic index creation is only done for types annotated with <code>@Document</code>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="mapping-usage-annotations"><a class="anchor" href="#mapping-usage-annotations"></a>13.4.1. Mapping Annotation Overview</h4>
<div class="paragraph">
<p>The MappingMongoConverter can use metadata to drive the mapping of objects to documents. The following annotations are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Id</code>: Applied at the field level to mark the field used for identity purpose.</p>
</li>
<li>
<p><code>@Document</code>: Applied at the class level to indicate this class is a candidate for mapping to the database. You can specify the name of the collection where the database will be stored.</p>
</li>
<li>
<p><code>@DBRef</code>: Applied at the field to indicate it is to be stored using a com.mongodb.DBRef.</p>
</li>
<li>
<p><code>@Indexed</code>: Applied at the field level to describe how to index the field.</p>
</li>
<li>
<p><code>@CompoundIndex</code>: Applied at the type level to declare Compound Indexes</p>
</li>
<li>
<p><code>@GeoSpatialIndexed</code>: Applied at the field level to describe how to geoindex the field.</p>
</li>
<li>
<p><code>@TextIndexed</code>: Applied at the field level to mark the field to be included in the text index.</p>
</li>
<li>
<p><code>@Language</code>: Applied at the field level to set the language override property for text index.</p>
</li>
<li>
<p><code>@Transient</code>: By default all private fields are mapped to the document, this annotation excludes the field where it is applied from being stored in the database</p>
</li>
<li>
<p><code>@PersistenceConstructor</code>: Marks a given constructor - even a package protected one - to use when instantiating the object from the database. Constructor arguments are mapped by name to the key values in the retrieved DBObject.</p>
</li>
<li>
<p><code>@Value</code>: This annotation is part of the Spring Framework . Within the mapping framework it can be applied to constructor arguments. This lets you use a Spring Expression Language statement to transform a key&#8217;s value retrieved in the database before it is used to construct a domain object. In order to reference a property of a given document one has to use expressions like: <code>@Value("#root.myProperty")</code> where <code>root</code> refers to the root of the given document.</p>
</li>
<li>
<p><code>@Field</code>: Applied at the field level and described the name of the field as it will be represented in the MongoDB BSON document thus allowing the name to be different than the fieldname of the class.</p>
</li>
<li>
<p><code>@Version</code>: Applied at field level is used for optimistic locking and checked for modification on save operations. The initial value is <code>zero</code> which is bumped automatically on every update.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The mapping metadata infrastructure is defined in a separate spring-data-commons project that is technology agnostic. Specific subclasses are using in the MongoDB support to support annotation based metadata. Other strategies are also possible to put in place if there is demand.</p>
</div>
<div class="paragraph">
<p>Here is an example of a more complex mapping.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Document
@CompoundIndexes({
    @CompoundIndex(name = "age_idx", def = "{'lastName': 1, 'age': -1}")
})
public class Person&lt;T extends Address&gt; {

  @Id
  private String id;

  @Indexed(unique = true)
  private Integer ssn;

  @Field("fName")
  private String firstName;

  @Indexed
  private String lastName;

  private Integer age;

  @Transient
  private Integer accountTotal;

  @DBRef
  private List&lt;Account&gt; accounts;

  private T address;


  public Person(Integer ssn) {
    this.ssn = ssn;
  }

  @PersistenceConstructor
  public Person(Integer ssn, String firstName, String lastName, Integer age, T address) {
    this.ssn = ssn;
    this.firstName = firstName;
    this.lastName = lastName;
    this.age = age;
    this.address = address;
  }

  public String getId() {
    return id;
  }

  // no setter for Id.  (getter is only exposed for some unit testing)

  public Integer getSsn() {
    return ssn;
  }

// other getters/setters omitted</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-custom-object-construction"><a class="anchor" href="#mapping-custom-object-construction"></a>13.4.2. Customized Object Construction</h4>
<div class="paragraph">
<p>The mapping subsystem allows the customization of the object construction by annotating a constructor with the <code>@PersistenceConstructor</code> annotation. The values to be used for the constructor parameters are resolved in the following way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a parameter is annotated with the <code>@Value</code> annotation, the given expression is evaluated and the result is used as the parameter value.</p>
</li>
<li>
<p>If the Java type has a property whose name matches the given field of the input document, then it&#8217;s property information is used to select the appropriate constructor parameter to pass the input field value to. This works only if the parameter name information is present in the java <code>.class</code> files which can be achieved by compiling the source with debug information or using the new <code>-parameters</code> command-line switch for javac in Java 8.</p>
</li>
<li>
<p>Otherwise a <code>MappingException</code> will be thrown indicating that the given constructor parameter could not be bound.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class OrderItem {

  private @Id String id;
  private int quantity;
  private double unitPrice;

  OrderItem(String id, @Value("#root.qty ?: 0") int quantity, double unitPrice) {
    this.id = id;
    this.quantity = quantity;
    this.unitPrice = unitPrice;
  }

  // getters/setters ommitted
}

DBObject input = new BasicDBObject("id", "4711");
input.put("unitPrice", 2.5);
input.put("qty",5);
OrderItem item = converter.read(OrderItem.class, input);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The SpEL expression in the <code>@Value</code> annotation of the <code>quantity</code> parameter falls back to the value <code>0</code> if the given property path cannot be resolved.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Additional examples for using the <code>@PersistenceConstructor</code> annotation can be found in the <a href="https://github.com/spring-projects/spring-data-mongodb/blob/master/spring-data-mongodb/src/test/java/org/springframework/data/mongodb/core/convert/MappingMongoConverterUnitTests.java">MappingMongoConverterUnitTests</a> test suite.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-usage-indexes.compound-index"><a class="anchor" href="#mapping-usage-indexes.compound-index"></a>13.4.3. Compound Indexes</h4>
<div class="paragraph">
<p>Compound indexes are also supported. They are defined at the class level, rather than on individual properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Compound indexes are very important to improve the performance of queries that involve criteria on multiple fields
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s an example that creates a compound index of <code>lastName</code> in ascending order and <code>age</code> in descending order:</p>
</div>
<div class="exampleblock">
<div class="title">Example 103. Example Compound Index Usage</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package com.mycompany.domain;

@Document
@CompoundIndexes({
    @CompoundIndex(name = "age_idx", def = "{'lastName': 1, 'age': -1}")
})
public class Person {

  @Id
  private ObjectId id;
  private Integer age;
  private String firstName;
  private String lastName;

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-usage-indexes.text-index"><a class="anchor" href="#mapping-usage-indexes.text-index"></a>13.4.4. Text Indexes</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The text index feature is disabled by default for mongodb v.2.4.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Creating a text index allows accumulating several fields into a searchable full-text index. It is only possible to have one text index per collection, so all fields marked with <code>@TextIndexed</code> are combined into this index. Properties can be weighted to influence the document score for ranking results. The default language for the text index is English. To change the default language, set the <code>language</code> attribute to whichever language you want (for example,<code>@Document(language="spanish")</code>). Using a property called <code>language</code> or <code>@Language</code> lets you define a language override on a per document base. The following example shows how to created a text index and set the language to Spanish:</p>
</div>
<div class="exampleblock">
<div class="title">Example 104. Example Text Index Usage</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Document(language = "spanish")
class SomeEntity {

    @TextIndexed String foo;

    @Language String lang;

    Nested nested;
}

class Nested {

    @TextIndexed(weight=5) String bar;
    String roo;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-usage-references"><a class="anchor" href="#mapping-usage-references"></a>13.4.5. Using DBRefs</h4>
<div class="paragraph">
<p>The mapping framework does not have to store child objects embedded within the document. You can also store them separately and use a DBRef to refer to that document. When the object is loaded from MongoDB, those references are eagerly resolved so that you get back a mapped object that looks the same as if it had been stored embedded within your master document.</p>
</div>
<div class="paragraph">
<p>The following example uses a DBRef to refer to a specific document that exists independently of the object in which it is referenced (both classes are shown in-line for brevity&#8217;s sake):</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Document
public class Account {

  @Id
  private ObjectId id;
  private Float total;
}

@Document
public class Person {

  @Id
  private ObjectId id;
  @Indexed
  private Integer ssn;
  @DBRef
  private List&lt;Account&gt; accounts;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You need not use <code>@OneToMany</code> or similar mechanisms because the List of objects tells the mapping framework that you want a one-to-many relationship. When the object is stored in MongoDB, there is a list of DBRefs rather than the <code>Account</code> objects themselves.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The mapping framework does not handle cascading saves. If you change an <code>Account</code> object that is referenced by a <code>Person</code> object, you must save the <code>Account</code> object separately. Calling <code>save</code> on the <code>Person</code> object does not automatically save the <code>Account</code> objects in the <code>accounts</code> property.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-usage-events"><a class="anchor" href="#mapping-usage-events"></a>13.4.6. Mapping Framework Events</h4>
<div class="paragraph">
<p>Events are fired throughout the lifecycle of the mapping process. This is described in the <a href="#mongodb.mapping-usage.events">Lifecycle Events</a> section.</p>
</div>
<div class="paragraph">
<p>Declaring these beans in your Spring ApplicationContext causes them to be invoked whenever the event is dispatched.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-explicit-converters"><a class="anchor" href="#mapping-explicit-converters"></a>13.4.7. Overriding Mapping with Explicit Converters</h4>
<div class="paragraph">
<p>When storing and querying your objects it is convenient to have a <code>MongoConverter</code> instance handle the mapping of all Java types to DBObjects. However, sometimes you may want the <code>MongoConverter</code> s do most of the work but allow you to selectively handle the conversion for a particular type or to optimize performance.</p>
</div>
<div class="paragraph">
<p>To selectively handle the conversion yourself, register one or more one or more <code>org.springframework.core.convert.converter.Converter</code> instances with the <code>MongoConverter</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring 3.0 introduced a core.convert package that provides a general type conversion system. This is described in detail in the Spring reference documentation section entitled <a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/html/validation.html#core-convert">&#8220;Spring Type Conversion&#8221;</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can use the <code>customConversions</code> method in <code>AbstractMongoConfiguration</code> to configure converters. The examples <a href="#mapping-configuration">at the beginning of this chapter</a> show how to perform the configuration using Java and XML.</p>
</div>
<div class="paragraph">
<p>Below is an example of a Spring Converter implementation that converts from a DBObject to a Person POJO.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@ReadingConverter
 public class PersonReadConverter implements Converter&lt;DBObject, Person&gt; {

  public Person convert(DBObject source) {
    Person p = new Person((ObjectId) source.get("_id"), (String) source.get("name"));
    p.setAge((Integer) source.get("age"));
    return p;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example that converts from a Person to a DBObject.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@WritingConverter
public class PersonWriteConverter implements Converter&lt;Person, DBObject&gt; {

  public DBObject convert(Person source) {
    DBObject dbo = new BasicDBObject();
    dbo.put("_id", source.getId());
    dbo.put("name", source.getFirstName());
    dbo.put("age", source.getAge());
    return dbo;
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.cross.store"><a class="anchor" href="#mongo.cross.store"></a>14. Cross Store Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sometimes you need to store data in multiple data stores and these data stores can be of different types. One might be relational while the other a document store. For this use case we have created a separate module in the MongoDB support that handles what we call cross-store support. The current implementation is based on JPA as the driver for the relational database and we allow select fields in the Entities to be stored in a Mongo database. In addition to allowing you to store your data in two stores we also coordinate persistence operations for the non-transactional MongoDB store with the transaction life-cycle for the relational database.</p>
</div>
<div class="sect2">
<h3 id="mongodb_cross-store-configuration"><a class="anchor" href="#mongodb_cross-store-configuration"></a>14.1. Cross Store Configuration</h3>
<div class="paragraph">
<p>Assuming that you have a working JPA application and would like to add some cross-store persistence for MongoDB, what do you have to add to your configuration?</p>
</div>
<div class="paragraph">
<p>First, you need to add a dependency on the cross-store module. If you use Maven, you can add the following dependency to your pom:</p>
</div>
<div class="exampleblock">
<div class="title">Example 105. Example Maven pom.xml with <code>spring-data-mongodb-cross-store</code> dependency</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  ...

    &lt;!-- Spring Data --&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
      &lt;artifactId&gt;spring-data-mongodb-cross-store&lt;/artifactId&gt;
      &lt;version&gt;${spring.data.mongo.version}&lt;/version&gt;
    &lt;/dependency&gt;

  ...

&lt;/project&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once you have added the dependency, you need to enable AspectJ for the project. The cross-store support is implemented with AspectJ aspects so, if you enable compile-time AspectJ support, the cross-store features become available to your project. In Maven, you would add an additional plugin to the <code>&lt;build&gt;</code> section of the pom, as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 106. Example Maven pom.xml with AspectJ plugin enabled</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  ...

  &lt;build&gt;
    &lt;plugins&gt;

      …

      &lt;plugin&gt;
        &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
        &lt;artifactId&gt;aspectj-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;1.0&lt;/version&gt;
        &lt;dependencies&gt;
          &lt;!-- NB: You must use Maven 2.0.9 or above or these are ignored (see MNG-2972) --&gt;
          &lt;dependency&gt;
            &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
            &lt;artifactId&gt;aspectjrt&lt;/artifactId&gt;
            &lt;version&gt;${aspectj.version}&lt;/version&gt;
          &lt;/dependency&gt;
          &lt;dependency&gt;
            &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
            &lt;artifactId&gt;aspectjtools&lt;/artifactId&gt;
            &lt;version&gt;${aspectj.version}&lt;/version&gt;
          &lt;/dependency&gt;
        &lt;/dependencies&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;goals&gt;
              &lt;goal&gt;compile&lt;/goal&gt;
              &lt;goal&gt;test-compile&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
        &lt;configuration&gt;
          &lt;outxml&gt;true&lt;/outxml&gt;
          &lt;aspectLibraries&gt;
            &lt;aspectLibrary&gt;
              &lt;groupId&gt;org.springframework&lt;/groupId&gt;
              &lt;artifactId&gt;spring-aspects&lt;/artifactId&gt;
            &lt;/aspectLibrary&gt;
            &lt;aspectLibrary&gt;
              &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
              &lt;artifactId&gt;spring-data-mongodb-cross-store&lt;/artifactId&gt;
            &lt;/aspectLibrary&gt;
          &lt;/aspectLibraries&gt;
          &lt;source&gt;1.6&lt;/source&gt;
          &lt;target&gt;1.6&lt;/target&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;

      ...

    &lt;/plugins&gt;
  &lt;/build&gt;

...

&lt;/project&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Finally, you need to configure your project to use MongoDB and also configure which aspects are used. You should add the following XML snippet to your application context:</p>
</div>
<div class="exampleblock">
<div class="title">Example 107. Example application context with MongoDB and cross-store aspect support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:jdbc="http://www.springframework.org/schema/jdbc"
  xmlns:jpa="http://www.springframework.org/schema/data/jpa"
  xmlns:mongo="http://www.springframework.org/schema/data/mongo"
  xsi:schemaLocation="http://www.springframework.org/schema/data/mongo
    http://www.springframework.org/schema/data/mongo/spring-mongo.xsd
    http://www.springframework.org/schema/jdbc
    http://www.springframework.org/schema/jdbc/spring-jdbc-3.0.xsd
    http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
    http://www.springframework.org/schema/data/jpa
    http://www.springframework.org/schema/data/jpa/spring-jpa-1.0.xsd"&gt;

  ...

  &lt;!--  Mongo config --&gt;
  &lt;mongo:mongo host="localhost" port="27017"/&gt;

  &lt;bean id="mongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
    &lt;constructor-arg name="mongo" ref="mongo"/&gt;
    &lt;constructor-arg name="databaseName" value="test"/&gt;
    &lt;constructor-arg name="defaultCollectionName" value="cross-store"/&gt;
  &lt;/bean&gt;

  &lt;bean class="org.springframework.data.mongodb.core.MongoExceptionTranslator"/&gt;

  &lt;!--  Mongo cross-store aspect config --&gt;
  &lt;bean class="org.springframework.data.persistence.document.mongo.MongoDocumentBacking"
        factory-method="aspectOf"&gt;
    &lt;property name="changeSetPersister" ref="mongoChangeSetPersister"/&gt;
  &lt;/bean&gt;
  &lt;bean id="mongoChangeSetPersister"
      class="org.springframework.data.persistence.document.mongo.MongoChangeSetPersister"&gt;
    &lt;property name="mongoTemplate" ref="mongoTemplate"/&gt;
    &lt;property name="entityManagerFactory" ref="entityManagerFactory"/&gt;
  &lt;/bean&gt;

  ...

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongodb_cross-store-application"><a class="anchor" href="#mongodb_cross-store-application"></a>14.2. Writing the Cross Store Application</h3>
<div class="paragraph">
<p>We assume that you have a working JPA application, so we cover only the additional steps needed to persist part of your entity in your Mongo database. To do so, you need to identify the field you want to persist. It should be a domain class and follow the general rules for the Mongo mapping support covered in previous chapters. The field you want to persist in MongoDB should be annotated with the <code>@RelatedDocument</code> annotation. That is really all you need to do. The cross-store aspects take care of the rest, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Marking the field with <code>@Transient</code> so that it will not be persisted by JPA</p>
</li>
<li>
<p>Keeping track of any changes made to the field value and writing them to the database on successful transaction completion</p>
</li>
<li>
<p>Loading the document from MongoDB the first time the value is used in your application.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example shows an entity that has a field annotated with <code>@RelatedDocument</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 108. Example of Entity with @RelatedDocument</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Entity
public class Customer {

  @Id
  @GeneratedValue(strategy = GenerationType.IDENTITY)
  private Long id;

  private String firstName;

  private String lastName;

  @RelatedDocument
  private SurveyInfo surveyInfo;

  // getters and setters omitted
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows a domain class that is to be stored as a <code>Document</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 109. Example of a domain class to be stored as a Document</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class SurveyInfo {

  private Map&lt;String, String&gt; questionsAndAnswers;

  public SurveyInfo() {
    this.questionsAndAnswers = new HashMap&lt;String, String&gt;();
  }

  public SurveyInfo(Map&lt;String, String&gt; questionsAndAnswers) {
    this.questionsAndAnswers = questionsAndAnswers;
  }

  public Map&lt;String, String&gt; getQuestionsAndAnswers() {
    return questionsAndAnswers;
  }

  public void setQuestionsAndAnswers(Map&lt;String, String&gt; questionsAndAnswers) {
    this.questionsAndAnswers = questionsAndAnswers;
  }

  public SurveyInfo addQuestionAndAnswer(String question, String answer) {
    this.questionsAndAnswers.put(question, answer);
    return this;
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, once the <code>SurveyInfo</code> has been set on the <code>Customer</code> object, the <code>MongoTemplate</code> that was configured previously is used to save the <code>SurveyInfo</code> (along with some metadata about the JPA Entity) in a MongoDB collection named after the fully qualified name of the JPA Entity class. The following code shows how to configure a JPA entity for cross-store persistence with MongoDB:</p>
</div>
<div class="exampleblock">
<div class="title">Example 110. Example of code using the JPA Entity configured for cross-store persistence</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Customer customer = new Customer();
customer.setFirstName("Sven");
customer.setLastName("Olafsen");
SurveyInfo surveyInfo = new SurveyInfo()
  .addQuestionAndAnswer("age", "22")
  .addQuestionAndAnswer("married", "Yes")
  .addQuestionAndAnswer("citizenship", "Norwegian");
customer.setSurveyInfo(surveyInfo);
customerRepository.save(customer);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Running the preceding above results in the following JSON document being stored in MongoDB:</p>
</div>
<div class="exampleblock">
<div class="title">Example 111. Example of JSON document stored in MongoDB</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{ "_id" : ObjectId( "4d9e8b6e3c55287f87d4b79e" ),
  "_entity_id" : 1,
  "_entity_class" : "org.springframework.data.mongodb.examples.custsvc.domain.Customer",
  "_entity_field_name" : "surveyInfo",
  "questionsAndAnswers" : { "married" : "Yes",
    "age" : "22",
    "citizenship" : "Norwegian" },
  "_entity_field_class" : "org.springframework.data.mongodb.examples.custsvc.domain.SurveyInfo" }</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.logging"><a class="anchor" href="#mongo.logging"></a>15. Logging support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An appender for Log4j is provided in the maven module "spring-data-mongodb-log4j". Note, there is no dependency on other Spring Mongo modules, only the MongoDB driver.</p>
</div>
<div class="sect2">
<h3 id="mongodb:logging-configuration"><a class="anchor" href="#mongodb:logging-configuration"></a>15.1. MongoDB Log4j Configuration</h3>
<div class="paragraph">
<p>Here is an example configuration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>log4j.rootCategory=INFO, mongo

log4j.appender.mongo=org.springframework.data.document.mongodb.log4j.MongoLog4jAppender
log4j.appender.mongo.layout=org.apache.log4j.PatternLayout
log4j.appender.mongo.layout.ConversionPattern=%d %p [%c] - &lt;%m&gt;%n
log4j.appender.mongo.host = localhost
log4j.appender.mongo.port = 27017
log4j.appender.mongo.database = logs
log4j.appender.mongo.collectionPattern = %X{year}%X{month}
log4j.appender.mongo.applicationId = my.application
log4j.appender.mongo.warnOrHigherWriteConcern = FSYNC_SAFE

log4j.category.org.apache.activemq=ERROR
log4j.category.org.springframework.batch=DEBUG
log4j.category.org.springframework.data.document.mongodb=DEBUG
log4j.category.org.springframework.transaction=INFO</code></pre>
</div>
</div>
<div class="paragraph">
<p>The important configuration to look at aside from host and port is the database and <code>collectionPattern</code>. The variables <code>year</code>, <code>month</code>, <code>day</code> and <code>hour</code> are available for you to use in forming a collection name. This is to support the common convention of grouping log information in a collection that corresponds to a specific time period, for example a collection per day.</p>
</div>
<div class="paragraph">
<p>There is also an <code>applicationId</code> which is put into the stored message. The document stored from logging as the following keys: <code>level</code>, <code>name</code>, <code>applicationId</code>, <code>timestamp</code>, <code>properties</code>, <code>traceback</code>, and <code>message</code>.</p>
</div>
<div class="sect3">
<h4 id="mongodb:logging-configuration:authentication"><a class="anchor" href="#mongodb:logging-configuration:authentication"></a>15.1.1. Using authentication</h4>
<div class="paragraph">
<p>The MongoDB Log4j appender can be configured to use username/password authentication.
Authentication is performed using the specified database. A different <code>authenticationDatabase</code> can be specified to override the default behavior.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code># ...
log4j.appender.mongo.username = admin
log4j.appender.mongo.password = test
log4j.appender.mongo.authenticationDatabase = logs
# ...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Authentication failures lead to exceptions during logging and are propagated to the caller of the logging method.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.jmx"><a class="anchor" href="#mongo.jmx"></a>16. JMX support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The JMX support for MongoDB exposes the results of executing the 'serverStatus' command on the admin database for a single MongoDB server instance. It also exposes an administrative MBean, <code>MongoAdmin</code>, that lets you perform administrative operations, such as dropping or creating a database. The JMX features build upon the JMX feature set available in the Spring Framework. See <a href="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/html/jmx.html">here</a> for more details.</p>
</div>
<div class="sect2">
<h3 id="mongodb:jmx-configuration"><a class="anchor" href="#mongodb:jmx-configuration"></a>16.1. MongoDB JMX Configuration</h3>
<div class="paragraph">
<p>Spring&#8217;s Mongo namespace lets you enable JMX functionality, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 112. XML schema to configure MongoDB</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:context="http://www.springframework.org/schema/context"
  xmlns:mongo="http://www.springframework.org/schema/data/mongo"
  xsi:schemaLocation="
    http://www.springframework.org/schema/context
    http://www.springframework.org/schema/context/spring-context-3.0.xsd
    http://www.springframework.org/schema/data/mongo
    http://www.springframework.org/schema/data/mongo/spring-mongo-1.0.xsd
    http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;

    &lt;!-- Default bean name is 'mongo' --&gt;
    &lt;mongo:mongo host="localhost" port="27017"/&gt;

    &lt;!-- by default look for a Mongo object named 'mongo' --&gt;
    &lt;mongo:jmx/&gt;

    &lt;context:mbean-export/&gt;

    &lt;!-- To translate any MongoExceptions thrown in @Repository annotated classes --&gt;
    &lt;context:annotation-config/&gt;

    &lt;bean id="registry" class="org.springframework.remoting.rmi.RmiRegistryFactoryBean" p:port="1099" /&gt;

    &lt;!-- Expose JMX over RMI --&gt;
    &lt;bean id="serverConnector" class="org.springframework.jmx.support.ConnectorServerFactoryBean"
        depends-on="registry"
        p:objectName="connector:name=rmi"
        p:serviceUrl="service:jmx:rmi://localhost/jndi/rmi://localhost:1099/myconnector" /&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding code exposes several MBeans:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AssertMetrics</code></p>
</li>
<li>
<p><code>BackgroundFlushingMetrics</code></p>
</li>
<li>
<p><code>BtreeIndexCounters</code></p>
</li>
<li>
<p><code>ConnectionMetrics</code></p>
</li>
<li>
<p><code>GlobalLockMetrics</code></p>
</li>
<li>
<p><code>MemoryMetrics</code></p>
</li>
<li>
<p><code>OperationCounters</code></p>
</li>
<li>
<p><code>ServerInfo</code></p>
</li>
<li>
<p><code>MongoAdmin</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following screenshot from JConsole shows the resulting configuration:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jconsole.png" alt="jconsole">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.mongo-3"><a class="anchor" href="#mongo.mongo-3"></a>17. MongoDB 3.0 Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Data MongoDB requires MongoDB Java driver generations 3 when connecting to a MongoDB 2.6/3.0 server running MMap.v1 or a MongoDB server 3.0 using MMap.v1 or the WiredTiger storage engine.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
See the driver- and database-specific documentation for major differences between those engines.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Operations that are no longer valid when using a 3.x MongoDB Java driver have been deprecated within Spring Data and will be removed in a subsequent release.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_using_spring_data_mongodb_with_mongodb_3_0"><a class="anchor" href="#_using_spring_data_mongodb_with_mongodb_3_0"></a>17.1. Using Spring Data MongoDB with MongoDB 3.0</h3>
<div class="paragraph">
<p>The rest of this section describes how to use Spring Data MongoDB with MongoDB 3.0.</p>
</div>
<div class="sect3">
<h4 id="mongo.mongo-3.configuration"><a class="anchor" href="#mongo.mongo-3.configuration"></a>17.1.1. Configuration Options</h4>
<div class="paragraph">
<p>Some of the configuration options have been changed or removed for the <code>mongo-java-driver</code>. The following options are ignored when using the generation 3 driver:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>autoConnectRetry</code></p>
</li>
<li>
<p><code>maxAutoConnectRetryTime</code></p>
</li>
<li>
<p><code>slaveOk</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Generally, you should use the <code>&lt;mongo:mongo-client &#8230;&#8203; /&gt;</code> and <code>&lt;mongo:client-options &#8230;&#8203; /&gt;</code> elements instead of <code>&lt;mongo:mongo &#8230;&#8203; /&gt;</code> when doing XML based configuration, since those elements provide you with attributes that are only valid for the third generation Java driver. The follwoing example shows how to configure a Mongo client connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:mongo="http://www.springframework.org/schema/data/mongo"
	xsi:schemaLocation="http://www.springframework.org/schema/data/mongo http://www.springframework.org/schema/data/mongo/spring-mongo.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;

  &lt;mongo:mongo-client host="127.0.0.1" port="27017"&gt;
    &lt;mongo:client-options write-concern="NORMAL" /&gt;
  &lt;/mongo:mongo-client&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.mongo-3.write-concern"><a class="anchor" href="#mongo.mongo-3.write-concern"></a>17.1.2. <code>WriteConcern</code> and <code>WriteConcernChecking</code></h4>
<div class="paragraph">
<p><code>WriteConcern.NONE</code>, which had been used as the default by Spring Data MongoDB, was removed in 3.0. Therefore, in a MongoDB 3 environment, the <code>WriteConcern</code> defaults to <code>WriteConcern.UNACKNOWLEGED</code>. If <code>WriteResultChecking.EXCEPTION</code> is enabled, the <code>WriteConcern</code> is altered to <code>WriteConcern.ACKNOWLEDGED</code> for write operations. Otherwise, errors during execution would not be thrown correctly, since they are not raised by the driver.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.mongo-3.authentication"><a class="anchor" href="#mongo.mongo-3.authentication"></a>17.1.3. Authentication</h4>
<div class="paragraph">
<p>MongoDB Server generation 3 changed the authentication model when connecting to the DB. Therefore, some of the configuration options available for authentication are no longer valid. You should use the <code>MongoClient</code>-specific options when setting credentials with <code>MongoCredential</code> to provide authentication data, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
public class ApplicationContextEventTestsAppConfig extends AbstractMongoConfiguration {

  @Override
  public String getDatabaseName() {
    return "database";
  }

  @Override
  @Bean
  public Mongo mongo() throws Exception {
    return new MongoClient(singletonList(new ServerAddress("127.0.0.1", 27017)),
      singletonList(MongoCredential.createCredential("name", "db", "pwd".toCharArray())));
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to use authentication with XML configuration, you can use the <code>credentials</code> attribute on <code>&lt;mongo-client&gt;</code>, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:mongo="http://www.springframework.org/schema/data/mongo"
	xsi:schemaLocation="http://www.springframework.org/schema/data/mongo http://www.springframework.org/schema/data/mongo/spring-mongo.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;

  &lt;mongo:mongo-client credentials="user:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3444554747435b4650745055405556554751">[email&#160;protected]</a>" /&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.mongo-3.misc"><a class="anchor" href="#mongo.mongo-3.misc"></a>17.1.4. Miscellaneous Details</h4>
<div class="paragraph">
<p>This section covers briefly lists additional things to keep in mind when using the 3.0 driver:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>IndexOperations.resetIndexCache()</code> is no longer supported.</p>
</li>
<li>
<p>Any <code>MapReduceOptions.extraOption</code> is silently ignored.</p>
</li>
<li>
<p><code>WriteResult</code> no longer holds error information but, instead, throws an <code>Exception</code>.</p>
</li>
<li>
<p><code>MongoOperations.executeInSession(…)</code> no longer calls <code>requestStart</code> and <code>requestDone</code>.</p>
</li>
<li>
<p>Index name generation has become a driver-internal operation. Spring Data MongoDB still uses the 2.x schema to generate names.</p>
</li>
<li>
<p>Some <code>Exception</code> messages differ between the generation 2 and 3 servers as well as between the MMap.v1 and WiredTiger storage engines.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<h1 id="appendix" class="sect0"><a class="anchor" href="#appendix"></a>Appendix</h1>
<div class="sect1">
<h2 id="repositories.namespace-reference"><a class="anchor" href="#repositories.namespace-reference"></a>Appendix A: Namespace reference</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="populator.namespace-dao-config"><a class="anchor" href="#populator.namespace-dao-config"></a>The <code>&lt;repositories /&gt;</code> Element</h3>
<div class="paragraph">
<p>The <code>&lt;repositories /&gt;</code> element triggers the setup of the Spring Data repository infrastructure. The most important attribute is <code>base-package</code>, which defines the package to scan for Spring Data repository interfaces. See &#8220;<a href="#repositories.create-instances.spring">XML configuration</a>&#8221;. The following table describes the attributes of the <code>&lt;repositories /&gt;</code> element:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 9. Attributes</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>base-package</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the package to be scanned for repository interfaces that extend <code>*Repository</code> (the actual interface is determined by the specific Spring Data module) in auto-detection mode. All packages below the configured package are scanned, too. Wildcards are allowed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>repository-impl-postfix</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the postfix to autodetect custom repository implementations. Classes whose names end with the configured postfix are considered as candidates. Defaults to <code>Impl</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>query-lookup-strategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Determines the strategy to be used to create finder queries. See &#8220;<a href="#repositories.query-methods.query-lookup-strategies">Query Lookup Strategies</a>&#8221; for details. Defaults to <code>create-if-not-found</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>named-queries-location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the location to search for a Properties file containing externally defined queries.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>consider-nested-repositories</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether nested repository interface definitions should be considered. Defaults to <code>false</code>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="populator.namespace-reference"><a class="anchor" href="#populator.namespace-reference"></a>Appendix B: Populators namespace reference</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="namespace-dao-config"><a class="anchor" href="#namespace-dao-config"></a>The &lt;populator /&gt; element</h3>
<div class="paragraph">
<p>The <code>&lt;populator /&gt;</code> element allows to populate the a data store via the Spring Data repository infrastructure.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</sup></p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 10. Attributes</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>locations</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Where to find the files to read the objects from the repository shall be populated with.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="repository-query-keywords"><a class="anchor" href="#repository-query-keywords"></a>Appendix C: Repository query keywords</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_supported_query_keywords"><a class="anchor" href="#_supported_query_keywords"></a>Supported query keywords</h3>
<div class="paragraph">
<p>The following table lists the keywords generally supported by the Spring Data repository query derivation mechanism. However, consult the store-specific documentation for the exact list of supported keywords, because some keywords listed here might not be supported in a particular store.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 11. Query keywords</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Logical keyword</th>
<th class="tableblock halign-left valign-top">Keyword expressions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AND</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>And</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Or</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AFTER</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>After</code>, <code>IsAfter</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BEFORE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Before</code>, <code>IsBefore</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CONTAINING</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Containing</code>, <code>IsContaining</code>, <code>Contains</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BETWEEN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Between</code>, <code>IsBetween</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ENDING_WITH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EndingWith</code>, <code>IsEndingWith</code>, <code>EndsWith</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EXISTS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Exists</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FALSE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>False</code>, <code>IsFalse</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GREATER_THAN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GreaterThan</code>, <code>IsGreaterThan</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GREATER_THAN_EQUALS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GreaterThanEqual</code>, <code>IsGreaterThanEqual</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>In</code>, <code>IsIn</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Is</code>, <code>Equals</code>, (or no keyword)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS_NOT_NULL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotNull</code>, <code>IsNotNull</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS_NULL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Null</code>, <code>IsNull</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LESS_THAN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LessThan</code>, <code>IsLessThan</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LESS_THAN_EQUAL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LessThanEqual</code>, <code>IsLessThanEqual</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LIKE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Like</code>, <code>IsLike</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NEAR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Near</code>, <code>IsNear</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NOT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Not</code>, <code>IsNot</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NOT_IN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotIn</code>, <code>IsNotIn</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NOT_LIKE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotLike</code>, <code>IsNotLike</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REGEX</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Regex</code>, <code>MatchesRegex</code>, <code>Matches</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>STARTING_WITH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StartingWith</code>, <code>IsStartingWith</code>, <code>StartsWith</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TRUE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>True</code>, <code>IsTrue</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>WITHIN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Within</code>, <code>IsWithin</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="repository-query-return-types"><a class="anchor" href="#repository-query-return-types"></a>Appendix D: Repository query return types</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_supported_query_return_types"><a class="anchor" href="#_supported_query_return_types"></a>Supported Query Return Types</h3>
<div class="paragraph">
<p>The following table lists the return types generally supported by Spring Data repositories. However, consult the store-specific documentation for the exact list of supported return types, because some types listed here might not be supported in a particular store.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Geospatial types (such as <code>GeoResult</code>, <code>GeoResults</code>, and <code>GeoPage</code>) are available only for data stores that support geospatial queries.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 12. Query return types</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Return type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>void</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Denotes no return value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Primitives</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java primitives.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Wrapper types</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java wrapper types.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>T</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An unique entity. Expects the query method to return one result at most. If no result is found, <code>null</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Iterator&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An <code>Iterator</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Collection&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>Collection</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>List&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>List</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Optional&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Java 8 or Guava <code>Optional</code>. Expects the query method to return one result at most. If no result is found, <code>Optional.empty()</code> or <code>Optional.absent()</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Option&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either a Scala or Javaslang <code>Option</code> type. Semantically the same behavior as Java 8&#8217;s <code>Optional</code>, described earlier.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Stream&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Java 8 <code>Stream</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Future&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>Future</code>. Expects a method to be annotated with <code>@Async</code> and requires Spring&#8217;s asynchronous method execution capability to be enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CompletableFuture&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Java 8 <code>CompletableFuture</code>. Expects a method to be annotated with <code>@Async</code> and requires Spring&#8217;s asynchronous method execution capability to be enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ListenableFuture</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>org.springframework.util.concurrent.ListenableFuture</code>. Expects a method to be annotated with <code>@Async</code> and requires Spring&#8217;s asynchronous method execution capability to be enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Slice</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A sized chunk of data with an indication of whether there is more data available. Requires a <code>Pageable</code> method parameter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Page&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>Slice</code> with additional information, such as the total number of results. Requires a <code>Pageable</code> method parameter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoResult&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A result entry with additional information, such as the distance to a reference location.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoResults&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of <code>GeoResult&lt;T&gt;</code> with additional information, such as the average distance to a reference location.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoPage&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>Page</code> with <code>GeoResult&lt;T&gt;</code>, such as the average distance to a reference location.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Mono&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Project Reactor <code>Mono</code> emitting zero or one element using reactive repositories. Expects the query method to return one result at most. If no result is found, <code>Mono.empty()</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Flux&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Project Reactor <code>Flux</code> emitting zero, one, or many elements using reactive repositories. Queries returning <code>Flux</code> can emit also an infinite number of elements.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Single&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A RxJava <code>Single</code> emitting a single element using reactive repositories. Expects the query method to return one result at most. If no result is found, <code>Mono.empty()</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Maybe&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A RxJava <code>Maybe</code> emitting zero or one element using reactive repositories. Expects the query method to return one result at most. If no result is found, <code>Mono.empty()</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Flowable&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A RxJava <code>Flowable</code> emitting zero, one, or many elements using reactive repositories. Queries returning <code>Flowable</code> can emit also an infinite number of elements.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. Kristina Chodorow. <em>MongoDB - The Definitive Guide</em>. O&#8217;Reilly Media, 2013
</div>
<div class="footnote" id="_footnote_2">
<a href="#_footnoteref_2">2</a>. see <a href="#repositories.create-instances.spring">XML configuration</a>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.10.18.RELEASE<br>
Last updated 2019-01-10 09:51:12 MEZ
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
<script>prettyPrint()</script>
<script>if(window.parent==window){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-2728886-23','auto',{'siteSpeedSampleRate':100});ga('send','pageview');}</script></body>
</html>